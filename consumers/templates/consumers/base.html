{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Waterworks{% endblock %}</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
                        success: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d' },
                        danger: { 50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d' },
                        warning: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f' },
                        info: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' },
                        dark: { 50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827' },
                        light: { 50: '#fafafa', 100: '#f5f5f5', 200: '#e5e5e5', 300: '#d4d4d4', 400: '#a3a3a3', 500: '#737373', 600: '#525252', 700: '#404040', 800: '#262626', 900: '#171717' }
                    }
                }
            }
        }
    </script>
    <!-- Bootstrap Icons (keeping for icon compatibility) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SweetAlert2 for Beautiful Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ============================================
           DESIGN UNIFORMITY SYSTEM
           Standard Components for Balilihan Waterworks
           ============================================ */

        /* === BUTTON COMPONENTS === */
        /* Primary Button - Main actions (Generate, Save, Submit) */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 500;
            font-size: 1rem; /* text-base (16px) */
            padding: 0.625rem 1rem; /* py-2.5 px-4 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.15s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }

        /* Secondary Button - Cancel, Back actions */
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #f5f5f5; /* light-100 */
            color: #374151; /* dark-700 */
            font-weight: 500;
            font-size: 1rem; /* text-base (16px) */
            padding: 0.625rem 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #d4d4d4; /* light-300 */
            transition: all 0.15s ease;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #e5e5e5; /* light-200 */
        }

        /* Success Button - Confirm, Approve actions */
        .btn-success {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #16a34a; /* success-600 */
            color: white;
            font-weight: 500;
            font-size: 1rem; /* text-base (16px) */
            padding: 0.625rem 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.15s ease;
            border: none;
            cursor: pointer;
        }
        .btn-success:hover {
            background-color: #15803d; /* success-700 */
        }

        /* Danger Button - Delete, Disconnect actions */
        .btn-danger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #dc2626; /* danger-600 */
            color: white;
            font-weight: 500;
            font-size: 1rem; /* text-base (16px) */
            padding: 0.625rem 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.15s ease;
            border: none;
            cursor: pointer;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* danger-700 */
        }

        /* Small Button Variant */
        .btn-sm {
            font-size: 0.875rem; /* text-sm */
            padding: 0.375rem 0.75rem; /* py-1.5 px-3 */
        }

        /* Large Button Variant */
        .btn-lg {
            font-size: 1.125rem; /* text-lg */
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
        }

        /* === CARD COMPONENTS === */
        /* Standard Card - Use for all content containers */
        .card {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }

        .card-body {
            padding: 1.5rem; /* p-6 */
        }

        .card-header {
            padding: 1rem 1.5rem; /* py-4 px-6 */
            border-bottom: 1px solid #e5e5e5; /* light-200 */
            font-weight: 600;
            font-size: 1.125rem; /* text-lg */
            color: #1f2937; /* dark-800 */
        }

        /* === LAYOUT CONSTANTS === */
        :root {
            --sidebar-width: 220px;
            --header-height: 50px;
        }

        /* === FORM INPUT STYLES === */
        .form-input {
            width: 100%;
            padding: 0.625rem 0.75rem; /* py-2.5 px-3 */
            font-size: 1rem; /* text-base (16px) */
            border: 1px solid #d4d4d4; /* light-300 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.15s ease;
            background-color: white;
        }
        .form-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        .form-label {
            display: block;
            font-size: 1rem; /* text-base (16px) */
            font-weight: 500;
            color: #374151; /* dark-700 */
            margin-bottom: 0.375rem;
        }

        /* === STATUS BADGES === */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            border-radius: 9999px; /* rounded-full */
        }
        .badge-success { background-color: #dcfce7; color: #166534; } /* success-100, success-800 */
        .badge-danger { background-color: #fee2e2; color: #991b1b; } /* danger-100, danger-800 */
        .badge-warning { background-color: #fef3c7; color: #92400e; } /* warning-100, warning-800 */
        .badge-info { background-color: #e0f2fe; color: #075985; } /* info-100, info-800 */
        .badge-primary { background-color: #e0e7ff; color: #3730a3; } /* indigo-100, indigo-800 */

        /* === TABLE STYLES === */
        .table-container {
            overflow-x: auto;
            border-radius: 0.75rem; /* rounded-xl */
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        .table-header {
            background-color: #f9fafb; /* dark-50 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            text-transform: uppercase;
            color: #6b7280; /* dark-500 */
        }
        .table-row {
            border-bottom: 1px solid #e5e5e5; /* light-200 */
        }
        .table-row:hover {
            background-color: #f9fafb; /* dark-50 */
        }
        .table-cell {
            padding: 0.75rem 1rem; /* py-3 px-4 */
            font-size: 1rem; /* text-base (16px) */
        }

        /* === TYPOGRAPHY HIERARCHY === */
        .page-title {
            font-size: 1.5rem; /* text-2xl (24px) */
            font-weight: 700;
            color: #111827; /* dark-900 */
        }
        .section-title {
            font-size: 1.25rem; /* text-xl (20px) */
            font-weight: 600;
            color: #1f2937; /* dark-800 */
        }
        .text-muted {
            font-size: 1rem; /* text-base (16px) */
            color: #6b7280; /* dark-500 */
        }
        .text-caption {
            font-size: 0.875rem; /* text-sm (14px) */
            color: #9ca3af; /* dark-400 */
        }

        /* === STAT CARD === */
        .stat-card {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loadingOverlay.active {
            display: flex;
        }

        /* Dropdown Animation */
        .dropdown-menu {
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dropdown Styles */
        .dropdown {
            position: relative;
        }

        .dropdown-toggle::after {
            display: none;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            min-width: 220px;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
            text-decoration: none;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
            color: #dc2626;
        }

        .dropdown-divider {
            height: 0;
            margin: 0.5rem 0;
            overflow: hidden;
            border-top: 1px solid #e5e7eb;
        }

        /* === NOTIFICATION SYSTEM === */
        .notification-dropdown {
            min-width: 360px;
            max-height: 400px;
            overflow: hidden;
        }
        .notification-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-body {
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.15s;
        }
        .notification-item:hover {
            background-color: #f9fafb;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item.unread {
            background-color: #eef2ff;
        }
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 0.65rem;
            font-weight: 700;
            color: white;
            background-color: #dc2626;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-icon-wrapper {
            position: relative;
            display: inline-flex;
        }
        .notification-empty {
            padding: 2rem 1rem;
            text-align: center;
            color: #9ca3af;
        }

        /* === HEADER TOAST NOTIFICATIONS === */
        .header-toast-container {
            position: fixed;
            top: calc(var(--header-height) + 10px);
            right: 20px;
            z-index: 1050;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        .header-toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out;
            min-width: 300px;
        }
        .header-toast.success {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-left: 4px solid #10b981;
        }
        .header-toast.error {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border-left: 4px solid #ef4444;
        }
        .header-toast.warning {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-left: 4px solid #f59e0b;
        }
        .header-toast.info {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-left: 4px solid #3b82f6;
        }
        .header-toast-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .header-toast.success .header-toast-icon { color: #10b981; }
        .header-toast.error .header-toast-icon { color: #ef4444; }
        .header-toast.warning .header-toast-icon { color: #f59e0b; }
        .header-toast.info .header-toast-icon { color: #3b82f6; }
        .header-toast-content {
            flex: 1;
        }
        .header-toast-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 2px;
        }
        .header-toast.success .header-toast-title { color: #065f46; }
        .header-toast.error .header-toast-title { color: #991b1b; }
        .header-toast.warning .header-toast-title { color: #92400e; }
        .header-toast.info .header-toast-title { color: #1e40af; }
        .header-toast-message {
            font-size: 0.8125rem;
            color: #4b5563;
        }
        .header-toast-close {
            flex-shrink: 0;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #9ca3af;
            transition: color 0.15s;
        }
        .header-toast-close:hover {
            color: #4b5563;
        }
        .header-toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            border-radius: 0 0 0 10px;
            animation: progressShrink linear forwards;
        }
        .header-toast.success .header-toast-progress { background: #10b981; }
        .header-toast.error .header-toast-progress { background: #ef4444; }
        .header-toast.warning .header-toast-progress { background: #f59e0b; }
        .header-toast.info .header-toast-progress { background: #3b82f6; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes progressShrink {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Print Styles */
        @media print {
            .sidebar,
            #sidebar,
            .header-bar {
                display: none !important;
            }

            .main-content,
            #main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }

            body {
                margin: 0 !important;
                padding: 0 !important;
            }
        }
    </style>
</head>
<body class="bg-light-100" id="main-body">

    <!-- Header Bar -->
    <div class="header-bar bg-white fixed top-0 left-0 right-0 flex items-center justify-between px-3 shadow-sm border-b border-light-300" style="height: var(--header-height); z-index: 1030;">
        <div class="flex items-center gap-2">
            <img src="{% static 'consumers/images/logo.png' %}" alt="Logo" class="rounded-full border-2 border-primary-500" style="width: 32px; height: 32px;">
            <h1 class="mb-0 font-bold text-dark-900 text-base">Balilihan Waterworks</h1>
        </div>

        <div class="flex items-center gap-4">
            <!-- Notification Bell -->
            <div class="dropdown">
                <button class="dropdown-toggle notification-icon-wrapper p-2 rounded-lg hover:bg-light-100 transition-colors border-0 bg-transparent cursor-pointer"
                        type="button"
                        id="notificationDropdown"
                        onclick="toggleDropdown('notificationDropdown', event)">
                    <i class="bi bi-bell text-xl text-dark-600"></i>
                    {% if unread_notifications_count > 0 %}
                    <span class="notification-badge" id="notificationBadge">{{ unread_notifications_count }}</span>
                    {% endif %}
                </button>
                <div class="dropdown-menu notification-dropdown" id="notificationDropdown-menu">
                    <div class="notification-header">
                        <span class="font-semibold text-dark-900">Notifications</span>
                        {% if unread_notifications_count > 0 %}
                        <button onclick="markAllAsRead()" class="text-xs text-primary-600 hover:text-primary-700 font-medium">
                            Mark All Read
                        </button>
                        {% endif %}
                    </div>
                    <div class="notification-body" id="notificationBody">
                        {% if unread_notifications %}
                            {% for notification in unread_notifications %}
                            <a href="{% if notification.redirect_url %}{{ notification.redirect_url }}{% else %}#{% endif %}"
                               class="notification-item unread block no-underline"
                               data-notification-id="{{ notification.id }}"
                               onclick="markNotificationRead({{ notification.id }}, '{{ notification.redirect_url }}')">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0 mt-0.5">
                                        {% if notification.notification_type == 'meter_reading' %}
                                        <i class="bi bi-speedometer2 text-primary-600"></i>
                                        {% elif notification.notification_type == 'reading_pending_confirmation' %}
                                        <i class="bi bi-camera-fill text-warning-600"></i>
                                        {% elif notification.notification_type == 'payment' %}
                                        <i class="bi bi-cash-coin text-success-600"></i>
                                        {% elif notification.notification_type == 'bill_generated' %}
                                        <i class="bi bi-receipt text-warning-600"></i>
                                        {% elif notification.notification_type == 'consumer_registered' %}
                                        <i class="bi bi-person-plus text-info-600"></i>
                                        {% else %}
                                        <i class="bi bi-bell-fill text-dark-600"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-dark-800 mb-1">{{ notification.title }}</p>
                                        <p class="text-xs text-dark-600 mb-1">{{ notification.message }}</p>
                                        <p class="text-xs text-dark-400">{{ notification.time_ago }} ago</p>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        {% else %}
                            <div class="notification-empty">
                                <i class="bi bi-bell-slash text-4xl mb-2 block text-light-400"></i>
                                <p class="text-sm">No new notifications</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- User Profile Dropdown -->
            <div class="dropdown">
            <button class="dropdown-toggle flex items-center gap-2 p-0 border-0 bg-transparent cursor-pointer"
                    type="button"
                    id="userDropdown"
                    onclick="toggleDropdown('userDropdown', event)">
                <!-- Role-based Icon with Letter -->
                {% if user.is_superuser or user.staffprofile.role == 'superadmin' %}
                    <div class="flex items-center justify-center w-9 h-9 rounded-full text-white font-bold text-lg shadow-md"
                         style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                        S
                    </div>
                    <span class="text-dark-900 text-sm font-semibold">Superadmin</span>
                {% elif user.staffprofile.role == 'admin' %}
                    <div class="flex items-center justify-center w-9 h-9 rounded-full text-white font-bold text-lg shadow-md"
                         style="background: linear-gradient(135deg, #0369a1, #0ea5e9);">
                        A
                    </div>
                    <span class="text-dark-900 text-sm font-semibold">Admin</span>
                {% elif user.staffprofile.role == 'cashier' %}
                    <div class="flex items-center justify-center w-9 h-9 rounded-full text-white font-bold text-lg shadow-md"
                         style="background: linear-gradient(135deg, #059669, #10b981);">
                        C
                    </div>
                    <span class="text-dark-900 text-sm font-semibold">Cashier</span>
                {% else %}
                    <div class="flex items-center justify-center w-9 h-9 rounded-full text-white font-bold text-lg shadow-md"
                         style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                        U
                    </div>
                    <span class="text-dark-900 text-sm font-semibold">User</span>
                {% endif %}
            </button>
            <div class="dropdown-menu" id="userDropdown-menu">
                <div class="px-3 py-2 border-b border-light-300">
                    <div class="flex items-center gap-3 mb-2">
                        <!-- Role-based Icon in Dropdown -->
                        {% if user.is_superuser or user.staffprofile.role == 'superadmin' %}
                            <div class="flex items-center justify-center w-12 h-12 rounded-full text-white font-bold text-xl shadow-md"
                                 style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                                S
                            </div>
                        {% elif user.staffprofile.role == 'admin' %}
                            <div class="flex items-center justify-center w-12 h-12 rounded-full text-white font-bold text-xl shadow-md"
                                 style="background: linear-gradient(135deg, #0369a1, #0ea5e9);">
                                A
                            </div>
                        {% elif user.staffprofile.role == 'cashier' %}
                            <div class="flex items-center justify-center w-12 h-12 rounded-full text-white font-bold text-xl shadow-md"
                                 style="background: linear-gradient(135deg, #059669, #10b981);">
                                C
                            </div>
                        {% else %}
                            <div class="flex items-center justify-center w-12 h-12 rounded-full text-white font-bold text-xl shadow-md"
                                 style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                                U
                            </div>
                        {% endif %}
                        <div class="flex-1">
                            <div class="font-bold text-dark-900">{{ request.user.get_full_name|default:request.user.username }}</div>
                        </div>
                    </div>
                    <div class="text-xs text-dark-500">{{ request.user.email|default:"No email" }}</div>
                </div>
                <a class="dropdown-item" href="{% url 'consumers:staff_logout' %}">
                    <i class="bi bi-box-arrow-right text-danger-600"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar bg-white text-dark-900 fixed left-0 bottom-0 flex flex-col py-2 px-2 border-r border-light-300"
         style="width: var(--sidebar-width); top: var(--header-height); z-index: 1020; box-shadow: 2px 0 10px rgba(0,0,0,0.05);"
         id="sidebar">
        <nav class="flex-grow overflow-y-auto scrollbar-thin">
            <!-- Main Section: Superadmin & Admin -->
            {% if user.is_superuser or user.staffprofile.role == 'superadmin' or user.staffprofile.role == 'admin' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">Main</div>
                <a href="{% url 'consumers:home' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-house-door-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
            </div>
            {% endif %}

            <!-- Consumer Operations: Superadmin only (Consumers link) -->
            {% if user.is_superuser or user.staffprofile.role == 'superadmin' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">Consumer Ops</div>

                <a href="{% url 'consumers:consumer_management' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-people-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Consumers</span>
                </a>

                <a href="{% url 'consumers:inquire' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-search me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Inquire Bill</span>
                </a>

                <a href="{% url 'consumers:meter_reading_overview' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-speedometer2 me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Meter Readings</span>
                </a>

                <a href="{% url 'consumers:pending_readings' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-camera-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Pending Readings</span>
                    {% if pending_proof_readings_count %}
                    <span class="ml-auto bg-warning-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{{ pending_proof_readings_count }}</span>
                    {% endif %}
                </a>
            </div>
            {% endif %}

            <!-- Admin Section: Inquire Bill, Meter Readings, Pending Readings only -->
            {% if user.staffprofile.role == 'admin' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">Operations</div>

                <a href="{% url 'consumers:inquire' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-search me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Inquire Bill</span>
                </a>

                <a href="{% url 'consumers:meter_reading_overview' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-speedometer2 me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Meter Readings</span>
                </a>

                <a href="{% url 'consumers:pending_readings' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-camera-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Pending Readings</span>
                    {% if pending_proof_readings_count %}
                    <span class="ml-auto bg-warning-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">{{ pending_proof_readings_count }}</span>
                    {% endif %}
                </a>
            </div>
            {% endif %}

            <!-- Note: Field Staff can only access via Smart Meter Reader mobile app -->

            <!-- Reports: Superadmin & Admin -->
            {% if user.is_superuser or user.staffprofile.role == 'superadmin' or user.staffprofile.role == 'admin' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">Reports</div>
                <a href="{% url 'consumers:reports' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-file-earmark-text-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Reports</span>
                </a>
            </div>
            {% endif %}

            <!-- Payment Section: Cashier only -->
            {% if user.staffprofile.role == 'cashier' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">Payment</div>
                <a href="{% url 'consumers:process_payment' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-cash-coin me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Process Payment</span>
                </a>
                <a href="{% url 'consumers:payment_history' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-receipt me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Transaction History</span>
                </a>
            </div>
            {% endif %}

            <!-- System Settings (Superadmin Only) -->
            {% if user.is_superuser or user.staffprofile.role == 'superadmin' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">System</div>
                <a href="{% url 'consumers:system_settings_verification' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-gear-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">System Settings</span>
                </a>
            </div>
            {% endif %}

            <!-- Administration (Superadmin Only) -->
            {% if user.is_superuser or user.staffprofile.role == 'superadmin' %}
            <div class="nav-section mb-2">
                <div class="text-dark-500 uppercase font-semibold mb-1.5 text-xxs tracking-wider px-2" style="font-size: 0.65rem;">Administration</div>
                <a href="{% url 'consumers:admin_verification' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-shield-lock-fill me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">User Management</span>
                </a>
                <a href="{% url 'consumers:user_login_history' %}"
                   class="nav-link-modern flex items-center text-dark-900 no-underline py-2 px-2.5 rounded-lg mb-0.5 transition-all duration-200 hover:bg-light-100 hover:text-primary-600 text-sm">
                    <i class="bi bi-clock-history me-2.5 text-base" style="width: 20px;"></i>
                    <span class="font-medium">Login History</span>
                </a>
            </div>
            {% endif %}
        </nav>
    </div>

    <!-- Header Toast Container for Notifications -->
    <div id="headerToastContainer" class="header-toast-container"></div>

    <!-- Main Content -->
    <div class="main-content min-h-screen p-5" style="margin-left: var(--sidebar-width); margin-top: var(--header-height); overflow-y: auto;" id="main-content">
        {% block main_content %}
        <div class="card p-4 mt-3">
            <h3 class="mb-3 text-2xl font-bold">Welcome, {{ request.user.username }}</h3>
            <p class="text-dark-500">Select a menu from the sidebar to start.</p>
        </div>
        {% endblock %}
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner inline-block mb-3" role="status"></div>
            <p class="mt-3">Loading...</p>
        </div>
    </div>

    <!-- Utility Scripts -->
    <script>
        // Dropdown toggle function
        function toggleDropdown(id, event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }

            const menu = document.getElementById(id + '-menu');
            const dropdown = document.getElementById(id);

            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-menu.show').forEach(m => {
                if (m.id !== id + '-menu') {
                    m.classList.remove('show');
                }
            });

            // Toggle current dropdown
            menu.classList.toggle('show');

            // Close dropdown when clicking outside (delayed to prevent immediate trigger)
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!dropdown.contains(e.target)) {
                            menu.classList.remove('show');
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                }, 10);
            }
        }

        // Loading overlay utility
        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('active');
            overlay.querySelector('p').textContent = message;
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        // === NOTIFICATION FUNCTIONS ===
        function markNotificationRead(notificationId, redirectUrl) {
            event.preventDefault();

            // Send AJAX request to mark as read
            fetch(`/notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Redirect to the notification URL
                    if (redirectUrl && redirectUrl !== '#') {
                        window.location.href = redirectUrl;
                    } else {
                        // Just remove the notification
                        const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
                        if (item) {
                            item.remove();
                            updateNotificationBadge();
                        }
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function markAllAsRead() {
            fetch('/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Clear notification body
                    const body = document.getElementById('notificationBody');
                    body.innerHTML = `
                        <div class="notification-empty">
                            <i class="bi bi-bell-slash text-4xl mb-2 block text-light-400"></i>
                            <p class="text-sm">No new notifications</p>
                        </div>
                    `;
                    updateNotificationBadge();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const items = document.querySelectorAll('.notification-item:not(.notification-empty)');
            if (badge) {
                if (items.length === 0) {
                    badge.style.display = 'none';
                } else {
                    badge.textContent = items.length;
                    badge.style.display = 'flex';
                }
            }
        }

        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Header Toast Notification System (replaces SweetAlert toasts)
        function showToast(type, message, duration = 4000) {
            const container = document.getElementById('headerToastContainer');
            if (!container) return;

            // Map type to appropriate icon and title
            const typeConfig = {
                success: { icon: 'bi-check-circle-fill', title: 'Success' },
                error: { icon: 'bi-x-circle-fill', title: 'Error' },
                warning: { icon: 'bi-exclamation-triangle-fill', title: 'Warning' },
                info: { icon: 'bi-info-circle-fill', title: 'Info' }
            };

            const config = typeConfig[type] || typeConfig.info;
            const toastId = 'toast-' + Date.now();

            const toastHTML = `
                <div id="${toastId}" class="header-toast ${type}" style="position: relative;">
                    <div class="header-toast-icon">
                        <i class="bi ${config.icon} text-lg"></i>
                    </div>
                    <div class="header-toast-content">
                        <div class="header-toast-title">${config.title}</div>
                        <div class="header-toast-message">${message}</div>
                    </div>
                    <button class="header-toast-close" onclick="closeToast('${toastId}')">
                        <i class="bi bi-x text-lg"></i>
                    </button>
                    <div class="header-toast-progress" style="animation-duration: ${duration}ms;"></div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHTML);

            // Auto-remove after duration
            setTimeout(() => {
                closeToast(toastId);
            }, duration);
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // Confirmation dialog
        function confirmAction(title, text, confirmText = 'Yes, proceed!', type = 'warning') {
            return Swal.fire({
                title: title,
                text: text,
                icon: type,
                showCancelButton: true,
                confirmButtonColor: '#0073e6',
                cancelButtonColor: '#f44336',
                confirmButtonText: confirmText,
                cancelButtonText: 'Cancel'
            });
        }

        // Set active nav link based on current path with prefix matching
        function setActiveNavLink() {
            const path = window.location.pathname;
            const active = ['bg-primary-100', 'text-primary-700', 'border-l-4', 'border-primary-600', 'font-semibold'];

            // Extra URL prefixes that should highlight a specific nav link
            // Key = the nav link's own href, Value = additional prefixes to match
            const extraPrefixes = {
                '{% url "consumers:consumer_management" %}': ['/consumer/', '/consumers/', '/connected-consumers/', '/disconnected/', '/disconnect/', '/reconnect/', '/delinquent-consumers/', '/delinquent-report/'],
                '{% url "consumers:inquire" %}':             [],
                '{% url "consumers:process_payment" %}':     ['/payment/process/'],
                '{% url "consumers:payment_history" %}':     ['/payment/receipt/'],
                '{% url "consumers:meter_reading_overview" %}': ['/meter-readings/'],
                '{% url "consumers:pending_readings" %}':    [],
                '{% url "consumers:reports" %}':             ['/reports/export-excel/'],
                '{% url "consumers:system_settings_verification" %}':   ['/system-management/', '/database-documentation/'],
                '{% url "consumers:admin_verification" %}':  ['/user-management/', '/user/'],
                '{% url "consumers:user_login_history" %}':  ['/session/'],
            };

            // Collect all nav links with their match prefixes
            const navLinks = [];
            document.querySelectorAll('.nav-link-modern').forEach(link => {
                const href = link.getAttribute('href');
                const prefixes = [href];
                if (extraPrefixes[href]) {
                    prefixes.push(...extraPrefixes[href]);
                }
                navLinks.push({ el: link, href: href, prefixes: prefixes });
            });

            // Sort by total prefix specificity (longer href = more specific, checked first)
            navLinks.sort((a, b) => b.href.length - a.href.length);

            // Find the best (most specific) match
            let bestLink = null;
            for (const nav of navLinks) {
                if (nav.prefixes.some(prefix => path.startsWith(prefix))) {
                    bestLink = nav.el;
                    break;
                }
            }

            // Apply active state only to the best match
            navLinks.forEach(nav => {
                if (nav.el === bestLink) {
                    nav.el.classList.add(...active);
                } else {
                    nav.el.classList.remove(...active);
                }
            });
        }

        // Close dropdown on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setActiveNavLink();
            initAutoLogout();
            showDjangoMessages(); // Show any Django flash messages
        });

        // Display Django messages as header toasts
        function showDjangoMessages() {
            {% if messages %}
            const djangoMessages = [
                {% for message in messages %}
                { type: '{{ message.tags }}', text: '{{ message|escapejs }}' }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            djangoMessages.forEach((msg, index) => {
                // Map Django message tags to toast types
                let toastType = 'info';
                if (msg.type.includes('success')) toastType = 'success';
                else if (msg.type.includes('error') || msg.type.includes('danger')) toastType = 'error';
                else if (msg.type.includes('warning')) toastType = 'warning';
                else if (msg.type.includes('info')) toastType = 'info';

                // Stagger the messages slightly
                setTimeout(() => {
                    showToast(toastType, msg.text, 5000);
                }, index * 200);
            });
            {% endif %}
        }

        // =====================================================
        // AUTO-LOGOUT: 3 min inactivity â†’ 30 sec countdown
        // =====================================================
        let _idleTimer = null, _countdownTimer = null, _countdownActive = false;

        function initAutoLogout() {
            if (!document.querySelector('a[href*="logout"]')) return;

            // Build warning modal
            document.body.insertAdjacentHTML('beforeend', `
                <div id="idleModal" class="fixed inset-0 z-50 hidden">
                    <div class="fixed inset-0 bg-black bg-opacity-50"></div>
                    <div class="fixed inset-0 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
                            <div class="w-14 h-14 bg-warning-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="bi bi-exclamation-triangle-fill text-2xl text-warning-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-dark-900 mb-1">Session Timeout</h3>
                            <p class="text-sm text-dark-600 mb-4">You will be logged out in</p>
                            <span id="idleCount" class="text-4xl font-bold text-danger-600">30</span>
                            <span class="text-dark-500 ml-1">seconds</span>
                            <div class="w-full bg-light-200 rounded-full h-1.5 my-4">
                                <div id="idleBar" class="bg-danger-500 h-1.5 rounded-full transition-all duration-1000" style="width:100%"></div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="_stayIn()" class="flex-1 btn-primary py-2.5 text-sm font-semibold">
                                    <i class="bi bi-check-circle mr-1"></i>Stay Logged In
                                </button>
                                <button onclick="_doLogout()" class="flex-1 btn-danger py-2.5 text-sm font-semibold">
                                    <i class="bi bi-box-arrow-right mr-1"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);

            ['mousedown','mousemove','keydown','scroll','touchstart','click'].forEach(e => {
                document.addEventListener(e, _resetIdle, { passive: true });
            });
            _resetIdle();
        }

        function _resetIdle() {
            if (_countdownActive) return;
            clearTimeout(_idleTimer);
            _idleTimer = setTimeout(_showWarning, 3 * 60 * 1000); // 3 minutes
        }

        function _showWarning() {
            _countdownActive = true;
            let sec = 30;
            const modal = document.getElementById('idleModal');
            const countEl = document.getElementById('idleCount');
            const bar = document.getElementById('idleBar');
            modal.classList.remove('hidden');

            _countdownTimer = setInterval(() => {
                sec--;
                countEl.textContent = sec;
                bar.style.width = `${(sec / 30) * 100}%`;
                if (sec <= 0) { clearInterval(_countdownTimer); _doLogout(); }
            }, 1000);
        }

        function _stayIn() {
            _countdownActive = false;
            clearInterval(_countdownTimer);
            document.getElementById('idleModal').classList.add('hidden');
            _resetIdle();
            if (typeof showToast === 'function') showToast('success', 'Session extended.');
        }

        function _doLogout() {
            clearTimeout(_idleTimer);
            clearInterval(_countdownTimer);
            window.location.href = '{% url "consumers:staff_logout" %}';
        }

    </script>

    <!-- Page-specific JavaScript -->
    {% block extra_js %}{% endblock %}
</body>
</html>
