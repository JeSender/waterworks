{% extends "consumers/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}System Settings{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-dark-900">System Settings</h2>
        <p class="text-dark-500 text-base mt-1">Configure water rates, reading schedule, and billing cycle</p>
    </div>

    <!-- Success/Error Messages -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="px-4 py-3 rounded-xl border {% if message.tags == 'success' %}bg-success-50 border-success-200 text-success-800{% elif message.tags == 'error' %}bg-danger-50 border-danger-200 text-danger-800{% else %}bg-info-50 border-info-200 text-info-800{% endif %} mb-3">
            <div class="flex items-start gap-2">
                <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% elif message.tags == 'error' %}bi-x-circle-fill{% else %}bi-info-circle-fill{% endif %} text-lg"></i>
                <span class="text-base font-medium">{{ message }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="POST" id="settingsForm">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- LEFT COLUMN: Configuration Cards -->
            <div class="lg:col-span-2 space-y-6">

                <!-- CARD 1: Water Consumption Rates -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-6">
                        <i class="bi bi-droplet-fill text-primary-600"></i>
                        Water Consumption Rates
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
                        <!-- Residential Rate -->
                        <div>
                            <label for="residential_rate_per_cubic" class="block text-base font-medium text-dark-700 mb-2">
                                Residential Rate (₱/m³)
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    name="residential_rate_per_cubic"
                                    id="residential_rate_per_cubic"
                                    value="{{ setting.residential_rate_per_cubic }}"
                                    class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    oninput="updatePreview()">
                            </div>
                        </div>

                        <!-- Commercial Rate -->
                        <div>
                            <label for="commercial_rate_per_cubic" class="block text-base font-medium text-dark-700 mb-2">
                                Commercial Rate (₱/m³)
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    name="commercial_rate_per_cubic"
                                    id="commercial_rate_per_cubic"
                                    value="{{ setting.commercial_rate_per_cubic }}"
                                    class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    oninput="updatePreview()">
                            </div>
                        </div>

                        <!-- Fixed Charge -->
                        <div>
                            <label for="fixed_charge" class="block text-base font-medium text-dark-700 mb-2">
                                Fixed Monthly Charge (₱)
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    name="fixed_charge"
                                    id="fixed_charge"
                                    value="{{ setting.fixed_charge }}"
                                    class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    oninput="updatePreview()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD 2: Reading Schedule -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-2">
                        <i class="bi bi-speedometer2 text-info-600"></i>
                        Reading Schedule
                    </h3>
                    <p class="text-base text-dark-500 mb-6">Define when field staff should submit meter readings</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <!-- Reading Start Day -->
                        <div>
                            <label for="reading_start_day" class="block text-base font-medium text-dark-700 mb-2">
                                Reading Period Start
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="reading_start_day"
                                    id="reading_start_day"
                                    value="{{ setting.reading_start_day|default:1 }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-info-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Day when reading collection starts
                            </p>
                        </div>

                        <!-- Reading End Day -->
                        <div>
                            <label for="reading_end_day" class="block text-base font-medium text-dark-700 mb-2">
                                Reading Period End
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="reading_end_day"
                                    id="reading_end_day"
                                    value="{{ setting.reading_end_day|default:10 }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-info-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Deadline for submitting readings
                            </p>
                        </div>
                    </div>
                </div>

                <!-- CARD 3: Billing Schedule -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-2">
                        <i class="bi bi-calendar-event text-success-600"></i>
                        Billing Schedule
                    </h3>
                    <p class="text-base text-dark-500 mb-6">Configure billing period and payment due dates</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <!-- Billing Day -->
                        <div>
                            <label for="billing_day_of_month" class="block text-base font-medium text-dark-700 mb-2">
                                Billing Period Start
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="billing_day_of_month"
                                    id="billing_day_of_month"
                                    value="{{ setting.billing_day_of_month }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-success-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Date shown on bills as billing period start
                            </p>
                        </div>

                        <!-- Due Day -->
                        <div>
                            <label for="due_day_of_month" class="block text-base font-medium text-dark-700 mb-2">
                                Payment Due Date
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="due_day_of_month"
                                    id="due_day_of_month"
                                    value="{{ setting.due_day_of_month }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-success-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Deadline for consumer payments
                            </p>
                        </div>
                    </div>

                    <div class="mt-5 p-4 bg-warning-50 border-l-4 border-warning-500 rounded-xl">
                        <p class="text-sm text-warning-800">
                            <i class="bi bi-exclamation-triangle-fill mr-1"></i>
                            <strong>Note:</strong> Days are limited to 1-28 to ensure consistency across all months.
                        </p>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="flex items-center justify-end gap-3">
                    <button type="button" onclick="resetForm()" class="btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i>Reset
                    </button>
                    <button type="submit" class="btn-primary" onclick="return confirmSave()">
                        <i class="bi bi-save"></i>Save Settings
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Preview & Info -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Billing Cycle Timeline -->
                <div class="bg-white rounded-xl shadow-md sticky top-6 p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-6">
                        <i class="bi bi-diagram-3 text-primary-600"></i>
                        Monthly Billing Cycle
                    </h3>
                    <div>
                        <!-- Visual Timeline -->
                        <div class="space-y-4">
                            <!-- Step 1: Reading Period -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-info-100 text-info-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    1
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Reading Period</p>
                                    <p class="text-xs text-dark-500">
                                        Day <span id="timeline-reading-start" class="font-semibold text-info-600">{{ setting.reading_start_day|default:1 }}</span>
                                        to <span id="timeline-reading-end" class="font-semibold text-info-600">{{ setting.reading_end_day|default:10 }}</span>
                                    </p>
                                    <p class="text-xs text-dark-400 mt-1">Field staff submit meter readings via app</p>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <i class="bi bi-arrow-down text-light-400"></i>
                            </div>

                            <!-- Step 2: Admin Confirmation -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-warning-100 text-warning-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    2
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Admin Confirmation</p>
                                    <p class="text-xs text-dark-500">After readings are submitted</p>
                                    <p class="text-xs text-dark-400 mt-1">Admin reviews and confirms readings</p>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <i class="bi bi-arrow-down text-light-400"></i>
                            </div>

                            <!-- Step 3: Bill Generation -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-success-100 text-success-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    3
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Bill Generated</p>
                                    <p class="text-xs text-dark-500">
                                        Billing Period: Day <span id="timeline-billing" class="font-semibold text-success-600">{{ setting.billing_day_of_month }}</span>
                                    </p>
                                    <p class="text-xs text-dark-400 mt-1">Bill created instantly on confirmation</p>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <i class="bi bi-arrow-down text-light-400"></i>
                            </div>

                            <!-- Step 4: Payment Due -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-danger-100 text-danger-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    4
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Payment Due</p>
                                    <p class="text-xs text-dark-500">
                                        Due Date: Day <span id="timeline-due" class="font-semibold text-danger-600">{{ setting.due_day_of_month }}</span>
                                    </p>
                                    <p class="text-xs text-dark-400 mt-1">Consumer pays at office</p>
                                </div>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div class="mt-4 p-3 bg-info-50 border border-info-200 rounded-lg">
                            <p class="text-xs text-info-800">
                                <i class="bi bi-lightbulb-fill mr-1"></i>
                                <strong>Testing:</strong> Bills are generated instantly when admin confirms a reading. Schedule settings help organize the workflow.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Bill Calculation Preview -->
                <div class="bg-white rounded-lg border border-light-300 shadow-sm">
                    <div class="px-5 py-3 border-b border-light-200 bg-light-50">
                        <h3 class="text-sm font-semibold text-dark-900 flex items-center gap-2">
                            <i class="bi bi-calculator text-success-600"></i>
                            Bill Preview (10 m³)
                        </h3>
                    </div>
                    <div class="px-5 py-4 space-y-3">
                        <!-- Residential -->
                        <div class="p-3 bg-light-50 rounded border border-light-200">
                            <p class="text-xs font-semibold text-dark-900 mb-2">Residential</p>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>10 m³ × ₱<span id="preview-res-rate">{{ setting.residential_rate_per_cubic }}</span></span>
                                <span class="font-mono" id="preview-res-subtotal">₱0.00</span>
                            </div>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>Fixed Charge</span>
                                <span class="font-mono" id="preview-fixed">₱{{ setting.fixed_charge }}</span>
                            </div>
                            <div class="flex justify-between text-xs font-semibold text-success-700 pt-2 border-t border-light-300 mt-2">
                                <span>Total</span>
                                <span class="font-mono" id="preview-res-total">₱0.00</span>
                            </div>
                        </div>

                        <!-- Commercial -->
                        <div class="p-3 bg-light-50 rounded border border-light-200">
                            <p class="text-xs font-semibold text-dark-900 mb-2">Commercial</p>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>10 m³ × ₱<span id="preview-comm-rate">{{ setting.commercial_rate_per_cubic }}</span></span>
                                <span class="font-mono" id="preview-comm-subtotal">₱0.00</span>
                            </div>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>Fixed Charge</span>
                                <span class="font-mono" id="preview-fixed-comm">₱{{ setting.fixed_charge }}</span>
                            </div>
                            <div class="flex justify-between text-xs font-semibold text-success-700 pt-2 border-t border-light-300 mt-2">
                                <span>Total</span>
                                <span class="font-mono" id="preview-comm-total">₱0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Updated -->
                <div class="bg-light-50 border border-light-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 text-sm text-dark-600">
                        <i class="bi bi-clock-history"></i>
                        <span>Last Updated: <strong>{{ setting.updated_at|date:"M d, Y g:i A"|default:"Never" }}</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update preview calculations in real-time
function updatePreview() {
    const resRate = parseFloat(document.getElementById('residential_rate_per_cubic').value) || 0;
    const commRate = parseFloat(document.getElementById('commercial_rate_per_cubic').value) || 0;
    const fixedCharge = parseFloat(document.getElementById('fixed_charge').value) || 0;
    const consumption = 10;

    const resSubtotal = resRate * consumption;
    const resTotal = resSubtotal + fixedCharge;
    const commSubtotal = commRate * consumption;
    const commTotal = commSubtotal + fixedCharge;

    document.getElementById('preview-res-rate').textContent = resRate.toFixed(2);
    document.getElementById('preview-res-subtotal').textContent = '₱' + resSubtotal.toFixed(2);
    document.getElementById('preview-fixed').textContent = '₱' + fixedCharge.toFixed(2);
    document.getElementById('preview-res-total').textContent = '₱' + resTotal.toFixed(2);

    document.getElementById('preview-comm-rate').textContent = commRate.toFixed(2);
    document.getElementById('preview-comm-subtotal').textContent = '₱' + commSubtotal.toFixed(2);
    document.getElementById('preview-fixed-comm').textContent = '₱' + fixedCharge.toFixed(2);
    document.getElementById('preview-comm-total').textContent = '₱' + commTotal.toFixed(2);
}

// Update timeline display
function updateTimeline() {
    const readingStart = document.getElementById('reading_start_day').value || 1;
    const readingEnd = document.getElementById('reading_end_day').value || 10;
    const billingDay = document.getElementById('billing_day_of_month').value || 1;
    const dueDay = document.getElementById('due_day_of_month').value || 20;

    document.getElementById('timeline-reading-start').textContent = readingStart;
    document.getElementById('timeline-reading-end').textContent = readingEnd;
    document.getElementById('timeline-billing').textContent = billingDay;
    document.getElementById('timeline-due').textContent = dueDay;
}

// Reset form to original values
function resetForm() {
    document.getElementById('settingsForm').reset();
    updatePreview();
    updateTimeline();
}

// Confirm before saving
function confirmSave() {
    const resRate = document.getElementById('residential_rate_per_cubic').value;
    const commRate = document.getElementById('commercial_rate_per_cubic').value;
    const fixedCharge = document.getElementById('fixed_charge').value;
    const readingStart = document.getElementById('reading_start_day').value;
    const readingEnd = document.getElementById('reading_end_day').value;
    const billingDay = document.getElementById('billing_day_of_month').value;
    const dueDay = document.getElementById('due_day_of_month').value;

    return confirm(
        `Save these settings?\n\n` +
        `RATES:\n` +
        `  Residential: ₱${resRate}/m³\n` +
        `  Commercial: ₱${commRate}/m³\n` +
        `  Fixed Charge: ₱${fixedCharge}\n\n` +
        `SCHEDULE:\n` +
        `  Reading Period: Day ${readingStart} - ${readingEnd}\n` +
        `  Billing Period: Day ${billingDay}\n` +
        `  Due Date: Day ${dueDay}\n\n` +
        `This will affect all future bills.`
    );
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    updateTimeline();
});
</script>
{% endblock %}
