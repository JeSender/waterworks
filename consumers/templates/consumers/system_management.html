{% extends "consumers/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}System Settings{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-dark-900">System Settings</h2>
        <p class="text-dark-500 text-base mt-1">Configure water rates, reading schedule, and billing cycle</p>
    </div>

    <!-- Messages now appear in header notification bell -->

    <form method="POST" id="settingsForm">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- LEFT COLUMN: Configuration Cards -->
            <div class="lg:col-span-2 space-y-6">

                <!-- CARD 1: Water Consumption Rates -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-6">
                        <i class="bi bi-droplet-fill text-primary-600"></i>
                        Water Consumption Rates
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
                        <!-- Residential Rate -->
                        <div>
                            <label for="residential_rate_per_cubic" class="block text-base font-medium text-dark-700 mb-2">
                                Residential Rate (₱/m³)
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    name="residential_rate_per_cubic"
                                    id="residential_rate_per_cubic"
                                    value="{{ setting.residential_rate_per_cubic }}"
                                    class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    oninput="updatePreview()">
                            </div>
                        </div>

                        <!-- Commercial Rate -->
                        <div>
                            <label for="commercial_rate_per_cubic" class="block text-base font-medium text-dark-700 mb-2">
                                Commercial Rate (₱/m³)
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    name="commercial_rate_per_cubic"
                                    id="commercial_rate_per_cubic"
                                    value="{{ setting.commercial_rate_per_cubic }}"
                                    class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    oninput="updatePreview()">
                            </div>
                        </div>

                        <!-- Fixed Charge -->
                        <div>
                            <label for="fixed_charge" class="block text-base font-medium text-dark-700 mb-2">
                                Fixed Monthly Charge (₱)
                            </label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    name="fixed_charge"
                                    id="fixed_charge"
                                    value="{{ setting.fixed_charge }}"
                                    class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    required
                                    oninput="updatePreview()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD 2: Reading Schedule -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-2">
                        <i class="bi bi-speedometer2 text-info-600"></i>
                        Reading Schedule
                    </h3>
                    <p class="text-base text-dark-500 mb-6">Define when field staff should submit meter readings</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <!-- Reading Start Day -->
                        <div>
                            <label for="reading_start_day" class="block text-base font-medium text-dark-700 mb-2">
                                Reading Period Start
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="reading_start_day"
                                    id="reading_start_day"
                                    value="{{ setting.reading_start_day|default:1 }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-info-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Day when reading collection starts
                            </p>
                        </div>

                        <!-- Reading End Day -->
                        <div>
                            <label for="reading_end_day" class="block text-base font-medium text-dark-700 mb-2">
                                Reading Period End
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="reading_end_day"
                                    id="reading_end_day"
                                    value="{{ setting.reading_end_day|default:10 }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-info-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Deadline for submitting readings
                            </p>
                        </div>
                    </div>
                </div>

                <!-- CARD 3: Billing Schedule -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-2">
                        <i class="bi bi-calendar-event text-success-600"></i>
                        Billing Schedule
                    </h3>
                    <p class="text-base text-dark-500 mb-6">Configure billing period and payment due dates</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <!-- Billing Day -->
                        <div>
                            <label for="billing_day_of_month" class="block text-base font-medium text-dark-700 mb-2">
                                Billing Period Start
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="billing_day_of_month"
                                    id="billing_day_of_month"
                                    value="{{ setting.billing_day_of_month }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-success-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Date shown on bills as billing period start
                            </p>
                        </div>

                        <!-- Due Day -->
                        <div>
                            <label for="due_day_of_month" class="block text-base font-medium text-dark-700 mb-2">
                                Payment Due Date
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    min="1"
                                    max="28"
                                    name="due_day_of_month"
                                    id="due_day_of_month"
                                    value="{{ setting.due_day_of_month }}"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-success-500 focus:border-transparent"
                                    required
                                    oninput="updateTimeline()">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">day of month</span>
                            </div>
                            <p class="mt-2 text-sm text-dark-500">
                                <i class="bi bi-info-circle mr-1"></i>
                                Deadline for consumer payments
                            </p>
                        </div>
                    </div>

                    <div class="mt-5 p-4 bg-warning-50 border-l-4 border-warning-500 rounded-xl">
                        <p class="text-sm text-warning-800">
                            <i class="bi bi-exclamation-triangle-fill mr-1"></i>
                            <strong>Note:</strong> Days are limited to 1-28 to ensure consistency across all months.
                        </p>
                    </div>
                </div>

                <!-- CARD 4: Late Payment Penalty Settings -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2">
                            <i class="bi bi-exclamation-triangle-fill text-danger-600"></i>
                            Late Payment Penalty
                        </h3>
                        <!-- Enable/Disable Toggle -->
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox"
                                   name="penalty_enabled"
                                   id="penalty_enabled"
                                   class="sr-only peer"
                                   {% if setting.penalty_enabled %}checked{% endif %}
                                   onchange="togglePenaltySettings()">
                            <div class="w-11 h-6 bg-light-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-danger-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-light-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-danger-600"></div>
                            <span class="ml-3 text-sm font-medium text-dark-700" id="penalty-toggle-label">
                                {% if setting.penalty_enabled %}Enabled{% else %}Disabled{% endif %}
                            </span>
                        </label>
                    </div>
                    <p class="text-base text-dark-500 mb-6">Configure penalties for late bill payments</p>

                    <div id="penalty-settings-container" class="{% if not setting.penalty_enabled %}opacity-50 pointer-events-none{% endif %}">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                            <!-- Penalty Type -->
                            <div>
                                <label for="penalty_type" class="block text-base font-medium text-dark-700 mb-2">
                                    Penalty Type
                                </label>
                                <select
                                    name="penalty_type"
                                    id="penalty_type"
                                    class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-danger-500 focus:border-transparent"
                                    onchange="togglePenaltyTypeFields()">
                                    <option value="percentage" {% if setting.penalty_type == 'percentage' %}selected{% endif %}>Percentage of Bill</option>
                                    <option value="fixed" {% if setting.penalty_type == 'fixed' %}selected{% endif %}>Fixed Amount</option>
                                </select>
                                <p class="mt-2 text-sm text-dark-500">
                                    <i class="bi bi-info-circle mr-1"></i>
                                    How penalty is calculated
                                </p>
                            </div>

                            <!-- Penalty Rate (for percentage type) -->
                            <div id="penalty-rate-container" class="{% if setting.penalty_type == 'fixed' %}hidden{% endif %}">
                                <label for="penalty_rate" class="block text-base font-medium text-dark-700 mb-2">
                                    Penalty Rate
                                </label>
                                <div class="relative">
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        max="100"
                                        name="penalty_rate"
                                        id="penalty_rate"
                                        value="{{ setting.penalty_rate }}"
                                        class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-danger-500 focus:border-transparent"
                                        oninput="updatePenaltyPreview()">
                                    <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">%</span>
                                </div>
                                <p class="mt-2 text-sm text-dark-500">
                                    <i class="bi bi-info-circle mr-1"></i>
                                    Percentage of bill amount
                                </p>
                            </div>

                            <!-- Fixed Penalty Amount (for fixed type) -->
                            <div id="fixed-penalty-container" class="{% if setting.penalty_type == 'percentage' %}hidden{% endif %}">
                                <label for="fixed_penalty_amount" class="block text-base font-medium text-dark-700 mb-2">
                                    Fixed Penalty Amount
                                </label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        name="fixed_penalty_amount"
                                        id="fixed_penalty_amount"
                                        value="{{ setting.fixed_penalty_amount }}"
                                        class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-danger-500 focus:border-transparent"
                                        oninput="updatePenaltyPreview()">
                                </div>
                                <p class="mt-2 text-sm text-dark-500">
                                    <i class="bi bi-info-circle mr-1"></i>
                                    Fixed amount regardless of bill
                                </p>
                            </div>

                            <!-- Grace Period -->
                            <div>
                                <label for="penalty_grace_period_days" class="block text-base font-medium text-dark-700 mb-2">
                                    Grace Period
                                </label>
                                <div class="relative">
                                    <input
                                        type="number"
                                        min="0"
                                        max="30"
                                        name="penalty_grace_period_days"
                                        id="penalty_grace_period_days"
                                        value="{{ setting.penalty_grace_period_days }}"
                                        class="w-full px-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-danger-500 focus:border-transparent">
                                    <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-dark-400 text-sm">days</span>
                                </div>
                                <p class="mt-2 text-sm text-dark-500">
                                    <i class="bi bi-info-circle mr-1"></i>
                                    Days after due date before penalty applies (0 = immediate)
                                </p>
                            </div>

                            <!-- Maximum Penalty Cap -->
                            <div>
                                <label for="max_penalty_amount" class="block text-base font-medium text-dark-700 mb-2">
                                    Maximum Penalty Cap
                                </label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-dark-500 text-base font-semibold">₱</span>
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        name="max_penalty_amount"
                                        id="max_penalty_amount"
                                        value="{{ setting.max_penalty_amount }}"
                                        class="w-full pl-10 pr-4 py-3 text-base border border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-danger-500 focus:border-transparent">
                                </div>
                                <p class="mt-2 text-sm text-dark-500">
                                    <i class="bi bi-info-circle mr-1"></i>
                                    Maximum penalty regardless of calculation (0 = no cap)
                                </p>
                            </div>
                        </div>

                        <!-- Penalty Preview -->
                        <div class="mt-5 p-4 bg-danger-50 border border-danger-200 rounded-xl">
                            <h4 class="text-sm font-semibold text-danger-800 mb-2 flex items-center gap-2">
                                <i class="bi bi-calculator"></i>
                                Penalty Preview (₱500 bill, 10 days late)
                            </h4>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <p class="text-xs text-danger-600">Bill Amount</p>
                                    <p class="text-lg font-bold text-danger-800">₱500.00</p>
                                </div>
                                <div>
                                    <p class="text-xs text-danger-600">Penalty</p>
                                    <p class="text-lg font-bold text-danger-800" id="penalty-preview-amount">₱{{ setting.penalty_rate|floatformat:0 }}0.00</p>
                                </div>
                                <div>
                                    <p class="text-xs text-danger-600">Total Due</p>
                                    <p class="text-lg font-bold text-danger-800" id="penalty-preview-total">₱550.00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="flex items-center justify-end gap-3">
                    <button type="button" onclick="resetForm()" class="btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i>Reset
                    </button>
                    <button type="submit" class="btn-primary" onclick="return confirmSave()">
                        <i class="bi bi-save"></i>Save Settings
                    </button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Preview & Info -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Billing Cycle Timeline -->
                <div class="bg-white rounded-xl shadow-md sticky top-6 p-6">
                    <h3 class="text-xl font-semibold text-dark-900 flex items-center gap-2 mb-6">
                        <i class="bi bi-diagram-3 text-primary-600"></i>
                        Monthly Billing Cycle
                    </h3>
                    <div>
                        <!-- Visual Timeline -->
                        <div class="space-y-4">
                            <!-- Step 1: Reading Period -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-info-100 text-info-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    1
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Reading Period</p>
                                    <p class="text-xs text-dark-500">
                                        Day <span id="timeline-reading-start" class="font-semibold text-info-600">{{ setting.reading_start_day|default:1 }}</span>
                                        to <span id="timeline-reading-end" class="font-semibold text-info-600">{{ setting.reading_end_day|default:10 }}</span>
                                    </p>
                                    <p class="text-xs text-dark-400 mt-1">Field staff submit meter readings via app</p>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <i class="bi bi-arrow-down text-light-400"></i>
                            </div>

                            <!-- Step 2: Admin Confirmation -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-warning-100 text-warning-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    2
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Admin Confirmation</p>
                                    <p class="text-xs text-dark-500">After readings are submitted</p>
                                    <p class="text-xs text-dark-400 mt-1">Admin reviews and confirms readings</p>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <i class="bi bi-arrow-down text-light-400"></i>
                            </div>

                            <!-- Step 3: Bill Generation -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-success-100 text-success-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    3
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Bill Generated</p>
                                    <p class="text-xs text-dark-500">
                                        Billing Period: Day <span id="timeline-billing" class="font-semibold text-success-600">{{ setting.billing_day_of_month }}</span>
                                    </p>
                                    <p class="text-xs text-dark-400 mt-1">Bill created instantly on confirmation</p>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <i class="bi bi-arrow-down text-light-400"></i>
                            </div>

                            <!-- Step 4: Payment Due -->
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-danger-100 text-danger-700 rounded-full flex items-center justify-center text-sm font-bold">
                                    4
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-dark-800">Payment Due</p>
                                    <p class="text-xs text-dark-500">
                                        Due Date: Day <span id="timeline-due" class="font-semibold text-danger-600">{{ setting.due_day_of_month }}</span>
                                    </p>
                                    <p class="text-xs text-dark-400 mt-1">Consumer pays at office</p>
                                </div>
                            </div>
                        </div>

                        <!-- Info Box -->
                        <div class="mt-4 p-3 bg-info-50 border border-info-200 rounded-lg">
                            <p class="text-xs text-info-800">
                                <i class="bi bi-lightbulb-fill mr-1"></i>
                                <strong>Testing:</strong> Bills are generated instantly when admin confirms a reading. Schedule settings help organize the workflow.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Bill Calculation Preview -->
                <div class="bg-white rounded-lg border border-light-300 shadow-sm">
                    <div class="px-5 py-3 border-b border-light-200 bg-light-50">
                        <h3 class="text-sm font-semibold text-dark-900 flex items-center gap-2">
                            <i class="bi bi-calculator text-success-600"></i>
                            Bill Preview (10 m³)
                        </h3>
                    </div>
                    <div class="px-5 py-4 space-y-3">
                        <!-- Residential -->
                        <div class="p-3 bg-light-50 rounded border border-light-200">
                            <p class="text-xs font-semibold text-dark-900 mb-2">Residential</p>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>10 m³ × ₱<span id="preview-res-rate">{{ setting.residential_rate_per_cubic }}</span></span>
                                <span class="font-mono" id="preview-res-subtotal">₱0.00</span>
                            </div>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>Fixed Charge</span>
                                <span class="font-mono" id="preview-fixed">₱{{ setting.fixed_charge }}</span>
                            </div>
                            <div class="flex justify-between text-xs font-semibold text-success-700 pt-2 border-t border-light-300 mt-2">
                                <span>Total</span>
                                <span class="font-mono" id="preview-res-total">₱0.00</span>
                            </div>
                        </div>

                        <!-- Commercial -->
                        <div class="p-3 bg-light-50 rounded border border-light-200">
                            <p class="text-xs font-semibold text-dark-900 mb-2">Commercial</p>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>10 m³ × ₱<span id="preview-comm-rate">{{ setting.commercial_rate_per_cubic }}</span></span>
                                <span class="font-mono" id="preview-comm-subtotal">₱0.00</span>
                            </div>
                            <div class="flex justify-between text-xs text-dark-700">
                                <span>Fixed Charge</span>
                                <span class="font-mono" id="preview-fixed-comm">₱{{ setting.fixed_charge }}</span>
                            </div>
                            <div class="flex justify-between text-xs font-semibold text-success-700 pt-2 border-t border-light-300 mt-2">
                                <span>Total</span>
                                <span class="font-mono" id="preview-comm-total">₱0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Updated -->
                <div class="bg-light-50 border border-light-200 rounded-lg p-4">
                    <div class="flex items-center gap-2 text-sm text-dark-600">
                        <i class="bi bi-clock-history"></i>
                        <span>Last Updated: <strong>{{ setting.updated_at|date:"M d, Y g:i A"|default:"Never" }}</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update preview calculations in real-time
function updatePreview() {
    const resRate = parseFloat(document.getElementById('residential_rate_per_cubic').value) || 0;
    const commRate = parseFloat(document.getElementById('commercial_rate_per_cubic').value) || 0;
    const fixedCharge = parseFloat(document.getElementById('fixed_charge').value) || 0;
    const consumption = 10;

    const resSubtotal = resRate * consumption;
    const resTotal = resSubtotal + fixedCharge;
    const commSubtotal = commRate * consumption;
    const commTotal = commSubtotal + fixedCharge;

    document.getElementById('preview-res-rate').textContent = resRate.toFixed(2);
    document.getElementById('preview-res-subtotal').textContent = '₱' + resSubtotal.toFixed(2);
    document.getElementById('preview-fixed').textContent = '₱' + fixedCharge.toFixed(2);
    document.getElementById('preview-res-total').textContent = '₱' + resTotal.toFixed(2);

    document.getElementById('preview-comm-rate').textContent = commRate.toFixed(2);
    document.getElementById('preview-comm-subtotal').textContent = '₱' + commSubtotal.toFixed(2);
    document.getElementById('preview-fixed-comm').textContent = '₱' + fixedCharge.toFixed(2);
    document.getElementById('preview-comm-total').textContent = '₱' + commTotal.toFixed(2);
}

// Update timeline display
function updateTimeline() {
    const readingStart = document.getElementById('reading_start_day').value || 1;
    const readingEnd = document.getElementById('reading_end_day').value || 10;
    const billingDay = document.getElementById('billing_day_of_month').value || 1;
    const dueDay = document.getElementById('due_day_of_month').value || 20;

    document.getElementById('timeline-reading-start').textContent = readingStart;
    document.getElementById('timeline-reading-end').textContent = readingEnd;
    document.getElementById('timeline-billing').textContent = billingDay;
    document.getElementById('timeline-due').textContent = dueDay;
}

// Toggle penalty settings visibility
function togglePenaltySettings() {
    const checkbox = document.getElementById('penalty_enabled');
    const container = document.getElementById('penalty-settings-container');
    const label = document.getElementById('penalty-toggle-label');

    if (checkbox.checked) {
        container.classList.remove('opacity-50', 'pointer-events-none');
        label.textContent = 'Enabled';
    } else {
        container.classList.add('opacity-50', 'pointer-events-none');
        label.textContent = 'Disabled';
    }
}

// Toggle penalty type fields (percentage vs fixed)
function togglePenaltyTypeFields() {
    const penaltyType = document.getElementById('penalty_type').value;
    const rateContainer = document.getElementById('penalty-rate-container');
    const fixedContainer = document.getElementById('fixed-penalty-container');

    if (penaltyType === 'percentage') {
        rateContainer.classList.remove('hidden');
        fixedContainer.classList.add('hidden');
    } else {
        rateContainer.classList.add('hidden');
        fixedContainer.classList.remove('hidden');
    }

    updatePenaltyPreview();
}

// Update penalty preview calculation
function updatePenaltyPreview() {
    const penaltyType = document.getElementById('penalty_type').value;
    const penaltyRate = parseFloat(document.getElementById('penalty_rate').value) || 0;
    const fixedPenalty = parseFloat(document.getElementById('fixed_penalty_amount').value) || 0;
    const maxPenalty = parseFloat(document.getElementById('max_penalty_amount').value) || 0;
    const sampleBill = 500; // Sample bill amount for preview

    let penalty = 0;
    if (penaltyType === 'percentage') {
        penalty = sampleBill * (penaltyRate / 100);
    } else {
        penalty = fixedPenalty;
    }

    // Apply cap if set
    if (maxPenalty > 0 && penalty > maxPenalty) {
        penalty = maxPenalty;
    }

    const total = sampleBill + penalty;

    document.getElementById('penalty-preview-amount').textContent = '₱' + penalty.toFixed(2);
    document.getElementById('penalty-preview-total').textContent = '₱' + total.toFixed(2);
}

// Reset form to original values
function resetForm() {
    document.getElementById('settingsForm').reset();
    updatePreview();
    updateTimeline();
    togglePenaltySettings();
    togglePenaltyTypeFields();
    updatePenaltyPreview();
}

// Confirm before saving
function confirmSave() {
    const resRate = document.getElementById('residential_rate_per_cubic').value;
    const commRate = document.getElementById('commercial_rate_per_cubic').value;
    const fixedCharge = document.getElementById('fixed_charge').value;
    const readingStart = document.getElementById('reading_start_day').value;
    const readingEnd = document.getElementById('reading_end_day').value;
    const billingDay = document.getElementById('billing_day_of_month').value;
    const dueDay = document.getElementById('due_day_of_month').value;

    // Penalty settings
    const penaltyEnabled = document.getElementById('penalty_enabled').checked;
    const penaltyType = document.getElementById('penalty_type').value;
    const penaltyRate = document.getElementById('penalty_rate').value;
    const fixedPenalty = document.getElementById('fixed_penalty_amount').value;
    const gracePeriod = document.getElementById('penalty_grace_period_days').value;
    const maxPenalty = document.getElementById('max_penalty_amount').value;

    let penaltyInfo = '';
    if (penaltyEnabled) {
        if (penaltyType === 'percentage') {
            penaltyInfo = `  Penalty: ${penaltyRate}% of bill\n`;
        } else {
            penaltyInfo = `  Penalty: ₱${fixedPenalty} fixed\n`;
        }
        penaltyInfo += `  Grace Period: ${gracePeriod} days\n`;
        penaltyInfo += `  Max Cap: ₱${maxPenalty}\n`;
    } else {
        penaltyInfo = '  Penalties: DISABLED\n';
    }

    return confirm(
        `Save these settings?\n\n` +
        `RATES:\n` +
        `  Residential: ₱${resRate}/m³\n` +
        `  Commercial: ₱${commRate}/m³\n` +
        `  Fixed Charge: ₱${fixedCharge}\n\n` +
        `SCHEDULE:\n` +
        `  Reading Period: Day ${readingStart} - ${readingEnd}\n` +
        `  Billing Period: Day ${billingDay}\n` +
        `  Due Date: Day ${dueDay}\n\n` +
        `PENALTY:\n` +
        penaltyInfo + `\n` +
        `This will affect all future bills.`
    );
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    updateTimeline();
    updatePenaltyPreview();
});
</script>
{% endblock %}
