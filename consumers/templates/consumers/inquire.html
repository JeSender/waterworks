{% extends "consumers/base.html" %}
{% load dict_extras %}
{% load static %}

{% block title %}Bill Inquiry & Payment - Balilihan Waterworks{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-dark-900">Bill Inquiry & Payment</h2>
        <p class="text-dark-500 text-sm mt-2">Process consumer bill payments and generate receipts</p>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="mb-6 space-y-3">
        {% for message in messages %}
        <div class="flex items-center justify-between p-4 rounded-xl border-l-4 {% if message.tags == 'success' %}bg-success-50 border-success-500 text-success-900{% elif message.tags == 'error' %}bg-danger-50 border-danger-500 text-danger-900{% elif message.tags == 'warning' %}bg-warning-50 border-warning-500 text-warning-900{% else %}bg-info-50 border-info-500 text-info-900{% endif %} shadow-sm">
            <div class="flex items-center gap-3">
                <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% elif message.tags == 'error' %}bi-x-circle-fill{% elif message.tags == 'warning' %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %} text-xl"></i>
                <span class="text-sm font-semibold">{{ message }}</span>
            </div>
            <button onclick="this.parentElement.remove()" class="text-dark-500 hover:text-dark-700 transition-colors">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Location Selection -->
    <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <i class="bi bi-geo-alt-fill"></i>
                Select Location
            </h3>
            <p class="text-primary-100 text-xs mt-1">Choose barangay and purok to filter consumers</p>
        </div>
        <div class="p-6">
            <form method="get" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- Barangay Dropdown -->
                <div>
                    <label class="block text-xs font-bold text-dark-700 mb-2 uppercase tracking-wide">
                        <i class="bi bi-map text-primary-600 mr-1"></i>Barangay
                    </label>
                    <select name="barangay" class="w-full px-4 py-3 text-sm border-2 border-light-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white transition-all font-medium" onchange="this.form.submit()">
                        <option value="">Select Barangay...</option>
                        {% for b in barangays %}
                        <option value="{{ b.id }}" {% if selected_barangay == b.id|stringformat:"s" %}selected{% endif %}>
                            {{ b.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Purok Dropdown -->
                <div>
                    <label class="block text-xs font-bold text-dark-700 mb-2 uppercase tracking-wide">
                        <i class="bi bi-people text-info-600 mr-1"></i>Purok <span class="text-dark-400 font-normal">(Optional)</span>
                    </label>
                    <select name="purok" class="w-full px-4 py-3 text-sm border-2 border-light-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white transition-all font-medium" onchange="this.form.submit()">
                        <option value="">All Puroks</option>
                        {% for p in puroks %}
                        <option value="{{ p.id }}" {% if selected_purok == p.id|stringformat:"s" %}selected{% endif %}>
                            {{ p.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            {% if selected_barangay %}
            <div class="mt-5 p-4 bg-gradient-to-r from-info-50 to-info-100 border-l-4 border-info-500 rounded-lg">
                <div class="flex items-center gap-2 text-sm text-info-900">
                    <i class="bi bi-check-circle-fill text-info-600"></i>
                    <span class="font-semibold">
                        {% for b in barangays %}{% if b.id == selected_barangay|add:"0" %}{{ b.name }}{% endif %}{% endfor %}
                        {% if selected_purok %}<span class="text-info-600 mx-1">•</span>{% for p in puroks %}{% if p.id == selected_purok|add:"0" %}{{ p.name }}{% endif %}{% endfor %}{% endif %}
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Consumer List -->
    {% if selected_barangay and not selected_consumer %}
    <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
        <div class="bg-gradient-to-r from-success-500 to-success-600 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="bi bi-people-fill"></i>
                        Select Consumer
                    </h3>
                    <p class="text-success-100 text-xs mt-1">Choose consumer to process payment</p>
                </div>
                <span class="px-3 py-1.5 bg-white bg-opacity-20 text-white text-xs font-bold rounded-full">
                    {{ consumers|length }} Total
                </span>
            </div>
        </div>

        <!-- Search Bar -->
        {% if consumers %}
        <div class="p-6 bg-light-50 border-b-2 border-light-200">
            <div class="relative">
                <input type="text" id="search-consumer" placeholder="Search by name or account number..." class="w-full px-4 py-3 pl-12 text-sm border-2 border-light-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-success-500 focus:border-success-500 transition-all font-medium">
                <i class="bi bi-search absolute left-4 top-1/2 transform -translate-y-1/2 text-dark-400 text-lg"></i>
            </div>
            <div class="mt-3 flex items-center justify-between text-xs">
                <span class="text-dark-600">Showing <strong class="text-dark-900" id="visible-count">{{ consumers|length }}</strong> of <strong class="text-dark-900">{{ consumers|length }}</strong></span>
                <button onclick="clearSearch()" class="text-success-600 hover:text-success-700 font-semibold transition-colors flex items-center gap-1">
                    <i class="bi bi-arrow-clockwise"></i>Reset
                </button>
            </div>
        </div>
        {% endif %}

        <div class="p-6">
            {% if consumers %}
            <div class="space-y-3" id="consumer-list">
                {% for consumer in consumers %}
                <a href="?barangay={{ selected_barangay }}&purok={{ selected_purok }}&consumer={{ consumer.id }}" class="consumer-card group block p-5 border-2 border-light-300 rounded-xl hover:border-success-500 hover:shadow-lg transition-all duration-200 bg-white" data-consumer-name="{{ consumer.first_name|lower }} {{ consumer.last_name|lower }}" data-consumer-account="{{ consumer.account_number|lower }}">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex-1 flex items-center gap-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-primary-100 to-primary-200 rounded-full flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform duration-200">
                                <i class="bi bi-person-fill text-primary-700 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <h6 class="text-base font-bold text-dark-900 group-hover:text-success-600 transition-colors">
                                    {{ consumer.first_name }} {{ consumer.last_name }}
                                </h6>
                                <div class="text-xs text-dark-500 font-mono font-semibold mt-0.5">{{ consumer.account_number }}</div>
                                <div class="flex items-center gap-2 text-xs text-dark-600 mt-2">
                                    <i class="bi bi-geo-alt-fill text-primary-600"></i>
                                    <span class="font-medium">{{ consumer.barangay.name|default:"—" }}</span>
                                    {% if consumer.purok %}
                                    <span class="text-dark-300">•</span>
                                    <span class="font-medium">{{ consumer.purok.name }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% with bill=consumer_bills|get_item:consumer.id %}
                        {% if bill %}
                        <div class="text-right flex-shrink-0">
                            <span class="inline-flex items-center px-3 py-1 text-xs font-bold rounded-full bg-warning-100 text-warning-800 border border-warning-300 mb-2">
                                <i class="bi bi-clock-fill mr-1"></i>Pending
                            </span>
                            <div class="flex items-baseline justify-end gap-1 text-warning-700 font-extrabold text-2xl">
                                <span class="text-lg">₱</span>
                                <span>{{ bill.total_amount|floatformat:2 }}</span>
                            </div>
                            <div class="text-xs text-dark-500 font-semibold mt-1">{{ bill.billing_period|date:"M Y" }}</div>
                        </div>
                        {% else %}
                        <div class="text-right flex-shrink-0">
                            <span class="inline-flex items-center px-4 py-2 bg-success-100 text-success-700 text-xs font-bold rounded-lg border border-success-300">
                                <i class="bi bi-check-circle-fill mr-1.5"></i>No Bill
                            </span>
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </a>
                {% endfor %}
            </div>

            <!-- No Results Message -->
            <div id="no-results" class="hidden text-center py-16">
                <i class="bi bi-search text-7xl text-light-300 block mb-4 opacity-40"></i>
                <h5 class="text-lg font-bold text-dark-700 mb-2">No Consumers Found</h5>
                <p class="text-sm text-dark-500">Try different search terms</p>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-16">
                <i class="bi bi-inbox text-7xl text-light-300 block mb-4 opacity-40"></i>
                <h5 class="text-lg font-bold text-dark-700 mb-2">No Consumers</h5>
                <p class="text-sm text-dark-500 mb-5 max-w-md mx-auto">
                    No consumers found in this area. Try selecting a different location.
                </p>
                <a href="{% url 'consumers:consumer_management' %}" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all">
                    <i class="bi bi-plus-circle-fill mr-2"></i>Add Consumer
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Payment Form -->
    {% if selected_consumer %}
    <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="bi bi-credit-card-fill"></i>
                        Process Payment
                    </h3>
                    <p class="text-purple-100 text-xs mt-1">Complete transaction and generate receipt</p>
                </div>
                <a href="?barangay={{ selected_barangay }}&purok={{ selected_purok }}" class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white text-xs font-semibold rounded-lg transition-all">
                    <i class="bi bi-arrow-left mr-1.5"></i>Back
                </a>
            </div>
        </div>

        <div class="p-6">
            <!-- Consumer Info Card -->
            <div class="mb-6 p-5 bg-gradient-to-br from-primary-50 to-primary-100 rounded-xl border-2 border-primary-200">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="bi bi-person-fill text-white text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-dark-900">
                            {{ selected_consumer.first_name }} {{ selected_consumer.last_name }}
                        </h4>
                        <p class="text-sm text-dark-600 font-mono font-semibold">{{ selected_consumer.account_number }}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary-200 rounded-lg flex items-center justify-center">
                            <i class="bi bi-geo-alt-fill text-primary-700"></i>
                        </div>
                        <div>
                            <div class="text-xs text-dark-600 font-semibold">Barangay</div>
                            <div class="text-sm font-bold text-dark-900">{{ selected_consumer.barangay.name|default:"—" }}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-info-200 rounded-lg flex items-center justify-center">
                            <i class="bi bi-people-fill text-info-700"></i>
                        </div>
                        <div>
                            <div class="text-xs text-dark-600 font-semibold">Purok</div>
                            <div class="text-sm font-bold text-dark-900">{{ selected_consumer.purok.name|default:"—" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            {% if latest_bill %}
            <!-- Bill Details Card -->
            <div class="mb-6 p-6 bg-gradient-to-br from-warning-50 to-warning-100 rounded-xl border-2 border-warning-300 shadow-sm">
                <div class="flex items-center justify-between mb-5">
                    <h5 class="text-base font-bold text-dark-900 flex items-center gap-2">
                        <i class="bi bi-receipt-cutoff text-warning-700 text-xl"></i>
                        Bill Details
                    </h5>
                    <span class="inline-flex items-center px-3 py-1.5 bg-warning-600 text-white text-xs font-bold rounded-full">
                        <i class="bi bi-clock-fill mr-1.5"></i>Pending
                    </span>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
                    <div class="bg-white bg-opacity-50 p-3 rounded-lg">
                        <div class="text-xs text-dark-600 font-semibold mb-1">Billing Period</div>
                        <div class="text-sm font-bold text-dark-900">{{ latest_bill.billing_period|date:"M Y" }}</div>
                    </div>
                    <div class="bg-white bg-opacity-50 p-3 rounded-lg">
                        <div class="text-xs text-dark-600 font-semibold mb-1">Due Date</div>
                        <div class="text-sm font-bold text-dark-900">{{ latest_bill.due_date|date:"M d, Y" }}</div>
                    </div>
                    <div class="bg-white bg-opacity-50 p-3 rounded-lg">
                        <div class="text-xs text-dark-600 font-semibold mb-1">Consumption</div>
                        <div class="text-sm font-bold text-dark-900">{{ latest_bill.consumption }} m³</div>
                    </div>
                    <div class="bg-white bg-opacity-50 p-3 rounded-lg">
                        <div class="text-xs text-dark-600 font-semibold mb-1">Rate</div>
                        <div class="text-sm font-bold text-dark-900">₱{{ latest_bill.rate_per_cubic|floatformat:2 }}/m³</div>
                    </div>
                </div>

                <div class="pt-5 border-t-2 border-warning-300">
                    <div class="text-sm text-dark-700 font-semibold mb-2">Total Amount Due</div>
                    <div class="flex items-baseline gap-2 text-warning-700 font-extrabold text-5xl">
                        <span class="text-4xl">₱</span>
                        <span id="amount-due">{{ latest_bill.total_amount|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <form method="post" id="payment-form" class="space-y-5">
                {% csrf_token %}
                <input type="hidden" name="bill_id" value="{{ latest_bill.id }}">
                <input type="hidden" id="bill-amount" value="{{ latest_bill.total_amount }}">

                <!-- Cash Received Input -->
                <div>
                    <label class="block text-sm font-bold text-dark-900 mb-3 uppercase tracking-wide">
                        <i class="bi bi-cash-stack text-success-600 mr-1.5"></i>Cash Received
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-5 text-dark-400 text-2xl font-bold">₱</span>
                        <input type="number" step="0.01" name="received_amount" id="received-amount" class="w-full pl-14 pr-5 py-4 text-2xl font-extrabold border-2 border-light-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-success-500 focus:border-success-500 transition-all" min="{{ latest_bill.total_amount }}" placeholder="0.00" oninput="calculateChange()" required>
                    </div>
                    <div class="mt-3 p-3 bg-light-50 rounded-lg border border-light-200">
                        <div class="flex items-center text-xs text-dark-600">
                            <i class="bi bi-info-circle-fill text-info-600 mr-2"></i>
                            <span>Minimum payment: <strong class="text-dark-900">₱{{ latest_bill.total_amount|floatformat:2 }}</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Change Calculator -->
                <div id="change-display" class="hidden p-5 bg-gradient-to-br from-success-50 to-success-100 border-2 border-success-300 rounded-xl shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold text-dark-900">Change to Return</span>
                        <div class="flex items-baseline gap-1 text-success-700 font-extrabold text-3xl">
                            <span class="text-2xl">₱</span>
                            <span id="change-amount">0.00</span>
                        </div>
                    </div>
                    <div class="text-xs text-success-800 font-semibold flex items-center gap-2">
                        <i class="bi bi-check-circle-fill"></i>
                        Verify change amount before completing transaction
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-gradient-to-r from-success-500 to-success-600 hover:from-success-600 hover:to-success-700 text-white text-base font-bold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl">
                    <i class="bi bi-check-circle-fill text-2xl"></i>
                    <span>Process Payment & Generate Receipt</span>
                </button>
            </form>

            {% else %}
            <!-- No Bill Alert -->
            <div class="p-6 bg-gradient-to-br from-warning-50 to-warning-100 border-2 border-warning-300 rounded-xl shadow-sm">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-14 h-14 bg-gradient-to-br from-warning-500 to-warning-600 rounded-full flex items-center justify-center shadow-lg">
                        <i class="bi bi-exclamation-triangle-fill text-white text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <h6 class="text-lg font-bold text-warning-900 mb-2">No Pending Bill</h6>
                        <p class="text-sm text-warning-800 mb-4 leading-relaxed">
                            This consumer doesn't have any pending bills at the moment. Confirm meter readings to generate bills.
                        </p>
                        <a href="{% url 'consumers:meter_readings' %}" class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-warning-500 to-warning-600 hover:from-warning-600 hover:to-warning-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all">
                            <i class="bi bi-speedometer2 mr-2"></i>Go to Meter Readings
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search consumers by name or account number
function filterConsumers() {
    const searchInput = document.getElementById('search-consumer');
    const filter = searchInput.value.toLowerCase().trim();
    const cards = document.querySelectorAll('.consumer-card');
    const noResults = document.getElementById('no-results');

    let visibleCount = 0;

    cards.forEach(card => {
        const name = card.getAttribute('data-consumer-name');
        const account = card.getAttribute('data-consumer-account');

        if (name.includes(filter) || account.includes(filter)) {
            card.style.display = '';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    // Update counter
    document.getElementById('visible-count').textContent = visibleCount;

    // Show/hide no results message
    if (noResults) {
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
}

// Clear search filter
function clearSearch() {
    const searchInput = document.getElementById('search-consumer');
    if (searchInput) {
        searchInput.value = '';
        filterConsumers();
    }
}

// Calculate change in real-time
function calculateChange() {
    const receivedInput = document.getElementById('received-amount');
    const billAmount = parseFloat(document.getElementById('bill-amount').value);
    const changeDisplay = document.getElementById('change-display');
    const changeAmount = document.getElementById('change-amount');

    if (!receivedInput || !billAmount) return;

    const received = parseFloat(receivedInput.value) || 0;
    const change = received - billAmount;

    if (change >= 0 && received > 0) {
        changeAmount.textContent = change.toFixed(2);
        changeDisplay.classList.remove('hidden');
    } else {
        changeDisplay.classList.add('hidden');
    }
}

// Debounce utility
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('search-consumer');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterConsumers, 300));
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                filterConsumers();
            }
        });
    }

    // Payment form validation with SweetAlert2
    const paymentForm = document.getElementById('payment-form');
    if (paymentForm) {
        paymentForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const receivedAmount = parseFloat(document.getElementById('received-amount').value);
            const billAmount = parseFloat(document.getElementById('bill-amount').value);

            if (receivedAmount < billAmount) {
                Swal.fire({
                    icon: 'error',
                    title: 'Insufficient Payment',
                    text: `Cash received must be at least ₱${billAmount.toFixed(2)}`,
                    confirmButtonColor: '#ef4444'
                });
                return false;
            }

            // Confirm before processing
            const change = receivedAmount - billAmount;
            const result = await Swal.fire({
                title: 'Process Payment?',
                html: `
                    <div class="text-start">
                        <p class="mb-2"><strong>Bill Amount:</strong> ₱${billAmount.toFixed(2)}</p>
                        <p class="mb-2"><strong>Cash Received:</strong> ₱${receivedAmount.toFixed(2)}</p>
                        <p><strong>Change:</strong> ₱${change.toFixed(2)}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="bi bi-check-circle mr-1"></i> Confirm Payment',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Processing payment...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                paymentForm.submit();
            }
        });
    }
});
</script>
{% endblock %}
