<!-- consumers/templates/consumers/consumer_management.html (Relevant part updated) -->
{% extends "consumers/base.html" %}
{% load static %}

{% block title %}Consumer Management{% endblock %}

{% block main_content %}
<h2 class="mb-3">Consumer Management</h2>
<p class="text-muted">Here you can manage, search, and filter all consumers.</p>

<!-- Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<!-- Search + Filter -->
<form method="get" class="row mb-4 g-2 align-items-center">
  <div class="col-md-4">
    <input type="text" name="search" placeholder="Search by name or meter serial"
           class="form-control" value="{{ search_query }}">
  </div>
  <div class="col-md-4">
    <select name="barangay" class="form-select">
      <option value="">All Barangays</option>
      {% for brgy in barangays %}
        <option value="{{ brgy.id }}" {% if barangay_filter == brgy.id|stringformat:"s" %}selected{% endif %}>
          {{ brgy.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2 d-grid">
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-filter"></i> Search
    </button>
  </div>
  <div class="col-md-2 d-grid">
    <a href="{% url 'consumers:consumer_management' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-clockwise"></i> Reset
    </a>
  </div>
</form>

<!-- Add Consumer Button -->
<div class="mb-3">
  <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addConsumerModal">
    <i class="bi bi-person-plus"></i> Add Consumer
  </button>
</div>

<!-- Consumer Table -->
<div class="table-responsive">
  <table class="table table-striped table-hover table-bordered align-middle shadow-sm">
    <thead class="table-primary text-center">
      <tr>
        <!-- ADDED: Account Number Column Header -->
        <th>ID Number</th>
        <th>Name</th>
        <th>Phone</th>
        <th>Barangay</th>
        <th>Purok</th>
        <th>Serial</th>
        <th style="width: 150px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for consumer in consumers.object_list %}
      <tr>
        <!-- ADDED: Account Number Cell -->
        <td class="text-center">{{ consumer.account_number }}</td>
        <td>{{ consumer.first_name }} {% if consumer.middle_name %}{{ consumer.middle_name }}{% endif %} {{ consumer.last_name }}</td>
        <td>{{ consumer.phone_number|default:"-" }}</td>
        <td>{{ consumer.barangay.name|default:"-" }}</td>
        <td>{{ consumer.purok.name|default:"-" }}</td>
        <td>{{ consumer.serial_number|default:"-" }}</td>
        <td class="text-center">
          <a href="{% url 'consumers:consumer_detail' consumer.id %}" class="btn btn-info btn-sm me-1">
            <i class="bi bi-eye"></i> View
          </a>
          <a href="{% url 'consumers:edit_consumer' consumer.pk %}" class="btn btn-warning btn-sm">
            <i class="bi bi-pencil-square"></i> Edit
          </a>
        </td>
      </tr>
      {% empty %}
      <!-- UPDATED: colspan to 7 to account for the new ID Number column -->
      <tr>
        <td colspan="7" class="text-center text-muted">No consumers found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination (No changes needed here) -->
{% if consumers.has_other_pages %}
<nav aria-label="Consumer pagination">
  <ul class="pagination justify-content-center mt-3">
    {% if consumers.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ consumers.previous_page_number }}&search={{ search_query }}&barangay={{ barangay_filter }}">
          &laquo; Prev
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo; Prev</span></li>
    {% endif %}

    {% for num in consumers.paginator.page_range %}
      {% if consumers.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num >= consumers.number|add:-2 and num <= consumers.number|add:2 %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}&search={{ search_query }}&barangay={{ barangay_filter }}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if consumers.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ consumers.next_page_number }}&search={{ search_query }}&barangay={{ barangay_filter }}">
          Next &raquo;
        </a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Next &raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Modal and JS (No changes needed for the core logic, but the form part is below) -->
<!-- ✅ ADD CONSUMER MODAL (Partial update for potential field changes) -->
<div class="modal fade" id="addConsumerModal" tabindex="-1" aria-labelledby="addConsumerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{% url 'consumers:add_consumer' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addConsumerModalLabel">Add New Consumer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ✅ Use `form` (not `add_consumer_form`) -->
          {% if form.errors %}
            <div class="alert alert-danger">
              <strong>Please correct the errors below:</strong>
              <ul class="mb-0">
                {% for field in form %}
                  {% if field.errors %}
                    <li>{{ field.label }}: {{ field.errors|first }}</li>
                  {% endif %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <div class="row g-3">
            <!-- Personal Info -->
            <div class="col-md-4">
              <div class="mb-3">
                {{ form.first_name.label_tag }}
                {{ form.first_name }}
                {% if form.first_name.errors %}
                  <div class="text-danger small mt-1">{{ form.first_name.errors|first }}} first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.middle_name.label_tag }}
                {{ form.middle_name }}
              </div>
              <div class="mb-3">
                {{ form.last_name.label_tag }}
                {{ form.last_name }}
                {% if form.last_name.errors %}
                  <div class="text-danger small mt-1">{{ form.last_name.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.birth_date.label_tag }}
                {{ form.birth_date }}
                {% if form.birth_date.errors %}
                  <div class="text-danger small mt-1">{{ form.birth_date.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.gender.label_tag }}
                {{ form.gender }}
                {% if form.gender.errors %}
                  <div class="text-danger small mt-1">{{ form.gender.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.phone_number.label_tag }}
                {{ form.phone_number }}
                {% if form.phone_number.errors %}
                  <div class="text-danger small mt-1">{{ form.phone_number.errors|first }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Address & Household -->
            <div class="col-md-4">
              <div class="mb-3">
                {{ form.civil_status.label_tag }}
                {{ form.civil_status }}
                {% if form.civil_status.errors %}
                  <div class="text-danger small mt-1">{{ form.civil_status.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.spouse_name.label_tag }}
                {{ form.spouse_name }}
              </div>
              <div class="mb-3">
                {{ form.barangay.label_tag }}
                {{ form.barangay }}
                {% if form.barangay.errors %}
                  <div class="text-danger small mt-1">{{ form.barangay.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.purok.label_tag }}
                {{ form.purok }}
                {% if form.purok.errors %}
                  <div class="text-danger small mt-1">{{ form.purok.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.household_number.label_tag }}
                {{ form.household_number }}
                {% if form.household_number.errors %}
                  <div class="text-danger small mt-1">{{ form.household_number.errors|first }}</div>
                {% endif %}
              </div>
            </div>

            <!-- Meter Info -->
            <div class="col-md-4">
              <div class="mb-3">
                {{ form.usage_type.label_tag }}
                {{ form.usage_type }}
                {% if form.usage_type.errors %}
                  <div class="text-danger small mt-1">{{ form.usage_type.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.meter_brand.label_tag }}
                {{ form.meter_brand }}
                {% if form.meter_brand.errors %}
                  <div class="text-danger small mt-1">{{ form.meter_brand.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.serial_number.label_tag }}
                {{ form.serial_number }}
                {% if form.serial_number.errors %}
                  <div class="text-danger small mt-1">{{ form.serial_number.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.first_reading.label_tag }}
                {{ form.first_reading }}
                {% if form.first_reading.errors %}
                  <div class="text-danger small mt-1">{{ form.first_reading.errors|first }}</div>
                {% endif %}
              </div>
              <div class="mb-3">
                {{ form.registration_date.label_tag }}
                {{ form.registration_date }}
                {% if form.registration_date.errors %}
                  <div class="text-danger small mt-1">{{ form.registration_date.errors|first }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success"><i class="bi bi-check2-circle"></i> Submit</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- End Modal -->

<!-- JS for Dependent Dropdown (No changes needed) -->
<script>
// ... (your existing JavaScript for dependent dropdowns) ...
</script>

{% endblock %}
