<!-- consumers/templates/consumers/barangay_meter_readings.html -->
{% extends "consumers/base.html" %}
{% load static %}

{% block title %}{{ barangay.name }} Readings{% endblock %}

{% block main_content %}
<!-- Header: Centered Title with Back Button -->
<div class="mb-6 flex items-center justify-between">
    <!-- Back Button: Left Side -->
    <a href="{% url 'consumers:meter_reading_overview' %}"
       class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg shadow-sm transition-colors duration-150 text-sm inline-flex items-center">
        <i class="bi bi-arrow-left mr-2"></i>Back to Overview
    </a>

    <!-- Centered Title -->
    <h1 class="text-2xl font-bold text-gray-800 absolute left-1/2 transform -translate-x-1/2">
        {{ barangay.name }} – Meter Readings
    </h1>

    <!-- Print Button: Right Side -->
    <a href="{% url 'consumers:barangay_meter_readings_print' barangay.id %}"
       target="_blank"
       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors duration-150 text-sm inline-flex items-center">
        <i class="bi bi-printer mr-2"></i>Print Report
    </a>
</div>

<!-- Messages -->
{% if messages %}
    <div class="mb-4 space-y-2">
        {% for message in messages %}
            <div class="flex items-center justify-between p-4 rounded-lg border {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% elif message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}">
                <span class="text-sm font-medium">{{ message }}</span>
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        {% endfor %}
    </div>
    
{% endif %}

<!-- Search Filter -->
<div class="mb-4 flex items-center gap-3">
    <div class="flex-1 relative">
        <input
            type="text"
            id="search-consumer"
            placeholder="Search by consumer name or ID..."
            class="w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
        >
        <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
    </div>
    <button
        onclick="clearSearch()"
        class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg shadow-sm transition-colors duration-150 text-sm inline-flex items-center"
        title="Clear search"
    >
        <i class="bi bi-x-circle mr-2"></i>Clear
    </button>
    <span id="search-results" class="text-sm text-gray-600 min-w-32 text-right">
        <span class="font-semibold" id="visible-count">{{ readings|length }}</span> of {{ readings|length }}
    </span>
</div>

<!-- Data Table: High-Density Professional Layout -->
<div class=
"bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-100 border-b border-gray-200">
                <tr>
                    <!-- Data Columns -->
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        ID Number
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Consumer Name
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Current
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Previous
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Consumption (m³)
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Date
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for item in readings %}
                    <tr class="hover:bg-gray-50 transition-colors duration-100"
                        data-consumer-name="{{ item.consumer.first_name|lower }} {{ item.consumer.last_name|lower }}"
                        data-consumer-id="{{ item.display_id|lower }}">
                        <!-- ID Number -->
                        <td class="px-4 py-2">
                            <span class="text-sm font-semibold text-gray-800">{{ item.display_id }}</span>
                        </td>

                        <!-- Consumer Name -->
                        <td class="px-4 py-2">
                            <span class="text-sm text-gray-700">{{ item.consumer.first_name }} {{ item.consumer.last_name }}</span>
                        </td>

                        <!-- Current Reading -->
                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                <span class="text-sm font-medium text-gray-800">{{ item.reading.reading_value }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">—</span>
                            {% endif %}
                        </td>

                        <!-- Previous Reading -->
                        <td class="px-4 py-2 text-center">
                            {% if item.prev_reading %}
                                <span class="text-sm text-gray-600">{{ item.prev_reading.reading_value }}</span>
                            {% elif item.consumer.first_reading %}
                                <span class="text-sm text-blue-600" title="Initial meter reading at registration">{{ item.consumer.first_reading }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">0</span>
                            {% endif %}
                        </td>

                        <!-- Consumption -->
                        <td class="px-4 py-2 text-center">
                            {% if item.consumption is not none %}
                                <span class="text-sm font-medium text-gray-800">{{ item.consumption }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">—</span>
                            {% endif %}
                        </td>

                        <!-- Date -->
                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                <span class="text-sm text-gray-600">{{ item.reading.reading_date|date:"Y-m-d" }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">—</span>
                            {% endif %}
                        </td>

                        <!-- Status -->
                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                {% if item.reading.is_confirmed %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                        <i class="bi bi-check-circle-fill mr-1"></i> Confirmed
                                    </span>
                                {% elif item.reading.is_rejected %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">
                                        <i class="bi bi-x-circle-fill mr-1"></i> Rejected
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-clock-fill mr-1"></i> Pending
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-400">—</span>
                            {% endif %}
                        </td>

                        <!-- Actions -->
                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                <div class="flex items-center justify-center gap-2">
                                    {% if item.reading.proof_image_url %}
                                        <button onclick="openImageModal('{{ item.reading.proof_image_url }}')"
                                                class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors"
                                                title="View Proof Photo">
                                            <i class="bi bi-image mr-1"></i> Photo
                                        </button>
                                    {% endif %}
                                    {% if not item.reading.is_confirmed and not item.reading.is_rejected %}
                                        <button onclick="confirmReading({{ item.reading.id }})"
                                                class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-green-100 text-green-700 hover:bg-green-200 transition-colors"
                                                title="Confirm Reading">
                                            <i class="bi bi-check-lg mr-1"></i> Confirm
                                        </button>
                                        <button onclick="showRejectModal({{ item.reading.id }})"
                                                class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-700 hover:bg-red-200 transition-colors"
                                                title="Reject Reading">
                                            <i class="bi bi-x-lg mr-1"></i> Reject
                                        </button>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-sm text-gray-400">—</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500 text-sm">
                            <i class="bi bi-inbox text-3xl mb-2 block text-gray-400"></i>
                            No consumers found in this barangay.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Table Footer: Summary Statistics -->
    {% if readings %}
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
        <div class="flex flex-wrap gap-6 text-xs text-gray-600">
            <div>
                <span class="font-semibold text-gray-700">Total Consumers:</span>
                <span class="ml-1">{{ readings|length }}</span>
            </div>
            <div>
                <span class="font-semibold text-gray-700">With Readings:</span>
                <span class="ml-1 text-green-700 font-semibold">{{ confirmed_count }}</span>
            </div>
            <div>
                <span class="font-semibold text-gray-700">No Readings:</span>
                <span class="ml-1 text-gray-500">{{ no_reading_count }}</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- JavaScript: Enhanced Functionality -->
<script>
/**
 * Initialize on page load
 */
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('search-consumer');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterConsumers, 300));
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                filterConsumers();
            }
        });
    }
});

/**
 * Filter consumers by name or ID
 */
function filterConsumers() {
    const searchInput = document.getElementById('search-consumer');
    const filter = searchInput.value.toLowerCase().trim();
    const rows = document.querySelectorAll('tbody tr[data-consumer-name]');

    let visibleCount = 0;

    rows.forEach(row => {
        const consumerName = row.getAttribute('data-consumer-name');
        const consumerId = row.getAttribute('data-consumer-id');

        if (consumerName.includes(filter) || consumerId.includes(filter)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update visible count display
    updateVisibleCount(visibleCount, rows.length);
}

/**
 * Clear search and show all rows
 */
function clearSearch() {
    document.getElementById('search-consumer').value = '';
    filterConsumers();
}

/**
 * Update visible count display
 */
function updateVisibleCount(visible, total) {
    document.getElementById('visible-count').textContent = visible;

    // Show/hide "no results" message
    const tbody = document.querySelector('tbody');
    const emptyRow = tbody.querySelector('tr:not([data-consumer-name])');

    if (visible === 0 && emptyRow) {
        emptyRow.style.display = '';
    } else if (emptyRow) {
        emptyRow.style.display = 'none';
    }
}

/**
 * Debounce function for search input
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/**
 * Helper function to get CSRF token
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/**
 * Open image modal to view proof photo
 */
function openImageModal(imageUrl) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('imageModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.body.style.overflow = '';
}

/**
 * Confirm reading and generate bill
 */
function confirmReading(readingId) {
    Swal.fire({
        title: 'Confirm Reading?',
        text: 'This will confirm the reading and generate the consumer\'s bill.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#16a34a',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Confirm',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('Confirming reading...');

            fetch(`/meter-readings/${readingId}/confirm/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.status === 'success') {
                    showToast('success', data.message || 'Reading confirmed and bill generated!');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('error', data.message || 'Failed to confirm reading');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('error', 'An error occurred. Please try again.');
            });
        }
    });
}

/**
 * Show reject modal
 */
function showRejectModal(readingId) {
    document.getElementById('rejectReadingId').value = readingId;
    document.getElementById('rejectReason').value = '';
    document.getElementById('rejectModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
    document.body.style.overflow = '';
}

/**
 * Submit rejection
 */
function submitReject(event) {
    event.preventDefault();

    const readingId = document.getElementById('rejectReadingId').value;
    const reason = document.getElementById('rejectReason').value.trim();

    if (!reason) {
        showToast('error', 'Please provide a reason for rejection');
        return;
    }

    closeRejectModal();
    showLoading('Rejecting reading...');

    fetch(`/meter-readings/${readingId}/reject/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'success') {
            showToast('success', data.message || 'Reading rejected');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', data.message || 'Failed to reject reading');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showToast('error', 'An error occurred. Please try again.');
    });
}

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImageModal();
        closeRejectModal();
    }
});
</script>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-80" onclick="closeImageModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="relative max-w-4xl max-h-[90vh]">
            <button onclick="closeImageModal()"
                    class="absolute -top-10 right-0 text-white text-2xl hover:text-gray-300">
                <i class="bi bi-x-lg"></i>
            </button>
            <img id="modalImage" src="" alt="Proof Photo" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl">
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeRejectModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="bi bi-x-circle text-red-600 mr-2"></i>
                    Reject Reading
                </h3>
                <button onclick="closeRejectModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="rejectForm" onsubmit="submitReject(event)">
                <input type="hidden" id="rejectReadingId" value="">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Rejection *</label>
                    <textarea id="rejectReason"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 resize-none"
                              rows="3"
                              placeholder="Please provide a reason for rejecting this reading..."
                              required></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeRejectModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="bi bi-x-lg mr-2"></i> Reject Reading
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
