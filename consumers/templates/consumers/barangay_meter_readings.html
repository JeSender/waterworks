<!-- consumers/templates/consumers/barangay_meter_readings.html -->
{% extends "consumers/base.html" %}
{% load static %}

{% block title %}{{ barangay.name }} Readings{% endblock %}

{% block main_content %}
<!-- Header -->
<div class="mb-6 flex items-center justify-between">
    <a href="{% url 'consumers:meter_reading_overview' %}"
       class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg shadow-sm transition-colors duration-150 text-sm inline-flex items-center">
        <i class="bi bi-arrow-left mr-2"></i>Back to Overview
    </a>

    <h1 class="text-2xl font-bold text-gray-800 absolute left-1/2 transform -translate-x-1/2">
        {{ barangay.name }} â€“ Meter Readings
    </h1>

    <a href="{% url 'consumers:barangay_meter_readings_print' barangay.id %}"
       class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm transition-colors duration-150 text-sm inline-flex items-center">
        <i class="bi bi-printer mr-2"></i>Print Report
    </a>
</div>

<!-- Messages -->
{% if messages %}
    <div class="mb-4 space-y-2">
        {% for message in messages %}
            <div class="flex items-center justify-between p-4 rounded-lg border {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% elif message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}">
                <span class="text-sm font-medium">{{ message }}</span>
                <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- Info Box: Why View-Only -->
<div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
        <i class="bi bi-info-circle-fill text-blue-600 text-xl flex-shrink-0 mt-0.5"></i>
        <div class="flex-1">
            <h3 class="text-sm font-semibold text-blue-900 mb-1">ðŸ“Š Monitoring & Overview Page</h3>
            <p class="text-sm text-blue-800 mb-2">
                This page shows all consumers in <strong>{{ barangay.name }}</strong> for monitoring and reporting purposes.
                You can view reading details and proof photos to verify submissions.
            </p>
            <p class="text-xs text-blue-700 italic">
                <strong>Note:</strong> To confirm or reject readings with proof photos, please use the
                <a href="{% url 'consumers:pending_readings' %}" class="underline hover:text-blue-900 font-semibold">
                    ðŸ“· Pending Readings
                </a>
                page which provides the full review workflow with confirmation actions.
            </p>
        </div>
    </div>
</div>

<!-- Search Filter -->
<div class="mb-4 flex items-center gap-3">
    <div class="flex-1 relative">
        <input
            type="text"
            id="search-consumer"
            placeholder="Search by consumer name or ID..."
            class="w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
        >
        <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
    </div>
    <button onclick="clearSearch()" class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg shadow-sm transition-colors duration-150 text-sm inline-flex items-center">
        <i class="bi bi-x-circle mr-2"></i>Clear
    </button>
    <span class="text-sm text-gray-600 min-w-32 text-right">
        <span class="font-semibold" id="visible-count">{{ readings|length }}</span> of {{ readings|length }}
    </span>
</div>

<!-- Data Table -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-100 border-b border-gray-200">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ID Number</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Consumer Name</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Current</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Previous</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Consumption (mÂ³)</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Date</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for item in readings %}
                    <tr class="hover:bg-gray-50 transition-colors duration-100"
                        data-consumer-name="{{ item.consumer.first_name|lower }} {{ item.consumer.last_name|lower }}"
                        data-consumer-id="{{ item.display_id|lower }}">

                        <td class="px-4 py-2">
                            <span class="text-sm font-semibold text-gray-800">{{ item.display_id }}</span>
                        </td>

                        <td class="px-4 py-2">
                            <span class="text-sm text-gray-700">{{ item.consumer.first_name }} {{ item.consumer.last_name }}</span>
                        </td>

                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                <span class="text-sm font-medium text-gray-800">{{ item.reading.reading_value }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">â€”</span>
                            {% endif %}
                        </td>

                        <td class="px-4 py-2 text-center">
                            {% if item.prev_reading %}
                                <span class="text-sm text-gray-600">{{ item.prev_reading.reading_value }}</span>
                            {% elif item.consumer.first_reading %}
                                <span class="text-sm text-blue-600">{{ item.consumer.first_reading }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">0</span>
                            {% endif %}
                        </td>

                        <td class="px-4 py-2 text-center">
                            {% if item.consumption is not none %}
                                <span class="text-sm font-medium text-gray-800">{{ item.consumption }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">â€”</span>
                            {% endif %}
                        </td>

                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                <span class="text-sm text-gray-600">{{ item.reading.reading_date|date:"Y-m-d" }}</span>
                            {% else %}
                                <span class="text-sm text-gray-400">â€”</span>
                            {% endif %}
                        </td>

                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                {% if item.reading.is_confirmed %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                        <i class="bi bi-check-circle-fill mr-1"></i> Confirmed
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">
                                        <i class="bi bi-clock-fill mr-1"></i> Pending
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-sm text-gray-400">â€”</span>
                            {% endif %}
                        </td>

                        <td class="px-4 py-2 text-center">
                            {% if item.reading %}
                                <button onclick="openDetailsModal('{{ item.display_id }}', '{{ item.consumer.first_name }} {{ item.consumer.last_name }}', '{{ item.consumer.barangay.name }}', {{ item.reading.reading_value }}, {{ item.prev_reading.reading_value|default:item.consumer.first_reading|default:0 }}, {{ item.consumption|default:0 }}, '{{ item.reading.reading_date|date:"Y-m-d" }}', '{{ item.reading.get_source_display|default:item.reading.source }}', {{ item.reading.is_confirmed|lower }}, '{{ item.reading.proof_image_url|default:"" }}')"
                                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors"
                                        title="Show Reading Details">
                                    <i class="bi bi-info-circle mr-1.5"></i> Show Details
                                </button>
                            {% else %}
                                <span class="text-sm text-gray-400">No reading yet</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500 text-sm">
                            <i class="bi bi-inbox text-3xl mb-2 block text-gray-400"></i>
                            No consumers found in this barangay.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if readings %}
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
        <div class="flex flex-wrap gap-6 text-xs text-gray-600">
            <div><span class="font-semibold text-gray-700">Total:</span> {{ readings|length }}</div>
            <div><span class="font-semibold text-gray-700">Confirmed:</span> <span class="text-green-700 font-semibold">{{ confirmed_count }}</span></div>
            <div><span class="font-semibold text-gray-700">Pending:</span> <span class="text-yellow-700 font-semibold">{{ pending_count|default:0 }}</span></div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Details Modal -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeDetailsModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div id="detailsModalContainer" class="bg-white rounded-lg shadow-2xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 rounded-t-lg flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="bi bi-file-text-fill"></i>
                        Reading Details
                    </h3>
                    <button onclick="closeDetailsModal()" class="text-white hover:text-gray-200 text-xl">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Content with scrollable area -->
            <div id="detailsModalContent" class="p-6 overflow-y-auto flex-1">
                <!-- Two-column layout container -->
                <div id="detailsGrid" class="grid grid-cols-1 gap-6">
                    <!-- Left Column: Consumer & Reading Info -->
                    <div class="space-y-4">
                        <!-- Consumer Info -->
                        <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                            <div class="flex justify-between items-start">
                                <span class="text-xs text-gray-600 uppercase font-semibold">Consumer</span>
                                <span class="text-sm font-bold text-gray-900" id="detail-consumer-name"></span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="text-xs text-gray-600 uppercase font-semibold">ID Number</span>
                                <span class="text-sm font-mono text-gray-800" id="detail-consumer-id"></span>
                            </div>
                            <div class="flex justify-between items-start">
                                <span class="text-xs text-gray-600 uppercase font-semibold">Barangay</span>
                                <span class="text-sm text-gray-800" id="detail-barangay"></span>
                            </div>
                        </div>

                        <!-- Reading Info -->
                        <div class="space-y-3">
                            <div class="flex justify-between items-center pb-3 border-b">
                                <span class="text-sm text-gray-600">Current Reading</span>
                                <span class="text-lg font-bold text-blue-600" id="detail-current"></span>
                            </div>
                            <div class="flex justify-between items-center pb-3 border-b">
                                <span class="text-sm text-gray-600">Previous Reading</span>
                                <span class="text-lg font-semibold text-gray-700" id="detail-previous"></span>
                            </div>
                            <div class="flex justify-between items-center pb-3 border-b">
                                <span class="text-sm text-gray-600">Consumption</span>
                                <span class="text-lg font-bold text-green-600" id="detail-consumption"></span>
                            </div>
                            <div class="flex justify-between items-center pb-3 border-b">
                                <span class="text-sm text-gray-600">Reading Date</span>
                                <span class="text-sm font-medium text-gray-800" id="detail-date"></span>
                            </div>
                            <div class="flex justify-between items-center pb-3 border-b">
                                <span class="text-sm text-gray-600">Source</span>
                                <span class="text-sm font-medium text-gray-800" id="detail-source"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Status</span>
                                <span id="detail-status"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Proof Photo (shown when photo exists) -->
                    <div id="detail-photo-section" class="hidden">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="mb-3">
                                <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                    <i class="bi bi-image"></i> Proof Photo
                                </span>
                                <p class="text-xs text-gray-500 mt-1">Click to view full size</p>
                            </div>
                            <div class="bg-white border-2 border-gray-200 rounded-lg p-2 flex items-center justify-center">
                                <img id="detail-photo" src="" alt="Proof Photo" class="max-w-full max-h-96 object-contain rounded cursor-pointer hover:opacity-90 transition-opacity shadow-sm" onclick="openFullImageModal()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-center flex-shrink-0 border-t">
                <button onclick="closeDetailsModal()" class="px-6 py-2.5 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg text-sm transition-colors inline-flex items-center gap-2">
                    <i class="bi bi-arrow-left"></i> Back to List
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal (View Only) -->
<div id="imageModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black" onclick="closeImageModal()"></div>
    <div class="fixed inset-0 flex flex-col">
        <!-- Top Bar with Back Button -->
        <div class="flex items-center justify-between px-6 py-3 bg-black bg-opacity-80 text-white">
            <button onclick="closeImageModal()" class="inline-flex items-center text-sm font-medium hover:text-gray-300 transition-colors">
                <i class="bi bi-arrow-left mr-2"></i> Back to List
            </button>
            <span class="text-base font-semibold" id="photoConsumerName">Proof Photo</span>
            <button onclick="closeImageModal()" class="text-2xl hover:text-gray-300 transition-colors">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Image Display -->
        <div class="flex-1 flex items-center justify-center p-4 bg-black">
            <img id="modalImage" src="" alt="Proof Photo" class="max-w-full max-h-full object-contain">
        </div>

        <!-- Bottom Bar with Back Button -->
        <div class="bg-black bg-opacity-80 px-6 py-4 flex justify-center">
            <button onclick="closeImageModal()" class="px-6 py-2.5 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg text-sm transition-colors inline-flex items-center">
                <i class="bi bi-arrow-left mr-2"></i> Back to List
            </button>
        </div>
    </div>
</div>

<script>
// Details Modal
function openDetailsModal(id, name, barangay, current, previous, consumption, date, source, confirmed, photoUrl) {
    document.getElementById('detail-consumer-name').textContent = name;
    document.getElementById('detail-consumer-id').textContent = id;
    document.getElementById('detail-barangay').textContent = barangay;
    document.getElementById('detail-current').textContent = current;
    document.getElementById('detail-previous').textContent = previous;
    document.getElementById('detail-consumption').textContent = consumption + ' mÂ³';
    document.getElementById('detail-date').textContent = date;
    document.getElementById('detail-source').textContent = source;

    // Status badge
    const statusSpan = document.getElementById('detail-status');
    if (confirmed) {
        statusSpan.innerHTML = '<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800"><i class="bi bi-check-circle-fill mr-1"></i> Confirmed</span>';
    } else {
        statusSpan.innerHTML = '<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800"><i class="bi bi-clock-fill mr-1"></i> Pending</span>';
    }

    // Handle proof photo and adjust layout
    const photoSection = document.getElementById('detail-photo-section');
    const photoImg = document.getElementById('detail-photo');
    const modalContainer = document.getElementById('detailsModalContainer');
    const detailsGrid = document.getElementById('detailsGrid');

    if (photoUrl && photoUrl !== '') {
        photoImg.src = photoUrl;
        photoSection.classList.remove('hidden');
        // Use two-column layout with wider modal
        modalContainer.classList.remove('max-w-md');
        modalContainer.classList.add('max-w-4xl');
        detailsGrid.classList.remove('grid-cols-1');
        detailsGrid.classList.add('md:grid-cols-2');
    } else {
        photoSection.classList.add('hidden');
        // Use single-column layout with narrower modal
        modalContainer.classList.remove('max-w-4xl', 'md:grid-cols-2');
        modalContainer.classList.add('max-w-md');
        detailsGrid.classList.add('grid-cols-1');
    }

    document.getElementById('detailsModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDetailsModal() {
    document.getElementById('detailsModal').classList.add('hidden');
    document.body.style.overflow = '';
}

// Open full image modal from details modal
function openFullImageModal() {
    const photoImg = document.getElementById('detail-photo');
    const consumerName = document.getElementById('detail-consumer-name').textContent;
    if (photoImg.src) {
        openImageModal(photoImg.src, consumerName);
    }
}

// Image Modal
function openImageModal(imageUrl, consumerName) {
    document.getElementById('modalImage').src = imageUrl;
    document.getElementById('photoConsumerName').textContent = consumerName ? consumerName + ' - Proof Photo' : 'Proof Photo';
    document.getElementById('imageModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.body.style.overflow = '';
}

// Search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-consumer');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterConsumers, 300));
    }
});

function filterConsumers() {
    const filter = document.getElementById('search-consumer').value.toLowerCase().trim();
    const rows = document.querySelectorAll('tbody tr[data-consumer-name]');
    let visibleCount = 0;

    rows.forEach(row => {
        const name = row.getAttribute('data-consumer-name');
        const id = row.getAttribute('data-consumer-id');
        if (name.includes(filter) || id.includes(filter)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    document.getElementById('visible-count').textContent = visibleCount;
}

function clearSearch() {
    document.getElementById('search-consumer').value = '';
    filterConsumers();
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (!document.getElementById('detailsModal').classList.contains('hidden')) {
            closeDetailsModal();
        } else if (!document.getElementById('imageModal').classList.contains('hidden')) {
            closeImageModal();
        }
    }
});
</script>
{% endblock %}
