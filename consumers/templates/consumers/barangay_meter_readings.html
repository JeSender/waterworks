<!-- consumers/templates/consumers/barangay_meter_readings.html -->
{% extends "consumers/base.html" %}

{% block title %}{{ barangay.name }} Readings{% endblock %}

{% block main_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ barangay.name }} ‚Äì Meter Readings</h2>
    <div>
        <a href="{% url 'consumers:export_barangay_readings' barangay.id %}" class="btn btn-outline-success btn-sm me-2">
            üìä Export Excel
        </a>
        <a href="{% url 'consumers:meter_readings' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
    </div>
</div>

<!-- Bulk Action Form -->
<form id="bulk-confirm-form" method="post" action="{% url 'consumers:confirm_selected_readings' barangay.id %}" class="mb-3">
    {% csrf_token %}
    <div class="d-flex gap-2 align-items-center">
        <input type="checkbox" id="select-all" onclick="toggleAllCheckboxes(this)">
        <label for="select-all" class="me-3">Select All</label>
        <button type="submit" class="btn btn-warning btn-sm"
                onclick="return confirm('‚ö†Ô∏è Confirm selected readings? This will bill all checked readings without individual review.')">
            ‚úÖ Confirm Selected
        </button>
    </div>
</form>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="table-responsive">
    <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-primary text-center">
            <tr>
                <!-- ‚ùå Removed checkbox from header -->
                <th></th> <!-- Empty header cell -->
                <th>ID Number</th>
                <th>Consumer Name</th>
                <th>Current</th>
                <th>Previous</th>
                <th>Consumption (m¬≥)</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in readings %}
                <tr class="{% if item.consumption and item.consumption > 100 %}table-danger{% endif %}">
                    <td>
                        <!-- Checkbox only enabled if reading exists and is NOT confirmed -->
                        {% if item.reading and not item.reading.is_confirmed %}
                            <input type="checkbox" name="reading_ids" value="{{ item.reading.id }}" class="row-checkbox">
                        {% else %}
                            <!-- Disabled checkbox - not clickable -->
                            <input type="checkbox" disabled class="row-checkbox">
                        {% endif %}
                    </td>
                    <td><strong>{{ item.display_id }}</strong></td>
                    <td>{{ item.consumer.first_name }} {{ item.consumer.last_name }}</td>
                    <td>
                        {% if item.reading %}
                            {{ item.reading.reading_value }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if item.prev_reading %}
                            {{ item.prev_reading.reading_value }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if item.consumption is not none %}
                            {{ item.consumption }}
                            {% if item.consumption > 100 %}
                                <span class="badge bg-danger ms-1">High</span>
                            {% endif %}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if item.reading %}
                            {{ item.reading.reading_date|date:"Y-m-d" }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if item.reading and item.reading.is_confirmed %}
                            <span class="badge bg-success">Confirmed</span>
                        {% elif item.reading %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if item.reading and not item.reading.is_confirmed %}
                            <a href="{% url 'consumers:confirm_reading' item.reading.id %}"
                               class="btn btn-success btn-sm"
                               onclick="return confirm('Confirm billing for {{ item.display_id }} - {{ item.reading.consumer.first_name }} {{ item.reading.consumer.last_name }}?')">
                                Mark & Bill
                            </a>
                        {% elif item.reading %}
                            <span class="text-muted">Confirmed</span>
                        {% else %}
                            <span class="text-muted">No Reading</span>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="9" class="text-center text-muted">No consumers found in this barangay.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function toggleAllCheckboxes(source) {
    const checkboxes = document.querySelectorAll('.row-checkbox:not([disabled])');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

// Optional: Auto-select "Select All" when all enabled checkboxes are checked
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.row-checkbox:not([disabled])');
    const selectAllCheckbox = document.getElementById('select-all');

    checkboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        });
    });
});
</script>
{% endblock %}