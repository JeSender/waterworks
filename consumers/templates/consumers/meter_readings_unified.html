{% extends "consumers/base.html" %}
{% load static %}

{% block title %}Meter Readings - Balilihan Waterworks{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-dark-900 flex items-center gap-2">
                    <i class="bi bi-speedometer2 text-primary-600"></i>
                    Meter Readings Management
                </h2>
                <p class="text-sm text-dark-500 mt-1">Track and manage meter readings - {{ current_month|date:"F Y" }}</p>
            </div>
            <div class="flex gap-3">
                <button onclick="exportCurrentView()" class="btn-success btn-sm">
                    <i class="bi bi-file-earmark-excel"></i> Export to Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-primary-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wide">Total Barangays</p>
                    <p class="text-3xl font-bold text-dark-900 mt-2">{{ total_barangays }}</p>
                </div>
                <div class="w-14 h-14 bg-primary-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-geo-alt-fill text-primary-600 text-2xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-info-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wide">Total Consumers</p>
                    <p class="text-3xl font-bold text-dark-900 mt-2">{{ total_consumers_sum }}</p>
                </div>
                <div class="w-14 h-14 bg-info-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-people-fill text-info-600 text-2xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-success-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wide">Readings This Month</p>
                    <p class="text-3xl font-bold text-success-600 mt-2">{{ total_updated_sum }}</p>
                </div>
                <div class="w-14 h-14 bg-success-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-calendar-check-fill text-success-600 text-2xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-5 border-l-4 border-warning-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wide">Pending Updates</p>
                    <p class="text-3xl font-bold text-warning-600 mt-2">{{ total_pending_sum }}</p>
                </div>
                <div class="w-14 h-14 bg-warning-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-clock-fill text-warning-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Progress Bar -->
    {% if total_consumers_sum > 0 %}
    <div class="bg-white rounded-xl shadow-md p-5 mb-6">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-base font-bold text-dark-900 flex items-center gap-2">
                <i class="bi bi-bar-chart-fill text-primary-600"></i>
                Overall Progress
            </h3>
            <span class="text-2xl font-bold text-primary-600">{{ overall_completion_percentage|floatformat:1 }}%</span>
        </div>
        <div class="w-full bg-light-200 rounded-full h-6 overflow-hidden">
            <div class="bg-gradient-to-r from-success-500 to-success-600 h-6 rounded-full flex items-center justify-end pr-3 transition-all duration-500"
                 style="width: {{ overall_completion_percentage }}%">
                {% if overall_completion_percentage > 20 %}
                <span class="text-white text-xs font-bold">{{ total_updated_sum }} / {{ total_consumers_sum }}</span>
                {% endif %}
            </div>
        </div>
        <div class="mt-2 flex justify-between text-xs text-dark-500">
            <span>{{ total_updated_sum }} consumers updated this month</span>
            <span>{{ total_pending_sum }} still pending</span>
        </div>
    </div>
    {% endif %}

    <!-- Tab Navigation -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="border-b border-light-200">
            <div class="flex">
                <button onclick="switchTab('barangay')"
                        id="tab-barangay"
                        class="tab-btn flex-1 px-6 py-4 text-sm font-semibold border-b-2 border-primary-600 text-primary-600 transition-all duration-200">
                    <i class="bi bi-geo-alt-fill mr-2"></i>
                    By Barangay
                </button>
                <button onclick="switchTab('all')"
                        id="tab-all"
                        class="tab-btn flex-1 px-6 py-4 text-sm font-semibold border-b-2 border-transparent text-dark-500 hover:text-dark-900 hover:border-light-300 transition-all duration-200">
                    <i class="bi bi-list-ul mr-2"></i>
                    All Readings
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="content-barangay" class="tab-content">
            <!-- Search for Barangays -->
            <div class="p-6 border-b border-light-200">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <input type="text"
                               class="w-full px-4 py-3 border border-light-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500"
                               placeholder="Search by barangay name..."
                               id="search-barangay"
                               onkeyup="filterBarangays()">
                    </div>
                    <button onclick="resetBarangayFilter()" class="btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Barangay Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-light-100 border-b border-light-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-dark-700 uppercase">Barangay</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-dark-700 uppercase">Total</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-dark-700 uppercase">Progress</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-dark-700 uppercase">Updated</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-dark-700 uppercase">Pending</th>
                            <th class="px-6 py-4 text-center text-xs font-bold text-dark-700 uppercase w-32">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-light-200" id="barangay-table-body">
                        {% for item in barangay_data %}
                        <tr class="hover:bg-light-50 transition-colors barangay-row" data-barangay="{{ item.barangay.name|lower }}">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                                        <i class="bi bi-geo-alt-fill text-primary-600"></i>
                                    </div>
                                    <div>
                                        <span class="text-base font-bold text-dark-900">{{ item.barangay.name }}</span>
                                        <div class="text-xs text-dark-500">{{ item.updated_count }}/{{ item.total_consumers }} updated</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-lg font-bold text-dark-800">{{ item.total_consumers }}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 bg-light-200 rounded-full h-3">
                                        <div class="h-3 rounded-full
                                            {% if item.completion_percentage >= 80 %}bg-success-500
                                            {% elif item.completion_percentage >= 50 %}bg-info-500
                                            {% elif item.completion_percentage >= 20 %}bg-warning-500
                                            {% else %}bg-danger-500{% endif %}"
                                             style="width: {{ item.completion_percentage }}%">
                                        </div>
                                    </div>
                                    <span class="text-sm font-bold w-12 text-right">{{ item.completion_percentage|floatformat:0 }}%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if item.updated_count > 0 %}
                                <span class="badge badge-success">{{ item.updated_count }}</span>
                                {% else %}
                                <span class="text-dark-400">—</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if item.not_yet_updated > 0 %}
                                <span class="badge badge-warning">{{ item.not_yet_updated }}</span>
                                {% else %}
                                <span class="badge badge-success"><i class="bi bi-check-all"></i> Complete</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <a href="{% url 'consumers:barangay_meter_readings' item.barangay.id %}" class="btn-primary btn-sm">
                                    <i class="bi bi-eye-fill"></i> View
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-16 text-center">
                                <i class="bi bi-inbox text-6xl text-light-300 block mb-4"></i>
                                <h5 class="text-lg font-bold text-dark-600">No barangays found</h5>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Footer Stats -->
            {% if barangay_data %}
            <div class="bg-gradient-to-r from-light-100 to-light-50 px-6 py-5 border-t-2 border-primary-200">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div><p class="text-xs text-dark-500 uppercase mb-1">Barangays</p><p class="text-2xl font-bold">{{ total_barangays }}</p></div>
                    <div><p class="text-xs text-dark-500 uppercase mb-1">Consumers</p><p class="text-2xl font-bold">{{ total_consumers_sum }}</p></div>
                    <div><p class="text-xs text-dark-500 uppercase mb-1">Updated</p><p class="text-2xl font-bold text-success-600">{{ total_updated_sum }}</p></div>
                    <div><p class="text-xs text-dark-500 uppercase mb-1">Pending</p><p class="text-2xl font-bold text-warning-600">{{ total_pending_sum }}</p></div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- All Readings Tab Content -->
        <div id="content-all" class="tab-content hidden">
            <!-- Filters -->
            <div class="p-6 border-b border-light-200">
                <form method="get" id="filter-form">
                    <input type="hidden" name="view" value="all">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <input type="text" name="search" value="{{ search_query }}"
                                   placeholder="Search consumer..."
                                   class="w-full px-4 py-2.5 border border-light-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        </div>
                        <div>
                            <select name="barangay" class="w-full px-4 py-2.5 border border-light-300 rounded-lg">
                                <option value="">All Barangays</option>
                                {% for barangay in barangays %}
                                <option value="{{ barangay.id }}" {% if barangay.id|stringformat:"s" == selected_barangay %}selected{% endif %}>{{ barangay.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <select name="source" class="w-full px-4 py-2.5 border border-light-300 rounded-lg">
                                <option value="">All Sources</option>
                                <option value="mobile_app" {% if selected_source == 'mobile_app' %}selected{% endif %}>Mobile App</option>
                                <option value="manual" {% if selected_source == 'manual' %}selected{% endif %}>Manual</option>
                                <option value="smart_meter" {% if selected_source == 'smart_meter' %}selected{% endif %}>Smart Meter</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button type="submit" class="btn-primary">Apply Filters</button>
                        <a href="?view=all" class="btn-secondary">Reset</a>
                    </div>
                </form>
            </div>

            <!-- Readings Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-light-100 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Consumer</th>
                            <th class="px-4 py-3 text-center text-xs font-bold uppercase">Previous</th>
                            <th class="px-4 py-3 text-center text-xs font-bold uppercase">Current</th>
                            <th class="px-4 py-3 text-center text-xs font-bold uppercase">Consumption</th>
                            <th class="px-4 py-3 text-center text-xs font-bold uppercase">Date</th>
                            <th class="px-4 py-3 text-center text-xs font-bold uppercase">Source</th>
                            <th class="px-4 py-3 text-center text-xs font-bold uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-light-200">
                        {% for item in page_obj %}
                        <tr class="hover:bg-light-50">
                            <td class="px-4 py-3">
                                <div class="font-semibold">{{ item.reading.consumer.first_name }} {{ item.reading.consumer.last_name }}</div>
                                <div class="text-xs text-dark-500">{{ item.reading.consumer.account_number }}</div>
                            </td>
                            <td class="px-4 py-3 text-center">{{ item.prev_reading.reading_value|default:"—" }}</td>
                            <td class="px-4 py-3 text-center font-bold">{{ item.reading.reading_value }}</td>
                            <td class="px-4 py-3 text-center">
                                {% if item.consumption is not none %}
                                <span class="badge badge-primary">{{ item.consumption }} m³</span>
                                {% else %}—{% endif %}
                            </td>
                            <td class="px-4 py-3 text-center text-sm">{{ item.reading.reading_date|date:"M d, Y" }}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge {% if item.reading.source == 'mobile_app' %}badge-primary
                                    {% elif item.reading.source == 'manual' %}badge-secondary
                                    {% else %}badge-success{% endif %}">
                                    {{ item.reading.get_source_display }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if item.reading.is_confirmed %}
                                <span class="badge badge-success"><i class="bi bi-check-circle-fill"></i> Confirmed</span>
                                {% else %}
                                <span class="badge badge-warning"><i class="bi bi-clock-fill"></i> Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-16 text-center">
                                <i class="bi bi-inbox text-6xl text-light-300 block mb-4"></i>
                                <p class="text-dark-500">No readings found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
            <div class="px-6 py-4 bg-light-50 border-t">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-dark-600">Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }}</span>
                    <div class="flex gap-2">
                        {% if page_obj.has_previous %}
                        <a href="?view=all&page={{ page_obj.previous_page_number }}" class="btn-secondary btn-sm">Previous</a>
                        {% endif %}
                        <span class="px-4 py-2 bg-primary-100 rounded">Page {{ page_obj.number }}</span>
                        {% if page_obj.has_next %}
                        <a href="?view=all&page={{ page_obj.next_page_number }}" class="btn-secondary btn-sm">Next</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Tab Switching
function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-primary-600', 'text-primary-600');
        btn.classList.add('border-transparent', 'text-dark-500');
    });
    document.getElementById('tab-' + tab).classList.remove('border-transparent', 'text-dark-500');
    document.getElementById('tab-' + tab).classList.add('border-primary-600', 'text-primary-600');

    // Update content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.getElementById('content-' + tab).classList.remove('hidden');

    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('view', tab === 'all' ? 'all' : 'barangay');
    window.history.pushState({}, '', url);
}

// Barangay Search
function filterBarangays() {
    const input = document.getElementById('search-barangay');
    const filter = input.value.toLowerCase();
    const rows = document.querySelectorAll('.barangay-row');

    rows.forEach(row => {
        const name = row.getAttribute('data-barangay');
        row.style.display = name.includes(filter) ? '' : 'none';
    });
}

function resetBarangayFilter() {
    document.getElementById('search-barangay').value = '';
    filterBarangays();
}

// Export function
function exportCurrentView() {
    const activeTab = document.querySelector('.tab-btn.text-primary-600').id.replace('tab-', '');
    if (activeTab === 'barangay') {
        window.location.href = '?export=excel';
    } else {
        window.location.href = '?view=all&export=excel';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const view = urlParams.get('view');
    if (view === 'all') {
        switchTab('all');
    }
});
</script>
{% endblock %}
