{% extends "consumers/base.html" %}
{% load static %}

{% block title %}Meter Readings - Balilihan Waterworks{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-dark-900 flex items-center gap-2">
                <i class="bi bi-speedometer2 text-primary-600"></i>
                Meter Readings
            </h2>
            <p class="text-dark-500 text-sm mt-1">Monitor and confirm meter readings from mobile app</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="px-4 py-2 bg-info-50 border border-info-200 rounded-lg">
                <div class="flex items-center gap-2 text-sm">
                    <i class="bi bi-phone-fill text-info-600"></i>
                    <span class="text-dark-700 font-medium">All readings from Android App</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="mb-6 space-y-2">
        {% for message in messages %}
        <div class="px-4 py-3 rounded-lg border flex items-center gap-3
            {% if message.tags == 'success' %}bg-success-50 border-success-200 text-success-800
            {% elif message.tags == 'error' %}bg-danger-50 border-danger-200 text-danger-800
            {% elif message.tags == 'warning' %}bg-warning-50 border-warning-200 text-warning-800
            {% else %}bg-info-50 border-info-200 text-info-800{% endif %}">
            <i class="bi
                {% if message.tags == 'success' %}bi-check-circle-fill text-success-600
                {% elif message.tags == 'error' %}bi-x-circle-fill text-danger-600
                {% elif message.tags == 'warning' %}bi-exclamation-triangle-fill text-warning-600
                {% else %}bi-info-circle-fill text-info-600{% endif %} text-xl"></i>
            <p class="font-medium text-sm">{{ message }}</p>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Stats Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg border border-light-300 p-4 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-list-check text-2xl text-primary-600"></i>
                </div>
                <div>
                    <p class="text-xs text-dark-500 font-medium">Total Readings</p>
                    <p class="text-2xl font-bold text-dark-900">{{ readings|length }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg border border-light-300 p-4 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-warning-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-clock-history text-2xl text-warning-600"></i>
                </div>
                <div>
                    <p class="text-xs text-dark-500 font-medium">Pending</p>
                    <p class="text-2xl font-bold text-warning-700">
                        {% with pending=readings|length %}{{ pending }}{% endwith %}
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg border border-light-300 p-4 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-success-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-check-circle text-2xl text-success-600"></i>
                </div>
                <div>
                    <p class="text-xs text-dark-500 font-medium">Confirmed</p>
                    <p class="text-2xl font-bold text-success-700">0</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg border border-light-300 p-4 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-info-100 rounded-full flex items-center justify-center">
                    <i class="bi bi-droplet text-2xl text-info-600"></i>
                </div>
                <div>
                    <p class="text-xs text-dark-500 font-medium">Avg Consumption</p>
                    <p class="text-2xl font-bold text-info-700">
                        {% if readings %}
                            {% with total=0 count=0 %}
                                {% for item in readings %}
                                    {% if item.consumption %}
                                        {% widthratio item.consumption 1 1 as consumption_val %}
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% endif %}
                        -- m³
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Readings Table -->
    <div class="bg-white rounded-lg border border-light-300 shadow-sm overflow-hidden">
        <!-- Table Header -->
        <div class="px-6 py-4 bg-gradient-to-r from-primary-600 to-primary-700 border-b border-primary-700">
            <h3 class="text-base font-semibold text-white flex items-center gap-2">
                <i class="bi bi-table"></i>
                Meter Reading Records
            </h3>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-light-100 border-b border-light-300">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-dark-700">
                            <div class="flex items-center gap-2">
                                <i class="bi bi-person-badge"></i>
                                Consumer
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-arrow-left-circle"></i>
                                Previous
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-arrow-right-circle"></i>
                                Current
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-droplet-fill"></i>
                                Consumption
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-calendar-event"></i>
                                Date
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-phone"></i>
                                Source
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-info-circle"></i>
                                Status
                            </div>
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-dark-700">
                            <div class="flex items-center justify-center gap-2">
                                <i class="bi bi-tools"></i>
                                Actions
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-light-200">
                    {% for item in readings %}
                    <tr class="hover:bg-light-50 transition-colors duration-150">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-primary-700 font-bold text-sm">
                                        {{ item.reading.consumer.first_name.0|upper }}{{ item.reading.consumer.last_name.0|upper }}
                                    </span>
                                </div>
                                <div>
                                    <div class="font-semibold text-dark-900">
                                        {{ item.reading.consumer.first_name }} {{ item.reading.consumer.last_name }}
                                    </div>
                                    <div class="text-xs text-dark-500 font-mono">
                                        {{ item.reading.consumer.account_number }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if item.prev_reading %}
                                <span class="inline-block px-3 py-1 bg-light-100 border border-light-300 rounded-lg font-semibold text-dark-900">
                                    {{ item.prev_reading.reading_value }} m³
                                </span>
                            {% else %}
                                <span class="text-dark-400 italic text-xs">No data</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-block px-3 py-1 bg-primary-50 border border-primary-300 rounded-lg font-bold text-primary-700">
                                {{ item.reading.reading_value }} m³
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if item.consumption is not none %}
                                <div class="flex items-center justify-center gap-1">
                                    <span class="inline-block px-3 py-1 bg-success-50 border border-success-300 rounded-lg font-bold text-success-700">
                                        {{ item.consumption }} m³
                                    </span>
                                </div>
                            {% else %}
                                <span class="text-dark-400 italic text-xs">—</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-dark-900 font-medium">{{ item.reading.reading_date|date:"M d, Y" }}</span>
                                <span class="text-xs text-dark-500">{{ item.reading.reading_date|date:"g:i A" }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold
                                {% if item.reading.source == 'mobile_app' %}bg-primary-100 text-primary-800 border border-primary-300
                                {% elif item.reading.source == 'manual' %}bg-dark-100 text-dark-800 border border-dark-300
                                {% elif item.reading.source == 'smart_meter' %}bg-success-100 text-success-800 border border-success-300
                                {% else %}bg-info-100 text-info-800 border border-info-300{% endif %}">
                                <i class="bi
                                    {% if item.reading.source == 'mobile_app' %}bi-phone-fill
                                    {% elif item.reading.source == 'manual' %}bi-pencil-fill
                                    {% elif item.reading.source == 'smart_meter' %}bi-wifi
                                    {% else %}bi-question-circle-fill{% endif %}"></i>
                                {{ item.reading.get_source_display|default:item.reading.source }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if item.reading.is_confirmed %}
                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-success-100 text-success-800 border border-success-300">
                                    <i class="bi bi-check-circle-fill"></i>
                                    Confirmed
                                </span>
                            {% else %}
                                <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-warning-100 text-warning-800 border border-warning-300">
                                    <i class="bi bi-clock-fill"></i>
                                    Pending
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center justify-center gap-2">
                                {% if not item.reading.is_confirmed %}
                                    <button onclick="confirmReading({{ item.reading.id }}, '{{ item.reading.consumer.first_name }} {{ item.reading.consumer.last_name }}')"
                                            class="px-3 py-1.5 bg-success-600 text-white text-xs font-semibold rounded-lg hover:bg-success-700 transition-colors shadow-sm flex items-center gap-1">
                                        <i class="bi bi-check-circle"></i>
                                        Confirm & Bill
                                    </button>
                                {% else %}
                                    <span class="text-xs text-success-600 font-medium flex items-center gap-1">
                                        <i class="bi bi-check-circle-fill"></i>
                                        Done
                                    </span>
                                {% endif %}
                                <a href="{% url 'consumers:consumer_detail' item.reading.consumer.id %}"
                                   class="px-3 py-1.5 bg-primary-100 text-primary-700 text-xs font-semibold rounded-lg hover:bg-primary-200 transition-colors flex items-center gap-1"
                                   title="View all readings">
                                    <i class="bi bi-eye-fill"></i>
                                    View
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-12 text-center">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-16 h-16 bg-light-200 rounded-full flex items-center justify-center">
                                    <i class="bi bi-inbox text-3xl text-dark-400"></i>
                                </div>
                                <div>
                                    <p class="text-dark-700 font-semibold mb-1">No meter readings found</p>
                                    <p class="text-xs text-dark-500">Meter readings from the Android app will appear here</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Info Notice -->
    <div class="mt-6 p-4 bg-info-50 border border-info-200 rounded-lg">
        <div class="flex items-start gap-3">
            <i class="bi bi-info-circle-fill text-info-600 text-xl mt-0.5"></i>
            <div class="flex-1">
                <h4 class="font-semibold text-info-900 mb-1 text-sm">About Meter Readings</h4>
                <p class="text-xs text-info-800 leading-relaxed">
                    All meter readings are submitted through the Android mobile application. Field staff collect readings using their smartphones,
                    which are then synced to the system for review and confirmation. Confirmed readings automatically generate bills for consumers.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Confirm reading with SweetAlert2
function confirmReading(readingId, consumerName) {
    Swal.fire({
        title: 'Confirm Meter Reading?',
        html: `
            <div class="text-left">
                <p class="mb-2">You are about to confirm the meter reading for:</p>
                <div class="p-3 bg-light-100 rounded-lg mb-3">
                    <p class="font-semibold text-primary-700">${consumerName}</p>
                </div>
                <p class="text-sm text-dark-600">This action will:</p>
                <ul class="text-sm text-dark-600 list-disc list-inside mt-2 space-y-1">
                    <li>Mark the reading as confirmed</li>
                    <li>Generate a water bill automatically</li>
                    <li>Make the bill available for payment</li>
                </ul>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#16a34a',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '<i class="bi bi-check-circle mr-1"></i> Yes, Confirm & Generate Bill',
        cancelButtonText: '<i class="bi bi-x-circle mr-1"></i> Cancel',
        customClass: {
            confirmButton: 'px-4 py-2 text-sm font-semibold',
            cancelButton: 'px-4 py-2 text-sm font-semibold'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Processing...',
                text: 'Confirming reading and generating bill',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Redirect to confirm URL
            window.location.href = `/meter-readings/${readingId}/confirm/`;
        }
    });
}
</script>
{% endblock %}
