
<!-- consumers/templates/consumers/meter_readings.html -->
    {% extends "consumers/base.html" %}

    {% block title %}Meter Readings{% endblock %}

    {% block main_content %}
    <h2 class="mb-4">Meter Readings</h2>

    <!-- Messages -->
    {% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
    {% endif %}

    <!-- Removed the Add/Update Form section -->
    <!-- All readings now come from the Android app -->

    <!-- Readings Table -->
    <div class="table-responsive">
    <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-primary text-center">
            <tr>
                <th>Consumer</th>
                <th>Previous</th>
                <th>Current</th>
                <th>Consumption (m³)</th>
                <th>Date</th>
                <th>Source</th> <!-- Added Source column to show where the reading came from -->
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in readings %}
                <tr>
                    <td>
                        <strong>{{ item.reading.consumer.account_number }}</strong><br>
                        {{ item.reading.consumer.first_name }} {{ item.reading.consumer.last_name }}
                    </td>
                    <td>
                        <!-- Display the Previous Reading Value -->
                        {% if item.prev_reading %}
                            {{ item.prev_reading.reading_value }}
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>{{ item.reading.reading_value }}</td>
                    <td>
                        <!-- Display the Calculated Consumption -->
                        {% if item.consumption is not none %}
                            {{ item.consumption }}
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>{{ item.reading.reading_date|date:"Y-m-d" }}</td>
                    <td>
                        <!-- Display the source of the reading -->
                        <span class="badge 
                            {% if item.reading.source == 'mobile_app' %}bg-primary
                            {% elif item.reading.source == 'manual' %}bg-secondary
                            {% elif item.reading.source == 'smart_meter' %}bg-success
                            {% else %}bg-info{% endif %}">
                            {{ item.reading.get_source_display|default:item.reading.source }}
                        </span>
                    </td>
                    <td>
                        {% if item.reading.is_confirmed %}
                            <span class="badge bg-success">Confirmed</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if not item.reading.is_confirmed %}
                            <a href="{% url 'consumers:confirm_reading' item.reading.id %}"
                            class="btn btn-success btn-sm"
                            onclick="return confirm('Confirm and generate bill for {{ item.reading.consumer.first_name }} {{ item.reading.consumer.last_name }}?')">
                                Confirm & Bill
                            </a>
                        {% else %}
                            <span class="text-muted">Confirmed</span>
                        {% endif %}
                        <!-- Optional: Add a link to view all readings for this consumer -->
                        <br/>
                        <a href="{% url 'consumers:consumer_detail' item.reading.consumer.id %}" class="btn btn-link btn-sm p-0 mt-1">
                            View All Readings
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted">No meter readings found.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% endblock %}