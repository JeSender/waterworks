{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Bill Statement - {{ consumer.id_number }}{% endblock %}

{% block main_content %}
<div class="max-w-6xl mx-auto">
    <!-- Action Bar (Hide on Print) -->
    <div class="mb-6 flex items-center justify-between print:hidden">
        <a href="{% url 'consumers:consumer_detail' consumer.id %}"
           class="px-4 py-2 bg-light-100 text-dark-700 rounded-lg text-sm font-medium hover:bg-light-200 transition-colors flex items-center gap-2">
            <i class="bi bi-arrow-left"></i>
            Back to Consumer Details
        </a>
        <button onclick="window.print()"
                class="btn-primary px-4 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 hover:shadow-lg transition-all duration-200">
            <i class="bi bi-printer-fill"></i>
            Print Statement
        </button>
    </div>

    <!-- Bill Statement (Printable) -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden" id="printable-statement">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="{% static 'consumers/images/logo.png' %}"
                         alt="Balilihan Waterworks Logo"
                         class="w-16 h-16 rounded-full border-4 border-white shadow-lg">
                    <div>
                        <h1 class="text-2xl font-bold mb-1">Balilihan Waterworks</h1>
                        <p class="text-sm text-white/80">Municipality of Balilihan, Bohol</p>
                        <p class="text-xs text-white/70 mt-1">Water Utility Billing Statement</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-white/70 mb-1">Statement Date</p>
                    <p class="text-lg font-semibold">{{ today|date:"F d, Y" }}</p>
                </div>
            </div>
        </div>

        <!-- Consumer Information -->
        <div class="px-8 py-6 border-b border-light-200 bg-light-50">
            <div class="grid grid-cols-2 gap-6">
                <!-- Left Column -->
                <div>
                    <h3 class="text-xs font-semibold text-dark-500 uppercase tracking-wide mb-3">Consumer Information</h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-xs text-dark-500">ID Number</p>
                            <p class="text-base font-bold text-primary-600 font-mono">{{ consumer.id_number }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Consumer Name</p>
                            <p class="text-base font-semibold text-dark-900">
                                {{ consumer.first_name }} {% if consumer.middle_name %}{{ consumer.middle_name|slice:":1" }}.{% endif %} {{ consumer.last_name }}
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Contact Number</p>
                            <p class="text-sm text-dark-700">{{ consumer.phone_number }}</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <h3 class="text-xs font-semibold text-dark-500 uppercase tracking-wide mb-3">Service Address</h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-xs text-dark-500">Location</p>
                            <p class="text-sm font-medium text-dark-900">{{ consumer.purok.name }}</p>
                            <p class="text-sm text-dark-700">{{ consumer.barangay.name }}, Balilihan</p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Meter Serial Number</p>
                            <p class="text-sm font-mono text-dark-700">{{ consumer.serial_number }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Usage Type</p>
                            <p class="text-sm font-medium text-dark-900">
                                {% if consumer.usage_type == "Commercial" %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-warning-100 text-warning-700">
                                        <i class="bi bi-building mr-1"></i> Commercial
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-info-100 text-info-700">
                                        <i class="bi bi-house mr-1"></i> Residential
                                    </span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing History Table -->
        <div class="px-8 py-6">
            <h3 class="text-lg font-bold text-dark-900 mb-4 flex items-center gap-2">
                <i class="bi bi-receipt text-primary-600"></i>
                Billing History
            </h3>

            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-dark-900 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">
                                Billing Period
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">
                                Due Date
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">
                                Previous Reading
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">
                                Current Reading
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">
                                Consumption (m³)
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">
                                Amount
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider">
                                Status
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-light-200">
                        {% for bill in bills %}
                        <tr class="{% if bill.status == 'Overdue' %}bg-danger-50{% elif bill.status == 'Paid' %}bg-success-50/30{% else %}hover:bg-light-50{% endif %} transition-colors">
                            <td class="px-4 py-3">
                                <p class="font-semibold text-dark-900">{{ bill.billing_period|date:"F Y" }}</p>
                                <p class="text-xs text-dark-500">{{ bill.billing_period|date:"M d, Y" }}</p>
                            </td>
                            <td class="px-4 py-3">
                                <p class="text-dark-700">{{ bill.due_date|date:"M d, Y" }}</p>
                                {% if bill.status == 'Overdue' %}
                                    <p class="text-xs text-danger-600 font-medium">Overdue</p>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-mono text-dark-700">
                                    {% if bill.previous_reading %}{{ bill.previous_reading.reading_value }}{% else %}{{ consumer.first_reading }}{% endif %}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-mono text-dark-700">{{ bill.current_reading.reading_value }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-bold text-primary-600">{{ bill.consumption }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-bold text-lg text-dark-900">₱{{ bill.total_amount|floatformat:2|intcomma }}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if bill.status == 'Paid' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full bg-success-100 text-success-700">
                                        <i class="bi bi-check-circle-fill mr-1"></i>
                                        Paid
                                    </span>
                                {% elif bill.status == 'Overdue' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full bg-danger-100 text-danger-700">
                                        <i class="bi bi-exclamation-triangle-fill mr-1"></i>
                                        Overdue
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full bg-warning-100 text-warning-700">
                                        <i class="bi bi-clock-fill mr-1"></i>
                                        Pending
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center">
                                <div class="flex flex-col items-center justify-center text-dark-400">
                                    <i class="bi bi-inbox text-5xl mb-3 opacity-30"></i>
                                    <p class="text-base font-medium mb-1">No billing records found</p>
                                    <p class="text-sm">This consumer has no billing history yet</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Section -->
        {% if bills %}
        <div class="px-8 py-6 border-t-2 border-light-200 bg-light-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Total Bills -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-file-earmark-text-fill text-primary-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Total Bills</p>
                            <p class="text-2xl font-bold text-dark-900">{{ bills|length }}</p>
                        </div>
                    </div>
                </div>

                <!-- Total Amount Billed -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-info-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-cash-stack text-info-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Total Billed</p>
                            <p class="text-2xl font-bold text-dark-900">₱{{ total_billed|floatformat:2|intcomma|default:"0.00" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Balance -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-{% if outstanding_balance > 0 %}exclamation-circle{% else %}check-circle{% endif %}-fill text-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Outstanding</p>
                            <p class="text-2xl font-bold text-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-600">
                                ₱{{ outstanding_balance|floatformat:2|intcomma|default:"0.00" }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="px-8 py-6 border-t border-light-200 bg-white">
            <div class="text-center space-y-2">
                <p class="text-xs text-dark-500">
                    <i class="bi bi-info-circle mr-1"></i>
                    For inquiries and concerns, please contact the Balilihan Waterworks Office
                </p>
                <p class="text-xs text-dark-400">
                    This is a computer-generated statement. Generated on {{ today|date:"F d, Y h:i A" }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    /* Hide non-printable elements */
    .print\:hidden {
        display: none !important;
    }

    /* Page setup */
    @page {
        size: A4;
        margin: 1cm;
    }

    /* Ensure proper page breaks */
    body {
        background: white;
    }

    /* Optimize table printing */
    table {
        page-break-inside: auto;
    }

    tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }

    thead {
        display: table-header-group;
    }

    /* Remove shadows and borders for cleaner print */
    .shadow-lg, .shadow-md, .shadow-sm {
        box-shadow: none !important;
    }

    /* Ensure colors print correctly */
    * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* Remove rounded corners for print */
    .rounded-lg {
        border-radius: 0 !important;
    }
}
</style>
{% endblock %}
