{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Bill Statement - {{ consumer.id_number }}{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Action Bar (Hide on Print) -->
    <div class="mb-6 flex items-center justify-between print:hidden">
        <a href="{% url 'consumers:consumer_detail' consumer.id %}"
           class="px-4 py-2 bg-light-100 text-dark-700 rounded-lg text-sm font-medium hover:bg-light-200 transition-colors flex items-center gap-2">
            <i class="bi bi-arrow-left"></i>
            Back to Consumer Details
        </a>
        <button onclick="window.print()"
                class="btn-primary px-4 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 hover:shadow-lg transition-all duration-200">
            <i class="bi bi-printer-fill"></i>
            Print Statement
        </button>
    </div>

    <!-- Bill Statement (Printable) -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden" id="printable-statement">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white px-8 py-6 print:bg-white print:text-black print:border-b-2 print:border-black">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="{% static 'consumers/images/logo.png' %}"
                         alt="Balilihan Waterworks Logo"
                         class="w-16 h-16 rounded-full border-4 border-white shadow-lg print:border-gray-400">
                    <div>
                        <h1 class="text-2xl font-bold mb-1">Balilihan Waterworks</h1>
                        <p class="text-sm text-white/80 print:text-gray-600">Municipality of Balilihan, 6342, Bohol</p>
                        <p class="text-xs text-white/70 print:text-gray-500 mt-1">Consumer Billing Ledger</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-white/70 print:text-gray-500 mb-1">Statement Date</p>
                    <p class="text-lg font-semibold">{{ today|date:"F d, Y" }}</p>
                </div>
            </div>
        </div>

        <!-- Consumer Information -->
        <div class="px-8 py-5 border-b border-light-200 bg-light-50">
            <div class="grid grid-cols-2 gap-6">
                <!-- Left Column -->
                <div>
                    <h3 class="text-xs font-semibold text-dark-500 uppercase tracking-wide mb-3">Consumer Information</h3>
                    <div class="space-y-1.5">
                        <div class="flex items-baseline gap-2">
                            <p class="text-xs text-dark-500 w-24 shrink-0">Name:</p>
                            <p class="text-sm font-semibold text-dark-900">
                                {{ consumer.last_name }}, {{ consumer.first_name }} {% if consumer.middle_name %}{{ consumer.middle_name|slice:":1" }}.{% endif %} {% if consumer.suffix %}{{ consumer.suffix }}{% endif %}
                            </p>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <p class="text-xs text-dark-500 w-24 shrink-0">Address:</p>
                            <p class="text-sm text-dark-700">{{ consumer.purok.name }}, {{ consumer.barangay.name }}, Balilihan</p>
                        </div>
                    </div>
                </div>
                <!-- Right Column -->
                <div>
                    <h3 class="text-xs font-semibold text-dark-500 uppercase tracking-wide mb-3">Service Details</h3>
                    <div class="space-y-1.5">
                        <div class="flex items-baseline gap-2">
                            <p class="text-xs text-dark-500 w-28 shrink-0">Service No:</p>
                            <p class="text-sm font-bold text-primary-600 font-mono">{{ consumer.id_number }}</p>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <p class="text-xs text-dark-500 w-28 shrink-0">Meter Serial:</p>
                            <p class="text-sm font-mono text-dark-700">{{ consumer.serial_number }}</p>
                        </div>
                        <div class="flex items-baseline gap-2">
                            <p class="text-xs text-dark-500 w-28 shrink-0">Type:</p>
                            {% if consumer.usage_type == "Commercial" %}
                            <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-warning-100 text-warning-700">
                                <i class="bi bi-building mr-1"></i>Commercial
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-info-100 text-info-700">
                                <i class="bi bi-house mr-1"></i>Residential
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Year Filter Tabs (Hide on Print) -->
        <div class="px-8 pt-5 pb-3 print:hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-dark-900 flex items-center gap-2">
                    <i class="bi bi-journal-text text-primary-600"></i>
                    Billing Ledger
                </h3>
            </div>
            {% if available_years %}
            <div class="flex items-center gap-2 flex-wrap">
                <a href="{% url 'consumers:consumer_bill' consumer.id %}"
                   class="px-4 py-1.5 text-sm font-medium rounded-full transition-colors {% if not selected_year %}bg-primary-600 text-white shadow-sm{% else %}bg-light-100 text-dark-600 hover:bg-light-200{% endif %}">
                    All Years
                </a>
                {% for year in available_years %}
                <a href="{% url 'consumers:consumer_bill' consumer.id %}?year={{ year }}"
                   class="px-4 py-1.5 text-sm font-medium rounded-full transition-colors {% if selected_year == year|stringformat:'d' %}bg-primary-600 text-white shadow-sm{% else %}bg-light-100 text-dark-600 hover:bg-light-200{% endif %}">
                    {{ year }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Ledger Cards -->
        <div class="px-8 pb-6 space-y-8">
            {% for card in ledger_cards %}
            <!-- Year Card: {{ card.year }} -->
            <div class="ledger-card">
                <div class="overflow-x-auto rounded-lg border border-light-300 print:border-black">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-dark-800 text-white print:bg-gray-200 print:text-black">
                                <th class="px-3 py-2.5 text-left text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-32">
                                    Month & Year<br>
                                    <span class="text-base font-black">{{ card.year }}</span>
                                </th>
                                <th class="px-3 py-2.5 text-center text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-16">
                                    Status
                                </th>
                                <th class="px-3 py-2.5 text-right text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-16">
                                    Cu.m.
                                </th>
                                <th class="px-3 py-2.5 text-right text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-24">
                                    Amount<br>Due
                                </th>
                                <th class="px-3 py-2.5 text-right text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-20">
                                    Penalty
                                </th>
                                <th class="px-3 py-2.5 text-right text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-24">
                                    Amount<br>Paid
                                </th>
                                <th class="px-3 py-2.5 text-left text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-36">
                                    Receipt<br>Number
                                </th>
                                <th class="px-3 py-2.5 text-left text-xs font-bold uppercase tracking-wider border-r border-dark-700 print:border-gray-400 w-24">
                                    Date<br>Issued
                                </th>
                                <th class="px-3 py-2.5 text-center text-xs font-bold uppercase tracking-wider w-16">
                                    Initial
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in card.months %}
                            <tr class="border-b border-light-200 print:border-gray-300
                                {% if row.status == 'Overdue' %}bg-danger-50
                                {% elif row.status == 'Paid' %}bg-success-50/30
                                {% elif row.connection_status == 'disconnected' and not row.bill %}bg-light-100
                                {% else %}hover:bg-light-50{% endif %} transition-colors">
                                <!-- Month -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 font-semibold text-dark-900">
                                    {{ row.month_name }}
                                </td>
                                <!-- Connection Status -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-center">
                                    {% if row.connection_status == 'active' %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-success-100 print:bg-transparent" title="Connected">
                                        <i class="bi bi-check-circle-fill text-success-600 text-xs"></i>
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-danger-100 print:bg-transparent" title="Disconnected">
                                        <i class="bi bi-x-circle-fill text-danger-500 text-xs"></i>
                                    </span>
                                    {% endif %}
                                </td>
                                <!-- Cu.m. -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-right font-mono text-dark-700">
                                    {% if row.consumption is not None %}{{ row.consumption }}{% endif %}
                                </td>
                                <!-- Amount Due -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-right font-mono">
                                    {% if row.amount_due is not None %}
                                    <span class="font-semibold text-dark-900">{{ row.amount_due|floatformat:2|intcomma }}</span>
                                    {% endif %}
                                </td>
                                <!-- Penalty -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-right font-mono">
                                    {% if row.penalty is not None and row.penalty > 0 %}
                                    <span class="text-danger-600 font-semibold">{{ row.penalty|floatformat:2|intcomma }}</span>
                                    {% endif %}
                                </td>
                                <!-- Amount Paid -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-right font-mono">
                                    {% if row.amount_paid is not None %}
                                    <span class="font-semibold text-success-700">{{ row.amount_paid|floatformat:2|intcomma }}</span>
                                    {% endif %}
                                </td>
                                <!-- Receipt Number -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-left">
                                    {% if row.receipt_number %}
                                    <span class="font-mono text-xs text-dark-600">{{ row.receipt_number }}</span>
                                    {% endif %}
                                </td>
                                <!-- Date Issued -->
                                <td class="px-3 py-2 border-r border-light-200 print:border-gray-300 text-left text-xs text-dark-600">
                                    {% if row.date_issued %}
                                    {{ row.date_issued|date:"M d, Y" }}
                                    {% endif %}
                                </td>
                                <!-- Initial (processed by) -->
                                <td class="px-3 py-2 text-center text-xs font-semibold text-dark-500">
                                    {% if row.processed_by %}
                                    {{ row.processed_by.first_name|slice:":1" }}{{ row.processed_by.last_name|slice:":1" }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <div class="flex flex-col items-center justify-center text-dark-400">
                    <i class="bi bi-inbox text-5xl mb-3 opacity-30"></i>
                    <p class="text-base font-medium mb-1">No billing records found</p>
                    <p class="text-sm">{% if selected_year %}No bills for {{ selected_year }}{% else %}This consumer has no billing history yet{% endif %}</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Summary Section -->
        {% if ledger_cards %}
        <div class="px-8 py-6 border-t-2 border-light-200 bg-light-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Total Bills -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-file-earmark-text-fill text-primary-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Total Bills</p>
                            <p class="text-2xl font-bold text-dark-900">{{ total_bills }}</p>
                        </div>
                    </div>
                </div>

                <!-- Total Amount Billed -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-info-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-cash-stack text-info-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Total Billed</p>
                            <p class="text-2xl font-bold text-dark-900">₱{{ total_billed|floatformat:2|intcomma|default:"0.00" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Balance -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-{% if outstanding_balance > 0 %}exclamation-circle{% else %}check-circle{% endif %}-fill text-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Outstanding</p>
                            <p class="text-2xl font-bold text-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-600">
                                ₱{{ outstanding_balance|floatformat:2|intcomma|default:"0.00" }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="mt-4 flex items-center gap-6 text-xs text-dark-500">
                <span class="flex items-center gap-1.5">
                    <i class="bi bi-check-circle-fill text-success-600"></i> Connected
                </span>
                <span class="flex items-center gap-1.5">
                    <i class="bi bi-x-circle-fill text-danger-500"></i> Disconnected
                </span>
                <span class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded bg-success-50 border border-success-200 inline-block"></span> Paid
                </span>
                <span class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded bg-danger-50 border border-danger-200 inline-block"></span> Overdue
                </span>
            </div>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="px-8 py-6 border-t border-light-200 bg-white">
            <div class="text-center space-y-2">
                <p class="text-xs text-dark-500">
                    <i class="bi bi-info-circle mr-1"></i>
                    For inquiries and concerns, please contact the Balilihan Waterworks Office
                </p>
                <p class="text-xs text-dark-400">
                    This is a computer-generated statement. Generated on {{ today|date:"F d, Y h:i A" }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    .print\:hidden { display: none !important; }
    .print\:block { display: block !important; }
    @page { size: A4 landscape; margin: 0.8cm; }
    body { background: white; font-size: 11px; }
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; page-break-after: auto; }
    thead { display: table-header-group; }
    .shadow-lg, .shadow-md, .shadow-sm { box-shadow: none !important; }
    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .rounded-lg { border-radius: 0 !important; }
    .ledger-card { page-break-inside: avoid; }
}
</style>

{% endblock %}
