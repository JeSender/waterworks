{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Bill Statement - {{ consumer.id_number }}{% endblock %}

{% block main_content %}
<div class="max-w-6xl mx-auto">
    <!-- Action Bar (Hide on Print) -->
    <div class="mb-6 flex items-center justify-between print:hidden">
        <a href="{% url 'consumers:consumer_detail' consumer.id %}"
           class="px-4 py-2 bg-light-100 text-dark-700 rounded-lg text-sm font-medium hover:bg-light-200 transition-colors flex items-center gap-2">
            <i class="bi bi-arrow-left"></i>
            Back to Consumer Details
        </a>
        <button onclick="window.print()"
                class="btn-primary px-4 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 hover:shadow-lg transition-all duration-200">
            <i class="bi bi-printer-fill"></i>
            Print Statement
        </button>
    </div>

    <!-- Bill Statement (Printable) -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden" id="printable-statement">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-700 text-white px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="{% static 'consumers/images/logo.png' %}"
                         alt="Balilihan Waterworks Logo"
                         class="w-16 h-16 rounded-full border-4 border-white shadow-lg">
                    <div>
                        <h1 class="text-2xl font-bold mb-1">Balilihan Waterworks</h1>
                        <p class="text-sm text-white/80">Municipality of Balilihan, Bohol</p>
                        <p class="text-xs text-white/70 mt-1">Water Utility Billing Statement</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-white/70 mb-1">Statement Date</p>
                    <p class="text-lg font-semibold">{{ today|date:"F d, Y" }}</p>
                </div>
            </div>
        </div>

        <!-- Consumer Information -->
        <div class="px-8 py-6 border-b border-light-200 bg-light-50">
            <div class="grid grid-cols-2 gap-6">
                <!-- Left Column -->
                <div>
                    <h3 class="text-xs font-semibold text-dark-500 uppercase tracking-wide mb-3">Consumer Information</h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-xs text-dark-500">ID Number</p>
                            <p class="text-base font-bold text-primary-600 font-mono">{{ consumer.id_number }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Consumer Name</p>
                            <p class="text-base font-semibold text-dark-900">
                                {{ consumer.first_name }} {% if consumer.middle_name %}{{ consumer.middle_name|slice:":1" }}.{% endif %} {{ consumer.last_name }}
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Contact Number</p>
                            <p class="text-sm text-dark-700">{{ consumer.phone_number }}</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <h3 class="text-xs font-semibold text-dark-500 uppercase tracking-wide mb-3">Service Details</h3>
                    <div class="space-y-2">
                        <div>
                            <p class="text-xs text-dark-500">Location</p>
                            <p class="text-sm font-medium text-dark-900">{{ consumer.purok.name }}</p>
                            <p class="text-sm text-dark-700">{{ consumer.barangay.name }}, Balilihan</p>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500">Meter Serial Number</p>
                            <p class="text-sm font-mono text-dark-700">{{ consumer.serial_number }}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div>
                                <p class="text-xs text-dark-500">Status</p>
                                {% if consumer.status == 'active' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-success-100 text-success-700">
                                    <i class="bi bi-check-circle-fill mr-1"></i>Connected
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-danger-100 text-danger-700">
                                    <i class="bi bi-x-circle-fill mr-1"></i>Disconnected
                                </span>
                                {% endif %}
                            </div>
                            <div>
                                <p class="text-xs text-dark-500">Type</p>
                                {% if consumer.usage_type == "Commercial" %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-warning-100 text-warning-700">
                                    <i class="bi bi-building mr-1"></i>Commercial
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-info-100 text-info-700">
                                    <i class="bi bi-house mr-1"></i>Residential
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Year Filter Tabs (Hide on Print) -->
        <div class="px-8 pt-6 pb-3 print:hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-dark-900 flex items-center gap-2">
                    <i class="bi bi-receipt text-primary-600"></i>
                    Billing History
                </h3>
            </div>
            {% if available_years %}
            <div class="flex items-center gap-2 flex-wrap">
                <a href="{% url 'consumers:consumer_bill' consumer.id %}"
                   class="px-4 py-1.5 text-sm font-medium rounded-full transition-colors {% if not selected_year %}bg-primary-600 text-white shadow-sm{% else %}bg-light-100 text-dark-600 hover:bg-light-200{% endif %}">
                    All
                </a>
                {% for year in available_years %}
                <a href="{% url 'consumers:consumer_bill' consumer.id %}?year={{ year }}"
                   class="px-4 py-1.5 text-sm font-medium rounded-full transition-colors {% if selected_year == year|stringformat:'d' %}bg-primary-600 text-white shadow-sm{% else %}bg-light-100 text-dark-600 hover:bg-light-200{% endif %}">
                    {{ year }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Print-only title -->
        <div class="px-8 pt-6 pb-3 hidden print:block">
            <h3 class="text-lg font-bold text-dark-900 flex items-center gap-2">
                <i class="bi bi-receipt text-primary-600"></i>
                Billing History {% if selected_year %}({{ selected_year }}){% endif %}
            </h3>
        </div>

        <!-- Billing History Table -->
        <div class="px-8 pb-6">
            <div class="overflow-x-auto rounded-lg border border-light-200">
                <table class="w-full text-sm">
                    <thead class="bg-dark-900 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Billing Period</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">Due Date</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">Prev. Reading</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">Curr. Reading</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">Consumption (m³)</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider">Amount</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-light-200">
                        {% for bill in bills %}
                        <tr class="{% if bill.status == 'Overdue' %}bg-danger-50{% elif bill.status == 'Paid' %}bg-success-50/30{% else %}hover:bg-light-50{% endif %} transition-colors">
                            <td class="px-4 py-3">
                                <p class="font-semibold text-dark-900">{{ bill.billing_period|date:"F Y" }}</p>
                            </td>
                            <td class="px-4 py-3">
                                <p class="text-dark-700">{{ bill.due_date|date:"M d, Y" }}</p>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-mono text-dark-700">
                                    {% if bill.previous_reading %}{{ bill.previous_reading.reading_value }}{% else %}{{ consumer.first_reading }}{% endif %}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-mono text-dark-700">{{ bill.current_reading.reading_value }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-bold text-primary-600">{{ bill.consumption }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-bold text-dark-900">₱{{ bill.total_amount|floatformat:2|intcomma }}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if bill.status == 'Paid' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-success-100 text-success-700">
                                    <i class="bi bi-check-circle-fill mr-1"></i>Paid
                                </span>
                                {% elif bill.status == 'Overdue' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-danger-100 text-danger-700">
                                    <i class="bi bi-exclamation-triangle-fill mr-1"></i>Overdue
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-warning-100 text-warning-700">
                                    <i class="bi bi-clock-fill mr-1"></i>Pending
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center">
                                <div class="flex flex-col items-center justify-center text-dark-400">
                                    <i class="bi bi-inbox text-5xl mb-3 opacity-30"></i>
                                    <p class="text-base font-medium mb-1">No billing records found</p>
                                    <p class="text-sm">{% if selected_year %}No bills for {{ selected_year }}{% else %}This consumer has no billing history yet{% endif %}</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Section -->
        {% if bills %}
        <div class="px-8 py-6 border-t-2 border-light-200 bg-light-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Total Bills -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-file-earmark-text-fill text-primary-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Total Bills</p>
                            <p class="text-2xl font-bold text-dark-900">{{ bills|length }}</p>
                        </div>
                    </div>
                </div>

                <!-- Total Amount Billed -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-info-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-cash-stack text-info-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Total Billed</p>
                            <p class="text-2xl font-bold text-dark-900">₱{{ total_billed|floatformat:2|intcomma|default:"0.00" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Balance -->
                <div class="bg-white rounded-lg border border-light-300 p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-100 rounded-lg flex items-center justify-center">
                            <i class="bi bi-{% if outstanding_balance > 0 %}exclamation-circle{% else %}check-circle{% endif %}-fill text-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs text-dark-500 uppercase">Outstanding</p>
                            <p class="text-2xl font-bold text-{% if outstanding_balance > 0 %}danger{% else %}success{% endif %}-600">
                                ₱{{ outstanding_balance|floatformat:2|intcomma|default:"0.00" }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Service History Section -->
        <div class="px-8 py-6 border-t-2 border-light-200">
            <h3 class="text-base font-bold text-dark-900 mb-4 flex items-center gap-2">
                <i class="bi bi-clock-history text-dark-500"></i>
                Service History
            </h3>

            <!-- Current Status -->
            <div class="mb-4 p-3 rounded-lg border {% if consumer.status == 'active' %}bg-success-50 border-success-200{% else %}bg-danger-50 border-danger-200{% endif %}">
                <div class="flex items-center gap-3">
                    {% if consumer.status == 'active' %}
                    <div class="w-8 h-8 bg-success-200 rounded-full flex items-center justify-center">
                        <i class="bi bi-plug-fill text-success-700 text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-success-800">Currently Connected</p>
                        <p class="text-xs text-success-600">Service is active since {{ consumer.registration_date|date:"M d, Y" }}</p>
                    </div>
                    {% else %}
                    <div class="w-8 h-8 bg-danger-200 rounded-full flex items-center justify-center">
                        <i class="bi bi-plug-fill text-danger-700 text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-danger-800">Currently Disconnected</p>
                        {% if consumer.disconnect_reason %}
                        <p class="text-xs text-danger-600">Reason: {{ consumer.disconnect_reason }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Service Events Timeline -->
            {% if service_history %}
            <div class="space-y-0">
                {% for event in service_history %}
                <div class="flex items-start gap-3 relative">
                    <!-- Timeline Line -->
                    {% if not forloop.last %}
                    <div class="absolute left-[15px] top-8 bottom-0 w-px bg-light-300"></div>
                    {% endif %}
                    <!-- Icon -->
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 z-10
                        {% if event.action == 'consumer_disconnected' %}bg-danger-100{% else %}bg-success-100{% endif %}">
                        {% if event.action == 'consumer_disconnected' %}
                        <i class="bi bi-x-circle-fill text-danger-600 text-xs"></i>
                        {% else %}
                        <i class="bi bi-check-circle-fill text-success-600 text-xs"></i>
                        {% endif %}
                    </div>
                    <!-- Content -->
                    <div class="pb-4 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-sm font-semibold {% if event.action == 'consumer_disconnected' %}text-danger-700{% else %}text-success-700{% endif %}">
                                {% if event.action == 'consumer_disconnected' %}Disconnected{% else %}Reconnected{% endif %}
                            </span>
                            <span class="text-xs text-dark-400">{{ event.created_at|date:"M d, Y - h:i A" }}</span>
                        </div>
                        <p class="text-xs text-dark-500 mt-0.5">{{ event.description }}</p>
                        {% if event.user %}
                        <p class="text-xs text-dark-400 mt-0.5">By: {{ event.user.get_full_name|default:event.user.username }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6 text-dark-400">
                <i class="bi bi-shield-check text-3xl mb-2 opacity-30 block"></i>
                <p class="text-sm">No disconnection or reconnection events recorded</p>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="px-8 py-6 border-t border-light-200 bg-white">
            <div class="text-center space-y-2">
                <p class="text-xs text-dark-500">
                    <i class="bi bi-info-circle mr-1"></i>
                    For inquiries and concerns, please contact the Balilihan Waterworks Office
                </p>
                <p class="text-xs text-dark-400">
                    This is a computer-generated statement. Generated on {{ today|date:"F d, Y h:i A" }}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Print Styles -->
<style>
@media print {
    .print\:hidden { display: none !important; }
    .print\:block { display: block !important; }
    @page { size: A4; margin: 1cm; }
    body { background: white; }
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; page-break-after: auto; }
    thead { display: table-header-group; }
    .shadow-lg, .shadow-md, .shadow-sm { box-shadow: none !important; }
    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .rounded-lg { border-radius: 0 !important; }
}
</style>
{% endblock %}

