{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}User Management{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="bi bi-people-fill text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-dark-900">User Management</h2>
                    <p class="text-dark-500 text-sm mt-0.5">Manage system users, roles, and permissions</p>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="/admin/" target="_blank" class="inline-flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-dark-700 to-dark-800 text-white text-sm font-medium rounded-xl hover:from-dark-800 hover:to-dark-900 transition-all duration-200 shadow-md hover:shadow-lg">
                    <i class="bi bi-gear-wide-connected"></i>
                    Django Admin
                </a>
                <button onclick="openModal('createUserModal')" class="inline-flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-primary-500 to-primary-600 text-white text-sm font-medium rounded-xl hover:from-primary-600 hover:to-primary-700 transition-all duration-200 shadow-md hover:shadow-lg">
                    <i class="bi bi-person-plus-fill"></i>
                    Create User
                </button>
                <a href="{% url 'consumers:home' %}" class="inline-flex items-center gap-2 px-4 py-2.5 bg-light-100 hover:bg-light-200 text-dark-700 text-sm font-medium rounded-xl transition-all duration-200 shadow-sm">
                    <i class="bi bi-arrow-left"></i>
                    Back
                </a>
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
    <div class="mb-6 space-y-2">
        {% for message in messages %}
        <div class="flex items-center justify-between p-4 rounded-lg border-l-4 {% if message.tags == 'success' %}bg-success-50 border-success-500 text-success-900{% elif message.tags == 'error' %}bg-danger-50 border-danger-500 text-danger-900{% elif message.tags == 'warning' %}bg-warning-50 border-warning-500 text-warning-900{% else %}bg-info-50 border-info-500 text-info-900{% endif %} shadow-sm">
            <div class="flex items-center gap-3">
                <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% elif message.tags == 'error' %}bi-x-circle-fill{% elif message.tags == 'warning' %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %} text-xl"></i>
                <span class="text-sm font-medium">{{ message }}</span>
            </div>
            <button onclick="this.parentElement.remove()" class="text-dark-500 hover:text-dark-700 transition-colors">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Security Notice -->
    <div class="mb-6 px-4 py-3 rounded-lg border bg-warning-50 border-warning-200 text-warning-800">
        <div class="flex items-start gap-2">
            <i class="bi bi-shield-exclamation text-lg"></i>
            <div class="text-sm">
                <strong class="font-semibold">Security Notice:</strong> You are in a restricted administrative area. All actions are being logged.
                Use <strong>Django Admin</strong> for advanced system configuration.
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Users -->
        <div class="bg-white rounded-xl border border-light-200 shadow-sm p-5 hover:shadow-lg transition-all duration-300 group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wider mb-2">Total Users</p>
                    <p class="text-3xl font-bold text-dark-900">{{ total_users }}</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-primary-100 to-primary-200 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                    <i class="bi bi-people-fill text-2xl text-primary-600"></i>
                </div>
            </div>
        </div>

        <!-- Active Users -->
        <div class="bg-white rounded-xl border border-light-200 shadow-sm p-5 hover:shadow-lg transition-all duration-300 group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wider mb-2">Active Users</p>
                    <p class="text-3xl font-bold text-success-600">{{ active_users }}</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-success-100 to-success-200 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                    <i class="bi bi-check-circle-fill text-2xl text-success-600"></i>
                </div>
            </div>
        </div>

        <!-- Staff Members -->
        <div class="bg-white rounded-xl border border-light-200 shadow-sm p-5 hover:shadow-lg transition-all duration-300 group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wider mb-2">Staff Members</p>
                    <p class="text-3xl font-bold text-info-600">{{ staff_users }}</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-info-100 to-info-200 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                    <i class="bi bi-person-badge-fill text-2xl text-info-600"></i>
                </div>
            </div>
        </div>

        <!-- Superusers -->
        <div class="bg-white rounded-xl border border-light-200 shadow-sm p-5 hover:shadow-lg transition-all duration-300 group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-dark-500 uppercase tracking-wider mb-2">Superusers</p>
                    <p class="text-3xl font-bold text-warning-600">{{ superusers }}</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-warning-100 to-warning-200 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                    <i class="bi bi-shield-fill-check text-2xl text-warning-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg border border-light-300 shadow-sm p-5 mb-6">
        <form method="GET" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-xs font-medium text-dark-700 mb-1">Search</label>
                <input type="text" name="search" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Username, name, or email..." value="{{ search_query }}">
            </div>
            <div>
                <label class="block text-xs font-medium text-dark-700 mb-1">Role</label>
                <select name="role" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <option value="">All Roles</option>
                    <option value="superuser" {% if role_filter == 'superuser' %}selected{% endif %}>Superuser</option>
                    <option value="staff" {% if role_filter == 'staff' %}selected{% endif %}>Staff</option>
                    <option value="regular" {% if role_filter == 'regular' %}selected{% endif %}>Regular</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-dark-700 mb-1">Status</label>
                <select name="status" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded hover:bg-primary-700 transition-colors">
                    <i class="bi bi-funnel-fill mr-1"></i>Filter
                </button>
            </div>
        </form>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-lg border border-light-300 shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-light-50 border-b border-light-200">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-dark-700">Username</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-dark-700">Full Name</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-dark-700">Email</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-dark-700">Role</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-dark-700">Barangay</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-dark-700">Status</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-dark-700">Logins</th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-dark-700">Joined</th>
                        <th class="px-4 py-3 text-center text-xs font-semibold text-dark-700">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-light-200">
                    {% for user in users %}
                    <tr class="hover:bg-light-50">
                        <td class="px-4 py-3 font-semibold text-dark-900">{{ user.username }}</td>
                        <td class="px-4 py-3 text-dark-700">{{ user.get_full_name|default:"—" }}</td>
                        <td class="px-4 py-3 text-dark-700">{{ user.email|default:"—" }}</td>
                        <td class="px-4 py-3">
                            {% if user.is_superuser or user.staffprofile.role == 'superadmin' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-danger-100 text-danger-800">
                                <i class="bi bi-shield-fill-check mr-1"></i>Superadmin
                            </span>
                            {% elif user.staffprofile and user.staffprofile.role == 'cashier' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-success-100 text-success-800">
                                <i class="bi bi-cash-coin mr-1"></i>Cashier
                            </span>
                            {% elif user.staffprofile and user.staffprofile.role == 'field_staff' %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-info-100 text-info-800">
                                <i class="bi bi-geo-alt-fill mr-1"></i>Field Staff
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-light-200 text-dark-700">
                                <i class="bi bi-person-badge-fill mr-1"></i>Staff
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-dark-700">
                            {% if user.staffprofile %}
                            {{ user.staffprofile.assigned_barangay.name }}
                            {% else %}
                            <span class="text-dark-400">—</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center">
                            {% if user.is_active %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-success-100 text-success-800">Active</span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-danger-100 text-danger-800">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-center text-dark-700">{{ user.login_count }}</td>
                        <td class="px-4 py-3 text-dark-700">{{ user.date_joined|date:"M d, Y" }}</td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <button onclick="openEditModal({{ user.id }})" class="px-2 py-1 border border-primary-300 text-primary-700 text-xs font-medium rounded hover:bg-primary-50 transition-colors" title="Edit User">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button onclick="openResetPasswordModal({{ user.id }})" class="px-2 py-1 border border-warning-300 text-warning-700 text-xs font-medium rounded hover:bg-warning-50 transition-colors" title="Reset Password">
                                    <i class="bi bi-key-fill"></i>
                                </button>
                                {% if user != request.user %}
                                <button onclick="confirmDeleteUser('{{ user.id }}', '{{ user.username }}')" class="px-2 py-1 border border-danger-300 text-danger-700 text-xs font-medium rounded hover:bg-danger-50 transition-colors" title="Delete User">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                    <!-- Edit User Modal (Hidden by default) -->
                    <div id="editUserModal{{ user.id }}" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center overflow-y-auto py-10">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                            <div class="px-5 py-3 bg-primary-600 text-white rounded-t-lg flex items-center justify-between">
                                <h3 class="text-sm font-semibold"><i class="bi bi-pencil-fill mr-2"></i>Edit User: {{ user.username }}</h3>
                                <button onclick="closeModal('editUserModal{{ user.id }}')" class="text-white hover:text-light-200">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <form method="POST" action="{% url 'consumers:edit_user' user.id %}">
                                {% csrf_token %}
                                <div class="px-5 py-4">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-medium text-dark-700 mb-1">First Name</label>
                                            <input type="text" name="first_name" value="{{ user.first_name }}" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-dark-700 mb-1">Last Name</label>
                                            <input type="text" name="last_name" value="{{ user.last_name }}" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        </div>
                                        <div class="sm:col-span-2">
                                            <label class="block text-xs font-medium text-dark-700 mb-1">Email</label>
                                            <input type="email" name="email" value="{{ user.email }}" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-dark-700 mb-1">Assigned Barangay</label>
                                            <select name="assigned_barangay" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                                                <option value="">None</option>
                                                {% for barangay in barangays %}
                                                <option value="{{ barangay.id }}" {% if user.staffprofile and user.staffprofile.assigned_barangay.id == barangay.id %}selected{% endif %}>
                                                    {{ barangay.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-dark-700 mb-1">Role</label>
                                            <select name="role" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                                                <option value="field_staff" {% if user.staffprofile and user.staffprofile.role == 'field_staff' %}selected{% endif %}>Field Staff</option>
                                                <option value="cashier" {% if user.staffprofile and user.staffprofile.role == 'cashier' %}selected{% endif %}>Cashier</option>
                                                <option value="superadmin" {% if user.staffprofile and user.staffprofile.role == 'superadmin' %}selected{% endif %}>Superadmin</option>
                                            </select>
                                        </div>
                                        <div class="sm:col-span-2 space-y-2">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="is_staff" {% if user.is_staff %}checked{% endif %} class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                                                <span class="text-sm text-dark-700">Staff Status</span>
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="is_superuser" {% if user.is_superuser %}checked{% endif %} class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                                                <span class="text-sm text-dark-700">Superuser Status</span>
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" name="is_active" {% if user.is_active %}checked{% endif %} class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                                                <span class="text-sm text-dark-700">Active Status</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-5 py-3 bg-light-50 rounded-b-lg flex items-center justify-end gap-2">
                                    <button type="button" onclick="closeModal('editUserModal{{ user.id }}')" class="px-4 py-2 border border-light-400 text-dark-700 text-sm font-medium rounded hover:bg-light-100 transition-colors">Cancel</button>
                                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded hover:bg-primary-700 transition-colors">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Reset Password Modal -->
                    <div id="resetPasswordModal{{ user.id }}" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                            <div class="px-5 py-3 bg-warning-600 text-white rounded-t-lg flex items-center justify-between">
                                <h3 class="text-sm font-semibold"><i class="bi bi-key-fill mr-2"></i>Reset Password: {{ user.username }}</h3>
                                <button onclick="closeModal('resetPasswordModal{{ user.id }}')" class="text-white hover:text-light-200">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <form method="POST" action="{% url 'consumers:reset_user_password' user.id %}">
                                {% csrf_token %}
                                <div class="px-5 py-4">
                                    <div class="mb-4 p-3 bg-warning-50 border-l-4 border-warning-500 rounded">
                                        <p class="text-xs text-warning-800">
                                            <i class="bi bi-exclamation-triangle-fill mr-1"></i>
                                            Password must be at least 8 characters and contain uppercase, lowercase, and numbers.
                                        </p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="block text-xs font-medium text-dark-700 mb-1">New Password</label>
                                        <div class="relative">
                                            <input type="password" name="new_password" id="new_password_{{ user.id }}" required class="w-full px-3 py-2 pr-10 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-warning-500">
                                            <button type="button" onclick="togglePassword('new_password_{{ user.id }}')" class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-400 hover:text-dark-600">
                                                <i class="bi bi-eye" id="new_password_{{ user.id }}-icon"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-dark-700 mb-1">Confirm Password</label>
                                        <div class="relative">
                                            <input type="password" name="confirm_password" id="confirm_password_{{ user.id }}" required class="w-full px-3 py-2 pr-10 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-warning-500">
                                            <button type="button" onclick="togglePassword('confirm_password_{{ user.id }}')" class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-400 hover:text-dark-600">
                                                <i class="bi bi-eye" id="confirm_password_{{ user.id }}-icon"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="px-5 py-3 bg-light-50 rounded-b-lg flex items-center justify-end gap-2">
                                    <button type="button" onclick="closeModal('resetPasswordModal{{ user.id }}')" class="px-4 py-2 border border-light-400 text-dark-700 text-sm font-medium rounded hover:bg-light-100 transition-colors">Cancel</button>
                                    <button type="submit" class="px-4 py-2 bg-warning-600 text-white text-sm font-medium rounded hover:bg-warning-700 transition-colors">Reset Password</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center">
                            <i class="bi bi-inbox text-6xl text-light-300 block mb-2"></i>
                            <p class="text-sm text-dark-400">No users found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if users.has_other_pages %}
        <div class="px-5 py-3 bg-light-50 border-t border-light-200">
            <nav class="flex justify-center">
                <ul class="flex items-center gap-1">
                    {% if users.has_previous %}
                    <li><a href="?page={{ users.previous_page_number }}&search={{ search_query }}&role={{ role_filter }}&status={{ status_filter }}" class="px-3 py-1 text-sm border border-light-300 rounded hover:bg-light-100">Previous</a></li>
                    {% endif %}

                    {% for num in users.paginator.page_range %}
                    {% if users.number == num %}
                    <li><span class="px-3 py-1 text-sm bg-primary-600 text-white rounded">{{ num }}</span></li>
                    {% elif num > users.number|add:'-3' and num < users.number|add:'3' %}
                    <li><a href="?page={{ num }}&search={{ search_query }}&role={{ role_filter }}&status={{ status_filter }}" class="px-3 py-1 text-sm border border-light-300 rounded hover:bg-light-100">{{ num }}</a></li>
                    {% endif %}
                    {% endfor %}

                    {% if users.has_next %}
                    <li><a href="?page={{ users.next_page_number }}&search={{ search_query }}&role={{ role_filter }}&status={{ status_filter }}" class="px-3 py-1 text-sm border border-light-300 rounded hover:bg-light-100">Next</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create User Modal -->
<div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center overflow-y-auto py-10">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4">
        <div class="px-5 py-3 bg-primary-600 text-white rounded-t-lg flex items-center justify-between">
            <h3 class="text-sm font-semibold"><i class="bi bi-person-plus-fill mr-2"></i>Create New User</h3>
            <button onclick="closeModal('createUserModal')" class="text-white hover:text-light-200">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <form method="POST" action="{% url 'consumers:create_user' %}" id="createUserForm">
            {% csrf_token %}
            <div class="px-5 py-4">
                <div class="mb-4 p-3 bg-info-50 border-l-4 border-info-500 rounded">
                    <p class="text-xs text-info-800">
                        <i class="bi bi-info-circle-fill mr-1"></i>
                        Password must be at least 8 characters and contain uppercase, lowercase, and numbers.
                    </p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">Username <span class="text-danger-600">*</span></label>
                        <input type="text" name="username" required class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">Email</label>
                        <input type="email" name="email" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">First Name</label>
                        <input type="text" name="first_name" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">Last Name</label>
                        <input type="text" name="last_name" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">Password <span class="text-danger-600">*</span></label>
                        <div class="relative">
                            <input type="password" name="password" id="password" required class="w-full px-3 py-2 pr-10 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <button type="button" onclick="togglePassword('password')" class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-400 hover:text-dark-600">
                                <i class="bi bi-eye" id="password-icon"></i>
                            </button>
                        </div>
                        <div id="passwordStrength" class="mt-2 h-1 rounded-full bg-light-200"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">Confirm Password <span class="text-danger-600">*</span></label>
                        <div class="relative">
                            <input type="password" name="password_confirm" id="password_confirm" required class="w-full px-3 py-2 pr-10 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <button type="button" onclick="togglePassword('password_confirm')" class="absolute inset-y-0 right-0 px-3 flex items-center text-dark-400 hover:text-dark-600">
                                <i class="bi bi-eye" id="password_confirm-icon"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-700 mb-1">Role</label>
                        <select name="role" id="createUserRole" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500" onchange="toggleBarangayField()">
                            <option value="field_staff">Field Staff</option>
                            <option value="cashier">Cashier</option>
                            <option value="superadmin">Superadmin</option>
                        </select>
                    </div>
                    <div id="barangayFieldContainer">
                        <label class="block text-xs font-medium text-dark-700 mb-1">Assigned Barangay <span class="text-danger-600" id="barangayRequired">*</span></label>
                        <select name="assigned_barangay" id="createUserBarangay" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="">Select Barangay...</option>
                            {% for barangay in barangays %}
                            <option value="{{ barangay.id }}">{{ barangay.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-dark-500 mt-1">Required for Field Staff only</p>
                    </div>
                    <div class="sm:col-span-2 flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="is_staff" class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                            <span class="text-sm text-dark-700">Staff Status</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="is_superuser" class="w-4 h-4 text-primary-600 rounded focus:ring-primary-500">
                            <span class="text-sm text-dark-700">Superuser Status</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="px-5 py-3 bg-light-50 rounded-b-lg flex items-center justify-end gap-2">
                <button type="button" onclick="closeModal('createUserModal')" class="px-4 py-2 border border-light-400 text-dark-700 text-sm font-medium rounded hover:bg-light-100 transition-colors">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded hover:bg-primary-700 transition-colors">Create User</button>
            </div>
        </form>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// Toggle password visibility
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + '-icon');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function openEditModal(userId) {
    openModal('editUserModal' + userId);
}

function openResetPasswordModal(userId) {
    openModal('resetPasswordModal' + userId);
}

// Toggle barangay field based on role selection
function toggleBarangayField() {
    const role = document.getElementById('createUserRole').value;
    const barangayContainer = document.getElementById('barangayFieldContainer');
    const barangayRequired = document.getElementById('barangayRequired');
    const barangaySelect = document.getElementById('createUserBarangay');

    // Only field staff needs barangay assignment
    if (role === 'field_staff') {
        barangayContainer.style.opacity = '1';
        barangayRequired.style.display = 'inline';
        barangaySelect.setAttribute('required', 'required');
    } else {
        // Admin and Cashier don't need barangay
        barangayContainer.style.opacity = '0.5';
        barangayRequired.style.display = 'none';
        barangaySelect.removeAttribute('required');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleBarangayField();
});

// Password strength indicator
document.getElementById('password')?.addEventListener('input', function(e) {
    const password = e.target.value;
    const strengthDiv = document.getElementById('passwordStrength');

    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;

    strengthDiv.className = 'mt-2 h-1 rounded-full transition-all';
    if (strength === 0) {
        strengthDiv.classList.add('bg-light-200');
    } else if (strength === 1) {
        strengthDiv.classList.add('bg-danger-500');
        strengthDiv.style.width = '33%';
    } else if (strength === 2) {
        strengthDiv.classList.add('bg-warning-500');
        strengthDiv.style.width = '66%';
    } else if (strength === 3) {
        strengthDiv.classList.add('bg-success-500');
        strengthDiv.style.width = '100%';
    }
});

// Delete user confirmation
async function confirmDeleteUser(userId, username) {
    const result = await Swal.fire({
        title: 'Delete User?',
        html: `
            <div class="text-start">
                <div class="p-3 bg-danger-50 border-l-4 border-danger-500 rounded mb-3">
                    <p class="text-sm text-danger-800">
                        <i class="bi bi-exclamation-triangle-fill mr-1"></i>
                        <strong>Warning!</strong> This action cannot be undone.
                    </p>
                </div>
                <p class="text-sm">Are you sure you want to delete user <strong>${username}</strong>?</p>
                <p class="text-xs text-gray-500 mt-1">All associated data will be permanently removed.</p>
            </div>
        `,
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '<i class="bi bi-trash-fill mr-1"></i> Delete User',
        cancelButtonText: 'Cancel',
        focusCancel: true
    });

    if (result.isConfirmed) {
        Swal.fire({
            title: 'Deleting user...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/user/${userId}/delete/`;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// Close modals on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('[id$="Modal"]').forEach(modal => {
            modal.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}
