<!-- consumers/templates/consumers/home.html -->
{% extends "consumers/base.html" %}
{% load humanize %}

{% block title %}Staff Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* === Modern Typography & Base === */
    body {
        font-family: 'Segoe UI', system-ui, -apple-system, 'Helvetica Neue', Arial, sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        overflow-x: hidden;
    }

    /* === Dashboard Header === */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
        position: relative;
        overflow: hidden;
    }
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        z-index: 0;
    }
    .dashboard-header > * {
        position: relative;
        z-index: 1;
    }
    .dashboard-header h2 {
        font-weight: 700;
        font-size: 1.5rem;
        letter-spacing: -0.02em;
        margin-bottom: 0.25rem;
    }
    .dashboard-header p {
        opacity: 0.95;
        font-size: 0.9rem;
        margin-bottom: 0;
    }

    /* === Stat Cards === */
    .stat-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        border: 1px solid #f0f0f0;
        height: 100%;
    }
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
    }
    .stat-card.connected::before {
        background: linear-gradient(90deg, #10b981, #059669);
    }
    .stat-card.disconnected::before {
        background: linear-gradient(90deg, #ef4444, #dc2626);
    }
    .stat-card.delinquent::before {
        background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .stat-icon {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        transition: transform 0.3s ease;
    }
    .stat-card:hover .stat-icon {
        transform: scale(1.1);
    }
    .stat-card.connected .stat-icon {
        color: #10b981;
        filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.3));
    }
    .stat-card.disconnected .stat-icon {
        color: #ef4444;
        filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
    }
    .stat-card.delinquent .stat-icon {
        color: #f59e0b;
        filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.3));
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 800;
        line-height: 1.1;
        color: #1e293b;
        margin-bottom: 0.25rem;
        background: linear-gradient(135deg, #1e293b, #475569);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 600;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .stat-actions .btn {
        padding: 0.4rem 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .stat-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }

    /* === Report Filter === */
    .report-filter {
        background: white;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        border: 1px solid #f0f0f0;
    }
    .report-filter h5 {
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    .report-filter h5 i {
        color: #667eea;
        font-size: 1.1rem;
    }
    .input-group-text {
        background: #f8fafc;
        border-color: #e2e8f0;
        color: #475569;
        font-weight: 600;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    .form-control, .form-select {
        border-color: #e2e8f0;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.375rem;
    }

    /* === Table Card === */
    .table-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        margin-bottom: 1rem;
        border: 1px solid #f0f0f0;
        overflow: hidden;
        max-height: calc(100vh - 480px);
        display: flex;
        flex-direction: column;
    }
    .table-card-header {
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem;
        flex-shrink: 0;
    }
    .table-card-header h5 {
        font-weight: 700;
        margin: 0;
        font-size: 1rem;
    }
    .btn-group .btn {
        padding: 0.375rem 0.875rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    .btn-group .btn:hover {
        transform: translateY(-1px);
    }

    .table {
        margin-bottom: 0;
        font-size: 0.875rem;
    }
    .table th,
    .table td {
        vertical-align: middle;
        padding: 0.5rem 0.75rem;
    }
    .table thead th {
        font-weight: 700;
        color: #1e293b;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
    }
    .table tbody td {
        color: #475569;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.8rem;
    }
    .table tbody tr:hover {
        background-color: #fafbfc;
    }
    .table tbody tr {
        transition: background-color 0.2s ease;
    }
    .badge {
        font-weight: 600;
        padding: 0.25em 0.6em;
        font-size: 0.7em;
        border-radius: 6px;
    }

    /* Table Footer */
    .table tfoot td {
        font-weight: 800;
        font-size: 0.9rem;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-top: 2px solid #667eea;
        color: #1e293b;
        padding: 0.75rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: #94a3b8;
    }
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
        color: #cbd5e1;
    }
    .empty-state h5 {
        color: #64748b;
        font-weight: 600;
        margin-bottom: 0.375rem;
        font-size: 1rem;
    }
    .empty-state p {
        color: #94a3b8;
        margin: 0;
        font-size: 0.875rem;
    }

    /* === Summary Stats === */
    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .summary-stat-box {
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border-left: 3px solid #667eea;
        transition: all 0.3s ease;
    }
    .summary-stat-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .summary-stat-box h6 {
        color: #64748b;
        font-size: 0.7rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .summary-stat-box .value {
        font-size: 1.25rem;
        font-weight: 800;
        color: #1e293b;
    }

    /* Print-only header (hidden on screen) */
    .print-only {
        display: none;
    }

    /* === Print Styles === */
    @media print {
        /* Reset body and background */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        body {
            background: white !important;
            color: black !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Show print-only header */
        .print-only {
            display: block !important;
        }

        .print-header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 3px solid #000;
        }

        .print-header h1 {
            font-size: 20pt;
            font-weight: bold;
            margin: 0 0 5px 0;
            color: #000;
        }

        .print-header p {
            font-size: 11pt;
            margin: 2px 0;
            color: #000;
        }

        /* === HIDE ALL UI ELEMENTS === */
        /* Hide navigation and layout elements */
        .sidebar,
        #sidebar,
        .navbar,
        .main-content > *:not(.container-fluid),
        nav,
        header,
        footer {
            display: none !important;
        }

        /* Hide all interactive elements */
        .btn,
        .btn-group,
        button,
        .no-print,
        .stat-actions {
            display: none !important;
        }

        /* Hide dashboard and filter sections */
        .dashboard-header,
        .report-filter,
        .stat-card,
        .summary-stats,
        .row.g-4,
        .row.mb-4 {
            display: none !important;
        }

        /* Hide icons in table header */
        .table-card-header i,
        .bi,
        i {
            display: none !important;
        }

        /* === LAYOUT ADJUSTMENTS === */
        /* Remove all margins and padding from containers */
        html,
        body,
        .main-content,
        #main-content {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: auto !important;
            min-height: 0 !important;
            overflow: visible !important;
        }

        .container-fluid {
            max-width: 100% !important;
            width: 100% !important;
            padding: 15px !important;
            margin: 0 !important;
        }

        /* Only show the print header and table card */
        .container-fluid > * {
            display: none !important;
        }

        .container-fluid > .print-only,
        .container-fluid > .table-card {
            display: block !important;
        }

        /* === TABLE STYLING (Excel-like) === */
        .table-card {
            page-break-inside: auto;
            box-shadow: none !important;
            border: 2px solid #000;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            background: white !important;
        }

        .table-card-header {
            background: #e0e0e0 !important;
            color: black !important;
            border-bottom: 2px solid #000;
            padding: 10px 15px !important;
            text-align: center;
        }

        .table-card-header h5 {
            color: black !important;
            font-size: 16pt !important;
            font-weight: bold !important;
            margin: 0 !important;
        }

        /* Card body - remove scroll and constraints */
        .card-body {
            max-height: none !important;
            overflow: visible !important;
            padding: 0 !important;
            height: auto !important;
        }

        .table-responsive {
            overflow: visible !important;
            max-height: none !important;
        }

        /* Table styling - Excel-like borders */
        .table {
            width: 100% !important;
            margin: 0 !important;
            border-collapse: collapse !important;
            color: black !important;
        }

        .table thead {
            display: table-header-group;
        }

        .table th {
            background: #d9d9d9 !important;
            color: black !important;
            border: 1px solid #000 !important;
            padding: 8px 6px !important;
            font-size: 9pt !important;
            font-weight: bold !important;
            text-align: left !important;
        }

        .table td {
            border: 1px solid #000 !important;
            padding: 6px !important;
            color: black !important;
            font-size: 9pt !important;
            background: white !important;
        }

        .table td.text-end,
        .table th.text-end {
            text-align: right !important;
        }

        .table td.text-center,
        .table th.text-center {
            text-align: center !important;
        }

        /* Footer row (totals) */
        .table tfoot {
            display: table-footer-group;
        }

        .table tfoot td {
            background: #d9d9d9 !important;
            color: black !important;
            border: 2px solid #000 !important;
            font-weight: bold !important;
            font-size: 10pt !important;
            padding: 10px 6px !important;
        }

        /* Badge styling for print - show as text only */
        .badge {
            border: 1px solid #666 !important;
            color: black !important;
            background: white !important;
            padding: 2px 6px !important;
            font-size: 8pt !important;
            display: inline-block !important;
        }

        /* Remove hover effects */
        .table tbody tr:hover {
            background-color: white !important;
        }

        /* Empty state */
        .empty-state {
            padding: 20px !important;
            text-align: center;
        }

        .empty-state i {
            display: none !important;
        }

        .empty-state h5,
        .empty-state p {
            color: black !important;
        }

        /* Page settings for optimal printing */
        @page {
            margin: 1.5cm 1cm;
            size: landscape;
        }

        /* Prevent page breaks inside rows */
        .table tbody tr {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        /* Ensure thead repeats on each page */
        thead {
            display: table-header-group;
        }

        tfoot {
            display: table-footer-group;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header h2 {
            font-size: 1.5rem;
        }
        .stat-value {
            font-size: 2rem;
        }
        .table-card-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .btn-group {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
        }
        .btn-group .btn {
            flex: 1;
            min-width: 120px;
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container-fluid" style="padding: 1rem; max-height: calc(100vh - 40px); overflow-y: auto;">
    <!-- Print-only Header -->
    <div class="print-only print-header">
        <h1>BALILIHAN WATERWORKS</h1>
        <p>Delinquent Bills Report - {{ selected_month|date:"F" }} {{ selected_year }}</p>
        <p style="font-size: 10pt; margin-top: 5px;">Generated: {% now "F d, Y h:i A" %}</p>
    </div>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h2><i class="bi bi-speedometer2 me-2"></i>Staff Dashboard</h2>
        <p>Welcome, {{ request.user.get_full_name|default:request.user.username }}! Here's an overview of Balilihan Waterworks operations.</p>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-3">
        <!-- Connected Consumers -->
        <div class="col-lg-4 col-md-6 col-12">
            <div class="stat-card connected"
                 onclick="window.location.href='{% url 'consumers:connected_consumers' %}'">
                <div class="stat-icon"><i class="bi bi-droplet-fill"></i></div>
                <div class="stat-value">{{ connected_count }}</div>
                <div class="stat-label">Connected Consumers</div>
                <div class="stat-actions">
                    <a href="{% url 'consumers:connected_consumers' %}"
                       class="btn btn-success"
                       onclick="event.stopPropagation();">
                        <i class="bi bi-eye me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>

        <!-- Disconnected Consumers -->
        <div class="col-lg-4 col-md-6 col-12">
            <div class="stat-card disconnected"
                 onclick="window.location.href='{% url 'consumers:disconnected_consumers' %}'">
                <div class="stat-icon"><i class="bi bi-x-circle-fill"></i></div>
                <div class="stat-value">{{ disconnected_count }}</div>
                <div class="stat-label">Disconnected Consumers</div>
                <div class="stat-actions">
                    <a href="{% url 'consumers:disconnected_consumers' %}"
                       class="btn btn-danger"
                       onclick="event.stopPropagation();">
                        <i class="bi bi-eye me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>

        <!-- Delinquent Bills -->
        <div class="col-lg-4 col-md-6 col-12">
            <div class="stat-card delinquent"
                 onclick="window.location.href='{% url 'consumers:delinquent_consumers' %}'">
                <div class="stat-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                <div class="stat-value">{{ delinquent_count }}</div>
                <div class="stat-label">Delinquent Accounts</div>
                <div class="stat-actions">
                    <a href="{% url 'consumers:delinquent_consumers' %}"
                       class="btn btn-warning"
                       onclick="event.stopPropagation();">
                        <i class="bi bi-eye me-1"></i>View All
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Filter -->
    <div class="report-filter">
        <h5><i class="bi bi-funnel-fill"></i>Filter Delinquent Bills Report</h5>
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-6">
                <label for="month_year" class="form-label fw-semibold">
                    <i class="bi bi-calendar3 me-1"></i>Select Month & Year
                </label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                    <input type="month"
                           name="month_year"
                           id="month_year"
                           class="form-control"
                           value="{{ selected_year }}-{{ selected_month|stringformat:'02d' }}">
                </div>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-2"></i>Generate Report
                </button>
            </div>
            <div class="col-md-3">
                <a href="{% url 'consumers:home' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-clockwise me-2"></i>Reset
                </a>
            </div>
        </form>
    </div>

    <!-- Summary Statistics for Selected Period -->
    {% if delinquent_bills %}
    <div class="summary-stats">
        <div class="summary-stat-box">
            <h6><i class="bi bi-receipt me-1"></i>Total Bills</h6>
            <div class="value">{{ delinquent_bills.count }}</div>
        </div>
        <div class="summary-stat-box" style="border-left-color: #f59e0b;">
            <h6><i class="bi bi-currency-exchange me-1"></i>Total Amount Due</h6>
            <div class="value" style="color: #f59e0b;">₱{{ total_delinquent_amount|floatformat:2|intcomma }}</div>
        </div>
        <div class="summary-stat-box" style="border-left-color: #10b981;">
            <h6><i class="bi bi-calendar-month me-1"></i>Period</h6>
            <div class="value" style="font-size: 1.25rem;">{{ selected_month|date:"F" }} {{ selected_year }}</div>
        </div>
    </div>
    {% endif %}

    <!-- Delinquent Bills Table -->
    <div class="table-card">
        <div class="table-card-header">
            <h5>
                <i class="bi bi-table me-2"></i>
                Delinquent Bills - {{ selected_month|date:"F" }} {{ selected_year }}
            </h5>
            <div class="no-print">
                <a href="{% url 'consumers:export_report_excel' %}?report_type=delinquency&month_year={{ selected_year }}-{{ selected_month|stringformat:'02d' }}"
                   class="btn btn-success">
                    <i class="bi bi-file-earmark-excel-fill me-1"></i>Excel
                </a>
            </div>
        </div>
        <div class="card-body p-0" style="flex: 1; overflow-y: auto; max-height: calc(100vh - 520px);">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="sticky-top">
                        <tr>
                            <th>Account No.</th>
                            <th>Consumer Name</th>
                            <th>Barangay</th>
                            <th>Billing Period</th>
                            <th class="text-end">Amount Due</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in delinquent_bills %}
                        <tr>
                            <td><strong>{{ bill.consumer.account_number }}</strong></td>
                            <td>{{ bill.consumer.full_name }}</td>
                            <td>{{ bill.consumer.barangay.name|default:"N/A" }}</td>
                            <td>{{ bill.billing_period|date:"F Y" }}</td>
                            <td class="text-end"><strong>₱{{ bill.total_amount|floatformat:2|intcomma }}</strong></td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-clock-fill me-1"></i>Pending
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6">
                                <div class="empty-state">
                                    <i class="bi bi-clipboard-check-fill"></i>
                                    <h5>No Delinquent Bills Found</h5>
                                    <p>There are no pending bills for {{ selected_month|date:"F" }} {{ selected_year }}.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if delinquent_bills %}
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-end">
                                <i class="bi bi-calculator-fill me-2"></i>
                                <strong>TOTAL AMOUNT DUE:</strong>
                            </td>
                            <td class="text-end">
                                <strong style="color: #f59e0b; font-size: 1.25rem;">
                                    ₱{{ total_delinquent_amount|floatformat:2|intcomma }}
                                </strong>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form on month change (optional)
document.addEventListener('DOMContentLoaded', function() {
    const monthInput = document.getElementById('month_year');

    // Optional: Auto-submit when month changes
    // monthInput.addEventListener('change', function() {
    //     this.form.submit();
    // });

    // Add smooth scroll to table
    const tableBody = document.querySelector('.table-card .card-body');
    if (tableBody) {
        tableBody.style.scrollBehavior = 'smooth';
    }
});
</script>
{% endblock %}
