{% extends "consumers/base.html" %}
{% load humanize %}

{% block title %}Dashboard - Balilihan Waterworks{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header - Simple and Minimal -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-dark-900">Dashboard</h2>
        <p class="text-dark-500 text-sm">Overview of system metrics and recent activity</p>
    </div>

    <!-- Quick Stats - Compact 3-Column Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

        <!-- Connected Consumers -->
        <div class="card p-4 border-l-4 border-success-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="bi bi-check-circle-fill text-success-600 text-xl"></i>
                    <h3 class="text-xs font-semibold text-dark-600 uppercase tracking-wide">Connected</h3>
                </div>
            </div>
            <div class="flex items-baseline justify-between">
                <span class="text-3xl font-bold text-dark-900 metric-value">{{ connected_count|default:"0" }}</span>
                <a href="{% url 'consumers:connected_consumers' %}"
                   class="text-xs text-success-600 hover:text-success-700 font-medium">
                    View →
                </a>
            </div>
        </div>

        <!-- Disconnected Consumers -->
        <div class="card p-4 border-l-4 border-danger-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="bi bi-x-circle-fill text-danger-600 text-xl"></i>
                    <h3 class="text-xs font-semibold text-dark-600 uppercase tracking-wide">Disconnected</h3>
                </div>
            </div>
            <div class="flex items-baseline justify-between">
                <span class="text-3xl font-bold text-dark-900 metric-value">{{ disconnected_count|default:"0" }}</span>
                <a href="{% url 'consumers:disconnected_consumers' %}"
                   class="text-xs text-danger-600 hover:text-danger-700 font-medium">
                    View →
                </a>
            </div>
        </div>

        <!-- Delinquent Accounts -->
        <div class="card p-4 border-l-4 border-warning-500 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="bi bi-exclamation-triangle-fill text-warning-600 text-xl"></i>
                    <h3 class="text-xs font-semibold text-dark-600 uppercase tracking-wide">Delinquent</h3>
                </div>
            </div>
            <div class="flex items-baseline justify-between">
                <span class="text-3xl font-bold text-dark-900 metric-value">{{ delinquent_count|default:"0" }}</span>
                <a href="{% url 'consumers:delinquent_consumers' %}"
                   class="text-xs text-warning-600 hover:text-warning-700 font-medium">
                    View →
                </a>
            </div>
        </div>
    </div>

    <!-- Report Generation & Chart - 2 Column Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

        <!-- Report Generation Card -->
        <div class="card p-6">
            <h3 class="text-lg font-bold text-dark-900 mb-4 pb-3 border-b flex items-center gap-2">
                <i class="bi bi-file-earmark-spreadsheet text-primary-600"></i>
                Generate Report
            </h3>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="reportMonth" class="form-label">Month</label>
                    <select id="reportMonth" name="month" class="form-select">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div>
                    <label for="reportYear" class="form-label">Year</label>
                    <select id="reportYear" name="year" class="form-select">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
            </div>

            <button type="button" class="btn-primary w-full" onclick="generateExcelReport()">
                <i class="bi bi-download mr-2"></i>Download Excel Report
            </button>
        </div>

        <!-- Payment Status Chart -->
        <div class="card p-6">
            <h3 class="text-lg font-bold text-dark-900 mb-4 pb-3 border-b flex items-center gap-2">
                <i class="bi bi-pie-chart-fill text-primary-600"></i>
                Payment Status
            </h3>
            <div class="relative h-64 flex items-center justify-center">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Collections -->
    <div class="card p-6">
        <h3 class="text-lg font-bold text-dark-900 mb-4 pb-3 border-b flex items-center gap-2">
            <i class="bi bi-cash-coin text-success-600"></i>
            Recent Collections
        </h3>

        {% if recent_collections %}
        <div class="overflow-x-auto">
            <table class="table">
                <thead class="table-header">
                    <tr>
                        <th class="table-cell">Date</th>
                        <th class="table-cell text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for collection in recent_collections %}
                    <tr class="table-row">
                        <td class="table-cell">
                            <i class="bi bi-calendar-check text-primary-600 mr-2"></i>
                            {{ collection.date|date:"M d, Y" }}
                        </td>
                        <td class="table-cell text-right font-semibold text-success-600">
                            ₱{{ collection.amount|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-dark-400">
            <i class="bi bi-inbox text-4xl block mb-2 opacity-30"></i>
            <p class="text-sm font-medium">No recent collections</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current month and year
    const now = new Date();
    document.getElementById('reportMonth').value = now.getMonth() + 1;
    document.getElementById('reportYear').value = now.getFullYear();

    // Payment Status Chart - Minimal Style
    const ctx = document.getElementById('paymentChart').getContext('2d');

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Paid Bills', 'Pending Bills'],
            datasets: [{
                data: [{{ paid_bills|default:"0" }}, {{ pending_bills|default:"0" }}],
                backgroundColor: ['#10b981', '#f59e0b'],
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12, weight: '600' },
                        color: '#374151',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: '600' },
                    bodyFont: { size: 12 },
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' bills';
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });

    // Simple counter animation
    function animateValue(element, start, end, duration) {
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;

        const timer = setInterval(() => {
            current += increment;
            if (current >= end) {
                element.textContent = end;
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(current);
            }
        }, 16);
    }

    // Animate metric values
    document.querySelectorAll('.metric-value').forEach((el, index) => {
        const finalValue = parseInt(el.textContent) || 0;
        el.textContent = '0';
        setTimeout(() => {
            animateValue(el, 0, finalValue, 1000);
        }, 100 + (index * 100));
    });
});

// Generate Excel Report
function generateExcelReport() {
    const month = document.getElementById('reportMonth').value;
    const year = document.getElementById('reportYear').value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin mr-2"></i>Generating...';

    if (typeof showLoading === 'function') {
        showLoading(`Generating ${monthNames[month]} ${year} report...`);
    }

    setTimeout(() => {
        window.location.href = `/reports/delinquent/?month=${month}&year=${year}&export=excel`;

        if (typeof hideLoading === 'function') {
            hideLoading();
        }

        if (typeof showToast === 'function') {
            showToast('success', `${monthNames[month]} ${year} report downloaded!`, 3000);
        }

        btn.disabled = false;
        btn.innerHTML = originalText;
    }, 1500);
}
</script>
{% endblock %}
