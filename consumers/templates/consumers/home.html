{% extends "consumers/base.html" %}
{% load humanize %}

{% block title %}Dashboard - Balilihan Waterworks{% endblock %}

{% block main_content %}
<!-- Dashboard Wrapper with Gradient Background -->
<div class="min-h-screen bg-gradient-to-br from-primary-500 via-purple-500 to-secondary-500 -m-5 p-8">
    <div class="max-w-7xl mx-auto space-y-8">

        <!-- Dashboard Header Card -->
        <div class="glass bg-white/95 backdrop-blur-md rounded-2xl p-8 shadow-2xl text-center transform hover:scale-[1.02] transition-all duration-300">
            <h1 class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent mb-2">
                ðŸŒŠ Balilihan Waterworks
            </h1>
            <p class="text-dark-500 font-medium text-base md:text-lg">
                Real-time Management Dashboard - Monitor, Manage, Excel
            </p>
        </div>

        <!-- Main Dashboard Grid - 3 Metric Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Connected Consumers Card -->
            <div class="metric-card group bg-white/95 backdrop-blur-md rounded-2xl p-6 shadow-xl border-t-4 border-success-500 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300">
                <!-- Header -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-success-500 to-success-600 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-dark-500 uppercase tracking-wider">Connected</h3>
                    </div>
                </div>

                <!-- Metric Value -->
                <div class="text-6xl font-black text-dark-900 text-center my-6 metric-value">
                    {{ connected_count|default:"0" }}
                </div>

                <!-- Footer Button -->
                <div class="mt-6">
                    <a href="{% url 'consumers:connected_consumers' %}"
                       class="block w-full py-3 px-6 bg-gradient-to-r from-success-500 to-success-600 text-white font-bold text-sm rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-200 text-center">
                        <i class="bi bi-eye mr-2"></i>View All Details
                    </a>
                </div>
            </div>

            <!-- Disconnected Consumers Card -->
            <div class="metric-card group bg-white/95 backdrop-blur-md rounded-2xl p-6 shadow-xl border-t-4 border-danger-500 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300">
                <!-- Header -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-danger-500 to-danger-600 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-dark-500 uppercase tracking-wider">Disconnected</h3>
                    </div>
                </div>

                <!-- Metric Value -->
                <div class="text-6xl font-black text-dark-900 text-center my-6 metric-value">
                    {{ disconnected_count|default:"0" }}
                </div>

                <!-- Footer Button -->
                <div class="mt-6">
                    <a href="{% url 'consumers:disconnected_consumers' %}"
                       class="block w-full py-3 px-6 bg-gradient-to-r from-danger-500 to-danger-600 text-white font-bold text-sm rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-200 text-center">
                        <i class="bi bi-eye mr-2"></i>View All Details
                    </a>
                </div>
            </div>

            <!-- Delinquent Accounts Card -->
            <div class="metric-card group bg-white/95 backdrop-blur-md rounded-2xl p-6 shadow-xl border-t-4 border-warning-500 hover:shadow-2xl hover:-translate-y-2 transition-all duration-300">
                <!-- Header -->
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-warning-500 to-warning-600 rounded-2xl flex items-center justify-center text-white text-3xl shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <div>
                        <h3 class="text-xs font-bold text-dark-500 uppercase tracking-wider">Delinquent</h3>
                    </div>
                </div>

                <!-- Metric Value -->
                <div class="text-6xl font-black text-dark-900 text-center my-6 metric-value">
                    {{ delinquent_count|default:"0" }}
                </div>

                <!-- Footer Button -->
                <div class="mt-6">
                    <a href="{% url 'consumers:delinquent_consumers' %}"
                       class="block w-full py-3 px-6 bg-gradient-to-r from-warning-500 to-warning-600 text-white font-bold text-sm rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition-all duration-200 text-center">
                        <i class="bi bi-eye mr-2"></i>View All Details
                    </a>
                </div>
            </div>
        </div>

        <!-- Report Generation & Chart Section - 2 Column Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Report Generation Card -->
            <div class="bg-white/95 backdrop-blur-md rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
                <h3 class="flex items-center gap-3 text-xl font-extrabold text-dark-900 mb-6 pb-4 border-b-2 border-light-300">
                    <i class="bi bi-file-earmark-spreadsheet-fill text-2xl text-primary-600"></i>
                    Generate Monthly Report
                </h3>

                <!-- Form Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="reportMonth" class="block text-xs font-bold text-dark-700 uppercase tracking-wide mb-2">
                            ðŸ“… Select Month
                        </label>
                        <select id="reportMonth" name="month" class="form-select w-full">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportYear" class="block text-xs font-bold text-dark-700 uppercase tracking-wide mb-2">
                            ðŸ“† Select Year
                        </label>
                        <select id="reportYear" name="year" class="form-select w-full">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                        </select>
                    </div>
                </div>

                <!-- Generate Button -->
                <button type="button"
                        class="w-full py-4 px-6 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-extrabold text-base rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 uppercase tracking-wide"
                        onclick="generateExcelReport()">
                    <i class="bi bi-download mr-2 text-lg"></i>
                    Download Excel Report
                </button>
            </div>

            <!-- Payment Status Chart Card -->
            <div class="bg-white/95 backdrop-blur-md rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
                <h4 class="flex items-center gap-3 text-xl font-extrabold text-dark-900 mb-6 pb-4 border-b-2 border-light-300">
                    <i class="bi bi-pie-chart-fill text-2xl text-primary-600"></i>
                    Payment Status Overview
                </h4>

                <!-- Chart Container -->
                <div class="relative h-80 flex items-center justify-center">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Collections Card - Full Width -->
        <div class="bg-white/95 backdrop-blur-md rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
            <h4 class="flex items-center gap-3 text-xl font-extrabold text-dark-900 mb-6 pb-4 border-b-2 border-light-300">
                <i class="bi bi-cash-coin text-2xl text-success-600"></i>
                Recent Collections
            </h4>

            {% if recent_collections %}
            <!-- Collections Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto scrollbar-thin pr-2">
                {% for collection in recent_collections %}
                <div class="bg-gradient-to-br from-light-50 to-light-200 p-5 rounded-xl hover:-translate-y-1 hover:shadow-lg hover:border-primary-500 border-2 border-transparent transition-all duration-300">
                    <div class="flex items-center gap-2 text-dark-700 font-bold text-sm mb-3">
                        <i class="bi bi-calendar-check text-primary-600 text-lg"></i>
                        {{ collection.date|date:"M d, Y" }}
                    </div>
                    <div class="text-2xl font-black bg-gradient-to-r from-success-600 to-success-500 bg-clip-text text-transparent">
                        â‚±{{ collection.amount|floatformat:2|intcomma }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <i class="bi bi-inbox text-6xl text-dark-300 opacity-30 mb-4"></i>
                <p class="text-lg font-semibold text-dark-400">No recent collections to display</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current month and year
    const now = new Date();
    document.getElementById('reportMonth').value = now.getMonth() + 1;
    document.getElementById('reportYear').value = now.getFullYear();

    // Payment Status Chart
    const ctx = document.getElementById('paymentChart').getContext('2d');

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Paid Bills', 'Pending Bills'],
            datasets: [{
                data: [{{ paid_bills|default:"0" }}, {{ pending_bills|default:"0" }}],
                backgroundColor: ['#10b981', '#f59e0b'],
                borderWidth: 4,
                borderColor: '#ffffff',
                hoverOffset: 15,
                hoverBorderWidth: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: { size: 14, weight: '700', family: 'Inter' },
                        color: '#1e293b',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    padding: 16,
                    titleFont: { size: 16, weight: '700' },
                    bodyFont: { size: 14, weight: '600' },
                    cornerRadius: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' bills';
                        }
                    }
                }
            },
            cutout: '70%',
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
    });

    // Animate counter numbers
    function animateValue(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            element.textContent = Math.floor(easeOutQuart * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Animate all metric values with stagger
    document.querySelectorAll('.metric-value').forEach((el, index) => {
        const finalValue = parseInt(el.textContent) || 0;
        el.textContent = '0';
        setTimeout(() => {
            animateValue(el, 0, finalValue, 1500);
        }, 200 + (index * 150));
    });

    // Fade in cards with stagger
    const allCards = document.querySelectorAll('.metric-card, .bg-white\\/95');
    allCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 + (index * 100));
    });

    // Welcome notification
    setTimeout(() => {
        if (typeof showToast === 'function') {
            showToast('success', 'ðŸŽ‰ Welcome to your Dashboard! All systems operational.', 4000);
        }
    }, 800);
});

// Generate Excel Report Function
function generateExcelReport() {
    const month = document.getElementById('reportMonth').value;
    const year = document.getElementById('reportYear').value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Generating Report...';

    if (typeof showLoading === 'function') {
        showLoading(`ðŸ“Š Generating ${monthNames[month]} ${year} delinquent report...`);
    }

    setTimeout(() => {
        window.location.href = `/reports/delinquent/?month=${month}&year=${year}&export=excel`;

        if (typeof hideLoading === 'function') {
            hideLoading();
        }

        if (typeof showToast === 'function') {
            showToast('success', `âœ… ${monthNames[month]} ${year} report downloaded successfully!`, 4000);
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-download"></i> Download Excel Report';
    }, 2000);
}
</script>
{% endblock %}
