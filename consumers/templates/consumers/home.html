{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Dashboard - Balilihan Waterworks{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header with Welcome Message -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold text-dark-900">Welcome Back! ðŸ‘‹</h2>
                <p class="text-dark-500 text-sm mt-2">Here's what's happening with your water system today</p>
            </div>
            <div class="text-right">
                <div class="text-xs text-dark-500 uppercase tracking-wide font-medium">Current Date</div>
                <div class="text-sm font-semibold text-dark-900 mt-1">
                    <i class="bi bi-calendar-event text-primary-600 mr-1"></i>
                    {{ selected_date|date:"F d, Y" }}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats - 4-Column Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
        <!-- Connected Consumers -->
        <div class="group bg-gradient-to-br from-success-50 to-success-100 rounded-xl border border-success-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden">
            <div class="p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-success-500 rounded-lg flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-check-circle-fill text-white text-2xl"></i>
                    </div>
                    <a href="{% url 'consumers:connected_consumers' %}"
                       class="text-xs text-success-700 hover:text-success-900 font-semibold transition-colors flex items-center gap-1">
                        View <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                <h3 class="text-xs font-bold text-success-700 uppercase tracking-wider mb-1">Connected</h3>
                <div class="text-3xl font-extrabold text-success-900 metric-value">{{ connected_count|default:"0" }}</div>
                <div class="mt-2 text-xs text-success-600">Active consumers</div>
            </div>
            <div class="h-1 bg-gradient-to-r from-success-500 to-success-600"></div>
        </div>

        <!-- Disconnected Consumers -->
        <div class="group bg-gradient-to-br from-danger-50 to-danger-100 rounded-xl border border-danger-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden">
            <div class="p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-danger-500 rounded-lg flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-x-circle-fill text-white text-2xl"></i>
                    </div>
                    <a href="{% url 'consumers:disconnected_consumers' %}"
                       class="text-xs text-danger-700 hover:text-danger-900 font-semibold transition-colors flex items-center gap-1">
                        View <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                <h3 class="text-xs font-bold text-danger-700 uppercase tracking-wider mb-1">Disconnected</h3>
                <div class="text-3xl font-extrabold text-danger-900 metric-value">{{ disconnected_count|default:"0" }}</div>
                <div class="mt-2 text-xs text-danger-600">Inactive consumers</div>
            </div>
            <div class="h-1 bg-gradient-to-r from-danger-500 to-danger-600"></div>
        </div>

        <!-- Delinquent Accounts -->
        <div class="group bg-gradient-to-br from-warning-50 to-warning-100 rounded-xl border border-warning-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden">
            <div class="p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-warning-500 rounded-lg flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-exclamation-triangle-fill text-white text-2xl"></i>
                    </div>
                    <a href="{% url 'consumers:delinquent_consumers' %}"
                       class="text-xs text-warning-700 hover:text-warning-900 font-semibold transition-colors flex items-center gap-1">
                        View <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                <h3 class="text-xs font-bold text-warning-700 uppercase tracking-wider mb-1">Delinquent</h3>
                <div class="text-3xl font-extrabold text-warning-900 metric-value">{{ delinquent_count|default:"0" }}</div>
                <div class="mt-2 text-xs text-warning-600">Pending payments</div>
            </div>
            <div class="h-1 bg-gradient-to-r from-warning-500 to-warning-600"></div>
        </div>

        <!-- Total Bills -->
        <div class="group bg-gradient-to-br from-info-50 to-info-100 rounded-xl border border-info-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden">
            <div class="p-5">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 bg-info-500 rounded-lg flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <i class="bi bi-receipt-cutoff text-white text-2xl"></i>
                    </div>
                    <a href="{% url 'consumers:reports' %}"
                       class="text-xs text-info-700 hover:text-info-900 font-semibold transition-colors flex items-center gap-1">
                        View <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                <h3 class="text-xs font-bold text-info-700 uppercase tracking-wider mb-1">Total Bills</h3>
                <div class="text-3xl font-extrabold text-info-900 metric-value">{{ total_bills|default:"0" }}</div>
                <div class="mt-2 text-xs text-info-600">All billing records</div>
            </div>
            <div class="h-1 bg-gradient-to-r from-info-500 to-info-600"></div>
        </div>
    </div>

    <!-- Charts Section - 2 Column Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Monthly Revenue Bar Chart -->
        <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
            <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="bi bi-bar-chart-fill"></i>
                    Monthly Revenue Trend
                </h3>
                <p class="text-primary-100 text-xs mt-1">Last 6 months collections</p>
            </div>
            <div class="p-6">
                <div class="relative" style="height: 280px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Water Consumption Bar Chart -->
        <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
            <div class="bg-gradient-to-r from-info-500 to-info-600 px-6 py-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="bi bi-droplet-fill"></i>
                    Monthly Consumption
                </h3>
                <p class="text-info-100 text-xs mt-1">Water usage trends (mÂ³)</p>
            </div>
            <div class="p-6">
                <div class="relative" style="height: 280px;">
                    <canvas id="consumptionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Status & Report Generation -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Payment Status Doughnut Chart -->
        <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
            <div class="bg-gradient-to-r from-success-500 to-success-600 px-6 py-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="bi bi-pie-chart-fill"></i>
                    Payment Status Overview
                </h3>
                <p class="text-success-100 text-xs mt-1">Bill payment distribution</p>
            </div>
            <div class="p-6">
                <div class="relative" style="height: 280px;">
                    <canvas id="paymentChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="bg-success-50 rounded-lg p-3 text-center">
                        <div class="text-xs text-success-700 font-medium mb-1">Paid Bills</div>
                        <div class="text-2xl font-bold text-success-900">{{ paid_bills|default:"0" }}</div>
                    </div>
                    <div class="bg-warning-50 rounded-lg p-3 text-center">
                        <div class="text-xs text-warning-700 font-medium mb-1">Pending Bills</div>
                        <div class="text-2xl font-bold text-warning-900">{{ pending_bills|default:"0" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Generation Card -->
        <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="bi bi-file-earmark-spreadsheet"></i>
                    Generate Report
                </h3>
                <p class="text-purple-100 text-xs mt-1">Create delinquency reports</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-5">
                    <div>
                        <label for="reportMonth" class="block text-xs font-semibold text-dark-700 mb-2 uppercase tracking-wide">Month</label>
                        <select id="reportMonth" name="month" class="w-full px-3 py-2.5 text-sm border-2 border-light-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportYear" class="block text-xs font-semibold text-dark-700 mb-2 uppercase tracking-wide">Year</label>
                        <select id="reportYear" name="year" class="w-full px-3 py-2.5 text-sm border-2 border-light-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                        </select>
                    </div>
                </div>

                <button type="button"
                        class="w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2"
                        onclick="generateReport()">
                    <i class="bi bi-printer-fill"></i>
                    Generate Printable Report
                </button>

                <div class="mt-4 p-3 bg-light-50 rounded-lg border border-light-200">
                    <div class="flex items-start gap-2">
                        <i class="bi bi-info-circle text-info-600 text-sm mt-0.5"></i>
                        <p class="text-xs text-dark-600 leading-relaxed">
                            This will generate a detailed delinquency report for the selected period showing all pending bills.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Summary Table -->
    <div class="bg-white rounded-xl border border-light-300 shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden">
        <div class="bg-gradient-to-r from-success-500 to-success-600 px-6 py-4">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <i class="bi bi-cash-coin"></i>
                Monthly Revenue Summary
            </h3>
            <p class="text-success-100 text-xs mt-1">Recent payment collections breakdown</p>
        </div>
        <div class="p-6">
            {% if revenue_list %}
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-light-50 border-b-2 border-light-300">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-dark-700 uppercase tracking-wider">
                                <i class="bi bi-calendar3 mr-1 text-primary-600"></i>Period
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-bold text-dark-700 uppercase tracking-wider">
                                <i class="bi bi-currency-peso mr-1 text-success-600"></i>Revenue Collected
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-dark-700 uppercase tracking-wider">
                                <i class="bi bi-graph-up mr-1 text-info-600"></i>Status
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-light-200">
                        {% for label, amount in revenue_list %}
                        <tr class="hover:bg-light-50 transition-colors duration-150">
                            <td class="px-4 py-3 text-dark-900 font-medium">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
                                    {{ label }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="font-bold text-success-700 text-base">â‚±{{ amount|floatformat:2|intcomma }}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if amount > 0 %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-success-100 text-success-700">
                                    <i class="bi bi-check-circle-fill mr-1"></i>
                                    Collected
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-light-200 text-dark-600">
                                    <i class="bi bi-dash-circle mr-1"></i>
                                    No Data
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-light-100 border-t-2 border-light-300">
                        <tr>
                            <td class="px-4 py-4 text-left font-bold text-dark-900">
                                <i class="bi bi-calculator mr-2 text-primary-600"></i>
                                Total Revenue (Last 6 Months)
                            </td>
                            <td class="px-4 py-4 text-right">
                                <span class="text-xl font-extrabold text-success-700" id="totalRevenue">
                                    â‚±0.00
                                </span>
                            </td>
                            <td class="px-4 py-4"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12 text-dark-400">
                <i class="bi bi-inbox text-6xl block mb-3 opacity-20"></i>
                <p class="text-base font-semibold mb-1">No Revenue Data</p>
                <p class="text-xs">Revenue data will appear here once payments are collected</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current month and year
    const now = new Date();
    document.getElementById('reportMonth').value = now.getMonth() + 1;
    document.getElementById('reportYear').value = now.getFullYear();

    // Chart.js default configuration
    Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
    Chart.defaults.color = '#6b7280';

    // ===========================
    // 1. MONTHLY REVENUE BAR CHART
    // ===========================
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueLabels = {{ revenue_labels|safe }};
    const revenueData = {{ revenue_data|safe }};

    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: revenueLabels,
            datasets: [{
                label: 'Revenue (â‚±)',
                data: revenueData,
                backgroundColor: 'rgba(37, 99, 235, 0.8)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: { size: 13, weight: '600' },
                    bodyFont: { size: 14, weight: '700' },
                    callbacks: {
                        label: function(context) {
                            return 'â‚±' + context.parsed.y.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'â‚±' + value.toLocaleString();
                        },
                        font: { size: 11, weight: '600' },
                        color: '#6b7280'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11, weight: '600' },
                        color: '#374151'
                    },
                    grid: {
                        display: false,
                        drawBorder: false
                    }
                }
            }
        }
    });

    // ===========================
    // 2. WATER CONSUMPTION BAR CHART
    // ===========================
    const consumptionCtx = document.getElementById('consumptionChart').getContext('2d');
    const consumptionLabels = {{ consumption_labels|safe }};
    const consumptionData = {{ consumption_data|safe }};

    new Chart(consumptionCtx, {
        type: 'bar',
        data: {
            labels: consumptionLabels,
            datasets: [{
                label: 'Consumption (mÂ³)',
                data: consumptionData,
                backgroundColor: 'rgba(14, 165, 233, 0.8)',
                borderColor: 'rgba(14, 165, 233, 1)',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: { size: 13, weight: '600' },
                    bodyFont: { size: 14, weight: '700' },
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toLocaleString() + ' mÂ³';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' mÂ³';
                        },
                        font: { size: 11, weight: '600' },
                        color: '#6b7280'
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        font: { size: 11, weight: '600' },
                        color: '#374151'
                    },
                    grid: {
                        display: false,
                        drawBorder: false
                    }
                }
            }
        }
    });

    // ===========================
    // 3. PAYMENT STATUS DOUGHNUT CHART
    // ===========================
    const paymentCtx = document.getElementById('paymentChart').getContext('2d');

    new Chart(paymentCtx, {
        type: 'doughnut',
        data: {
            labels: ['Paid Bills', 'Pending Bills'],
            datasets: [{
                data: [{{ paid_bills|default:"0" }}, {{ pending_bills|default:"0" }}],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(245, 158, 11, 0.8)'
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(245, 158, 11, 1)'
                ],
                borderWidth: 3,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: { size: 13, weight: '700' },
                        color: '#374151',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    padding: 14,
                    titleFont: { size: 14, weight: '700' },
                    bodyFont: { size: 13, weight: '600' },
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            cutout: '70%'
        }
    });

    // ===========================
    // 4. COUNTER ANIMATION FOR METRICS
    // ===========================
    function animateValue(element, start, end, duration) {
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;

        const timer = setInterval(() => {
            current += increment;
            if (current >= end) {
                element.textContent = end;
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(current);
            }
        }, 16);
    }

    // Animate metric values on page load
    document.querySelectorAll('.metric-value').forEach((el, index) => {
        const finalValue = parseInt(el.textContent) || 0;
        el.textContent = '0';
        setTimeout(() => {
            animateValue(el, 0, finalValue, 1200);
        }, 150 + (index * 150));
    });

    // Calculate and display total revenue
    const revenueTotal = revenueData.reduce((sum, value) => sum + value, 0);
    const totalRevenueElement = document.getElementById('totalRevenue');
    if (totalRevenueElement) {
        totalRevenueElement.textContent = 'â‚±' + revenueTotal.toLocaleString('en-PH', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
});

// ===========================
// 5. GENERATE PRINTABLE REPORT
// ===========================
function generateReport() {
    const month = document.getElementById('reportMonth').value;
    const year = document.getElementById('reportYear').value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('opacity-70', 'cursor-not-allowed');
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Generating...';

    // Show SweetAlert loading
    Swal.fire({
        title: 'Generating Report',
        html: `<div class="text-sm">Creating <strong>${monthNames[month]} ${year}</strong> delinquency report...</div>`,
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    setTimeout(() => {
        // Open printable report in new window
        const reportUrl = `/delinquent-report/print/?month=${month}&year=${year}`;
        window.open(reportUrl, '_blank');

        // Show success message
        Swal.fire({
            icon: 'success',
            title: 'Report Generated!',
            html: `<div class="text-sm"><strong>${monthNames[month]} ${year}</strong> report is ready to print</div>`,
            timer: 2500,
            showConfirmButton: false
        });

        // Reset button
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
        btn.innerHTML = originalText;
    }, 1000);
}
</script>
{% endblock %}
