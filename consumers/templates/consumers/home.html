{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Dashboard - Balilihan Waterworks{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
        <h2 class="text-2xl font-bold text-dark-900">Dashboard</h2>
        <p class="text-dark-500 text-sm mt-1">Overview of system metrics and recent activity</p>
    </div>

    <!-- Quick Stats - 3-Column Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

        <!-- Connected Consumers -->
        <div class="bg-white rounded-lg border border-light-300 shadow-sm p-4 border-l-4 border-l-success-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="bi bi-check-circle-fill text-success-600 text-xl"></i>
                    <h3 class="text-xs font-semibold text-dark-600 uppercase tracking-wide">Connected</h3>
                </div>
            </div>
            <div class="flex items-baseline justify-between">
                <span class="text-3xl font-bold text-dark-900 metric-value">{{ connected_count|default:"0" }}</span>
                <a href="{% url 'consumers:connected_consumers' %}"
                   class="text-xs text-success-600 hover:text-success-700 font-medium transition-colors">
                    View →
                </a>
            </div>
        </div>

        <!-- Disconnected Consumers -->
        <div class="bg-white rounded-lg border border-light-300 shadow-sm p-4 border-l-4 border-l-danger-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="bi bi-x-circle-fill text-danger-600 text-xl"></i>
                    <h3 class="text-xs font-semibold text-dark-600 uppercase tracking-wide">Disconnected</h3>
                </div>
            </div>
            <div class="flex items-baseline justify-between">
                <span class="text-3xl font-bold text-dark-900 metric-value">{{ disconnected_count|default:"0" }}</span>
                <a href="{% url 'consumers:disconnected_consumers' %}"
                   class="text-xs text-danger-600 hover:text-danger-700 font-medium transition-colors">
                    View →
                </a>
            </div>
        </div>

        <!-- Delinquent Accounts -->
        <div class="bg-white rounded-lg border border-light-300 shadow-sm p-4 border-l-4 border-l-warning-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="bi bi-exclamation-triangle-fill text-warning-600 text-xl"></i>
                    <h3 class="text-xs font-semibold text-dark-600 uppercase tracking-wide">Delinquent</h3>
                </div>
            </div>
            <div class="flex items-baseline justify-between">
                <span class="text-3xl font-bold text-dark-900 metric-value">{{ delinquent_count|default:"0" }}</span>
                <a href="{% url 'consumers:delinquent_consumers' %}"
                   class="text-xs text-warning-600 hover:text-warning-700 font-medium transition-colors">
                    View →
                </a>
            </div>
        </div>
    </div>

    <!-- Report Generation & Chart - 2 Column Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

        <!-- Report Generation Card -->
        <div class="bg-white rounded-lg border border-light-300 shadow-sm p-6">
            <h3 class="text-lg font-bold text-dark-900 mb-4 pb-3 border-b border-light-200 flex items-center gap-2">
                <i class="bi bi-file-earmark-spreadsheet text-primary-600"></i>
                Generate Report
            </h3>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="reportMonth" class="block text-xs font-medium text-dark-700 mb-1">Month</label>
                    <select id="reportMonth" name="month" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div>
                    <label for="reportYear" class="block text-xs font-medium text-dark-700 mb-1">Year</label>
                    <select id="reportYear" name="year" class="w-full px-3 py-2 text-sm border border-light-300 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
            </div>

            <button type="button"
                    class="w-full px-4 py-2.5 bg-primary-600 text-white text-sm font-medium rounded hover:bg-primary-700 transition-colors shadow-sm flex items-center justify-center gap-2"
                    onclick="generateReport()">
                <i class="bi bi-printer"></i>
                Generate Printable Report
            </button>
        </div>

        <!-- Payment Status Chart -->
        <div class="bg-white rounded-lg border border-light-300 shadow-sm p-6">
            <h3 class="text-lg font-bold text-dark-900 mb-4 pb-3 border-b border-light-200 flex items-center gap-2">
                <i class="bi bi-pie-chart-fill text-primary-600"></i>
                Payment Status
            </h3>
            <div class="relative h-64 flex items-center justify-center">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Collections -->
    <div class="bg-white rounded-lg border border-light-300 shadow-sm p-6">
        <h3 class="text-lg font-bold text-dark-900 mb-4 pb-3 border-b border-light-200 flex items-center gap-2">
            <i class="bi bi-cash-coin text-success-600"></i>
            Recent Collections
        </h3>

        {% if recent_collections %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-light-50 border-b border-light-200">
                    <tr>
                        <th class="px-4 py-2.5 text-left text-xs font-semibold text-dark-700">Date</th>
                        <th class="px-4 py-2.5 text-right text-xs font-semibold text-dark-700">Amount Collected</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-light-200">
                    {% for collection in recent_collections %}
                    <tr class="hover:bg-light-50">
                        <td class="px-4 py-2.5 text-dark-900">
                            <i class="bi bi-calendar-check text-primary-600 mr-2"></i>
                            {{ collection.date|date:"M d, Y" }}
                        </td>
                        <td class="px-4 py-2.5 text-right font-semibold text-success-600">
                            ₱{{ collection.amount|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-dark-400">
            <i class="bi bi-inbox text-4xl block mb-2 opacity-30"></i>
            <p class="text-sm font-medium">No recent collections</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current month and year
    const now = new Date();
    document.getElementById('reportMonth').value = now.getMonth() + 1;
    document.getElementById('reportYear').value = now.getFullYear();

    // Payment Status Chart - Modern Doughnut Chart
    const ctx = document.getElementById('paymentChart').getContext('2d');

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Paid Bills', 'Pending Bills'],
            datasets: [{
                data: [{{ paid_bills|default:"0" }}, {{ pending_bills|default:"0" }}],
                backgroundColor: ['#10b981', '#f59e0b'],
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12, weight: '600' },
                        color: '#374151',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: '600' },
                    bodyFont: { size: 12 },
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' bills';
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });

    // Counter animation for metrics
    function animateValue(element, start, end, duration) {
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;

        const timer = setInterval(() => {
            current += increment;
            if (current >= end) {
                element.textContent = end;
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(current);
            }
        }, 16);
    }

    // Animate metric values on page load
    document.querySelectorAll('.metric-value').forEach((el, index) => {
        const finalValue = parseInt(el.textContent) || 0;
        el.textContent = '0';
        setTimeout(() => {
            animateValue(el, 0, finalValue, 1000);
        }, 100 + (index * 100));
    });
});

// Generate Printable Report Function
function generateReport() {
    const month = document.getElementById('reportMonth').value;
    const year = document.getElementById('reportYear').value;
    const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('opacity-70', 'cursor-not-allowed');
    btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Generating...';

    // Show SweetAlert loading
    Swal.fire({
        title: 'Generating Report',
        html: `Creating ${monthNames[month]} ${year} delinquency report...`,
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    setTimeout(() => {
        // Open printable report in new window
        const reportUrl = `/delinquent-report/print/?month=${month}&year=${year}`;
        window.open(reportUrl, '_blank');

        // Show success message
        Swal.fire({
            icon: 'success',
            title: 'Report Generated!',
            text: `${monthNames[month]} ${year} report is ready to print`,
            timer: 2000,
            showConfirmButton: false
        });

        // Reset button
        btn.disabled = false;
        btn.classList.remove('opacity-70', 'cursor-not-allowed');
        btn.innerHTML = originalText;
    }, 1000);
}
</script>
{% endblock %}
