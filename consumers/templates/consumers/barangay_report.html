{% extends "consumers/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Barangay Report - {{ barangay.name }}{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto" id="reportPage">

    <!-- Page Header (screen only) -->
    <div class="mb-4 no-print">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-dark-900 flex items-center gap-2">
                    <i class="bi bi-journal-text text-primary-600"></i>
                    Barangay Ledger Report
                </h2>
                <p class="text-sm text-gray-500 mt-1">{{ barangay.name }} &mdash; {{ consumer_count }} consumer{{ consumer_count|pluralize }}</p>
            </div>
            <a href="{% url 'consumers:reports' %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold rounded transition-all flex items-center gap-2">
                <i class="bi bi-arrow-left"></i> Back to Reports
            </a>
        </div>
    </div>

    <!-- Controls Bar (screen only) -->
    <div class="bg-white rounded-lg shadow-md mb-4 p-4 no-print">
        <div class="flex flex-wrap items-end gap-3">
            <div style="width: 140px;">
                <label for="yearSelect" class="block text-xs font-semibold text-gray-700 mb-1">Year</label>
                <select id="yearSelect" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-primary-500 focus:border-primary-500" onchange="changeYear(this.value)">
                    {% for y in year_choices %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end gap-2">
                <button type="button" onclick="toggleAll(true)" class="px-4 py-2 bg-primary-100 hover:bg-primary-200 text-primary-700 text-sm font-semibold rounded transition-all">
                    <i class="bi bi-check-all"></i> Select All
                </button>
                <button type="button" onclick="toggleAll(false)" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-semibold rounded transition-all">
                    <i class="bi bi-x-lg"></i> Deselect All
                </button>
            </div>
            <div class="flex items-end gap-2 ml-auto">
                <button type="button" onclick="printSelected()" class="px-5 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-semibold rounded transition-all flex items-center gap-2">
                    <i class="bi bi-printer"></i> Print Selected
                </button>
                <button type="button" onclick="printAll()" class="px-5 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded transition-all flex items-center gap-2">
                    <i class="bi bi-printer-fill"></i> Print All
                </button>
            </div>
        </div>
    </div>

    {% if consumer_ledger %}
    <div id="ledgerContainer">
        {% for entry in consumer_ledger %}
        <div class="consumer-card bg-white rounded-lg shadow-md mb-4 overflow-hidden" data-consumer-id="{{ entry.consumer.id }}">
            <!-- Checkbox bar (screen only) -->
            <div class="no-print flex items-center gap-3 px-4 py-3 bg-gray-50 border-b border-gray-200">
                <input type="checkbox" class="consumer-checkbox w-4 h-4 text-primary-600 rounded" data-consumer-id="{{ entry.consumer.id }}" checked>
                <div class="flex-1">
                    <span class="font-bold text-gray-900">{{ entry.consumer.last_name }}, {{ entry.consumer.first_name }}{% if entry.consumer.middle_name %} {{ entry.consumer.middle_name }}{% endif %}{% if entry.consumer.suffix %} {{ entry.consumer.suffix }}{% endif %}</span>
                    <span class="text-xs text-gray-500 ml-3">ID: {{ entry.consumer.id_number|default:"N/A" }}</span>
                </div>
            </div>

            <!-- Ledger content -->
            <div class="ledger-block p-4">
                <div class="consumer-info">
                    <div class="info-row">
                        <span><b>Name:</b> {{ entry.consumer.last_name }}, {{ entry.consumer.first_name }}{% if entry.consumer.middle_name %} {{ entry.consumer.middle_name }}{% endif %}</span>
                        <span><b>Service No:</b> {{ entry.consumer.id_number|default:"" }}</span>
                    </div>
                    <div class="info-row">
                        <span><b>Address:</b> {% if entry.consumer.purok %}{{ entry.consumer.purok.name }}, {% endif %}{{ entry.consumer.barangay.name }}</span>
                    </div>
                </div>

                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th class="col-month">Month and Year<br><span class="year-label">{{ year }}</span></th>
                            <th class="col-reading">Reading</th>
                            <th class="col-cum">Cu.m.</th>
                            <th class="col-due">Amount Due</th>
                            <th class="col-penalty">Penalty</th>
                            <th class="col-paid">Amount Paid</th>
                            <th class="col-receipt">Receipt Number</th>
                            <th class="col-date">Date Issued</th>
                            <th class="col-initial">Initial</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for month in entry.months %}
                        <tr{% if month.amount_paid %} class="paid-row"{% endif %}>
                            <td class="month-cell">{{ month.month }}</td>
                            <td class="center-cell">{{ month.reading }}</td>
                            <td class="center-cell">{{ month.consumption }}</td>
                            <td class="right-cell">{% if month.amount_due %}{{ month.amount_due|floatformat:2 }}{% endif %}</td>
                            <td class="right-cell">{% if month.penalty %}{{ month.penalty|floatformat:2 }}{% endif %}</td>
                            <td class="right-cell bold-cell">{% if month.amount_paid %}{{ month.amount_paid|floatformat:2 }}{% endif %}</td>
                            <td class="center-cell small-cell">{% if month.receipt_number %}{{ month.receipt_number }}{% endif %}</td>
                            <td class="center-cell">{% if month.date_issued %}{{ month.date_issued|date:"m/d/Y" }}{% endif %}</td>
                            <td class="center-cell">{{ month.initial }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="flex flex-col items-center justify-center py-16">
            <i class="bi bi-people text-6xl text-gray-300 mb-4"></i>
            <h4 class="text-xl font-bold text-gray-600 mb-2">No Active Consumers</h4>
            <p class="text-sm text-gray-500">There are no active consumers in {{ barangay.name }}.</p>
        </div>
    </div>
    {% endif %}

</div>

<style>
/* ===== SCREEN STYLES ===== */
.consumer-info {
    margin-bottom: 8px;
}
.consumer-info .info-row {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #374151;
    margin-bottom: 2px;
}
.consumer-info .info-row b {
    color: #6b7280;
}

.ledger-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}
.ledger-table th, .ledger-table td {
    border: 1px solid #9ca3af;
    padding: 4px 6px;
}
.ledger-table th {
    background: #f3f4f6;
    font-weight: 700;
    text-align: center;
    font-size: 11px;
}
.ledger-table th.col-month { text-align: left; width: 110px; }
.ledger-table th.col-reading { width: 60px; }
.ledger-table th.col-cum { width: 45px; }
.ledger-table th.col-due { width: 70px; }
.ledger-table th.col-penalty { width: 55px; }
.ledger-table th.col-paid { width: 70px; }
.ledger-table th.col-receipt { width: 90px; }
.ledger-table th.col-date { width: 70px; }
.ledger-table th.col-initial { width: 45px; }

.year-label { color: #4338ca; font-weight: 700; }
.month-cell { font-weight: 600; color: #1f2937; }
.center-cell { text-align: center; }
.right-cell { text-align: right; }
.bold-cell { font-weight: 600; }
.small-cell { font-size: 10px; }
.paid-row { background: #f0fdf4; }

/* ===== PRINT STYLES ===== */
@media print {
    /* Hide everything that's not the report */
    .no-print,
    .sidebar, #sidebar,
    .header-bar,
    nav, header, footer, aside {
        display: none !important;
    }

    /* Reset everything */
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /*
     * @page margin: 0 removes browser header/footer (date, URL, title).
     * Content padding is handled on #ledgerContainer instead.
     */
    @page {
        size: 8.5in 5.5in;
        margin: 0;
    }

    /* Full width content */
    .main-content, #main-content, .max-w-7xl, #reportPage {
        margin: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
    }

    /* Content padding (replaces @page margin so content doesn't bleed) */
    #ledgerContainer {
        margin: 0;
        padding: 4mm 6mm;
    }

    /* Hide non-selected */
    .consumer-card.print-hidden {
        display: none !important;
    }

    /* Consumer card - no decoration */
    .consumer-card {
        box-shadow: none !important;
        border: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: visible !important;
        page-break-inside: avoid !important;
    }

    /* Ledger block spacing */
    .ledger-block {
        padding: 1mm 0 !important;
    }

    /* Consumer info - compact */
    .consumer-info {
        margin-bottom: 1mm !important;
    }
    .consumer-info .info-row {
        font-size: 7.5pt !important;
        margin-bottom: 0 !important;
        line-height: 1.4 !important;
    }

    /* Table - compact to fit 2 per page */
    .ledger-table {
        font-size: 7.5pt !important;
        width: 100% !important;
        table-layout: fixed !important;
    }

    .ledger-table th {
        background: #d4d4d4 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        font-size: 6.5pt !important;
        padding: 1px 2px !important;
        font-weight: 700 !important;
        line-height: 1.2 !important;
        border: 1px solid #000 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
    }

    /* Column widths for print (fixed layout) */
    .ledger-table .col-month { width: 14% !important; }
    .ledger-table .col-reading { width: 9% !important; }
    .ledger-table .col-cum { width: 7% !important; }
    .ledger-table .col-due { width: 11% !important; }
    .ledger-table .col-penalty { width: 9% !important; }
    .ledger-table .col-paid { width: 11% !important; }
    .ledger-table .col-receipt { width: 20% !important; }
    .ledger-table .col-date { width: 12% !important; }
    .ledger-table .col-initial { width: 7% !important; }

    .ledger-table td {
        padding: 1px 2px !important;
        font-size: 7pt !important;
        line-height: 1.2 !important;
        border: 1px solid #000 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }

    .paid-row {
        background: #e8f5e9 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* PAGE BREAKS: every 2 consumers */
    .consumer-card.page-break-before {
        page-break-before: always !important;
    }

    /* Separator between 2 consumers on same page */
    .consumer-card + .consumer-card:not(.page-break-before):not(.print-hidden) {
        border-top: 1px dashed #666 !important;
        margin-top: 3mm !important;
        padding-top: 1mm !important;
    }

    /* Kill shadows/radius */
    * {
        box-shadow: none !important;
        border-radius: 0 !important;
    }
}

/* Transitions */
button, a, input, select {
    transition: all 0.2s ease-in-out;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function changeYear(year) {
    const url = new URL(window.location.href);
    url.searchParams.set('year', year);
    window.location.href = url.toString();
}

function toggleAll(checked) {
    document.querySelectorAll('.consumer-checkbox').forEach(cb => {
        cb.checked = checked;
    });
}

function printSelected() {
    document.querySelectorAll('.consumer-card').forEach(card => {
        const cb = card.querySelector('.consumer-checkbox');
        if (cb && !cb.checked) {
            card.classList.add('print-hidden');
        } else {
            card.classList.remove('print-hidden');
        }
    });
    addPageBreaks();
    doPrint();
}

function printAll() {
    document.querySelectorAll('.consumer-card').forEach(card => {
        card.classList.remove('print-hidden');
    });
    addPageBreaks();
    doPrint();
}

function doPrint() {
    // Blank the title to remove browser header text
    var origTitle = document.title;
    document.title = ' ';
    window.print();
    setTimeout(function() {
        document.title = origTitle;
        document.querySelectorAll('.consumer-card').forEach(card => {
            card.classList.remove('print-hidden');
            card.classList.remove('page-break-before');
        });
    }, 500);
}

function addPageBreaks() {
    // 2 consumers per page
    const visibleCards = document.querySelectorAll('.consumer-card:not(.print-hidden)');
    visibleCards.forEach((card, index) => {
        card.classList.remove('page-break-before');
        if (index > 0 && index % 2 === 0) {
            card.classList.add('page-break-before');
        }
    });
}
</script>
{% endblock %}
