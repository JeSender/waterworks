<!-- consumers/templates/consumers/add_consumer.html -->
{% extends "consumers/base.html" %}

{% block title %}Add Consumer{% endblock %}

{% block main_content %}
<div class="container">
    <h2 class="mb-4">Add New Consumer</h2>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show">
                    <strong>Please correct the following errors:</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <ul class="mb-0 mt-2">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.first_name.label_tag }}
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="text-danger small mt-1">{{ form.first_name.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.middle_name.label_tag }}
                            {{ form.middle_name }}
                        </div>
                        <div class="mb-3">
                            {{ form.last_name.label_tag }}
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="text-danger small mt-1">{{ form.last_name.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.birth_date.label_tag }}
                            {{ form.birth_date }}
                            {% if form.birth_date.errors %}
                                <div class="text-danger small mt-1">{{ form.birth_date.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.gender.label_tag }}
                            {{ form.gender }}
                            {% if form.gender.errors %}
                                <div class="text-danger small mt-1">{{ form.gender.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.phone_number.label_tag }}
                            {{ form.phone_number }}
                            {% if form.phone_number.errors %}
                                <div class="text-danger small mt-1">{{ form.phone_number.errors|first }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.civil_status.label_tag }}
                            {{ form.civil_status }}
                            {% if form.civil_status.errors %}
                                <div class="text-danger small mt-1">{{ form.civil_status.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.spouse_name.label_tag }}
                            {{ form.spouse_name }}
                        </div>
                        <div class="mb-3">
                            {{ form.barangay.label_tag }}
                            {{ form.barangay }}
                            {% if form.barangay.errors %}
                                <div class="text-danger small mt-1">{{ form.barangay.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.purok.label_tag }}
                            {{ form.purok }}
                            {% if form.purok.errors %}
                                <div class="text-danger small mt-1">{{ form.purok.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.household_number.label_tag }}
                            {{ form.household_number }}
                            {% if form.household_number.errors %}
                                <div class="text-danger small mt-1">{{ form.household_number.errors|first }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.usage_type.label_tag }}
                            {{ form.usage_type }}
                            {% if form.usage_type.errors %}
                                <div class="text-danger small mt-1">{{ form.usage_type.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.meter_brand.label_tag }}
                            {{ form.meter_brand }}
                            {% if form.meter_brand.errors %}
                                <div class="text-danger small mt-1">{{ form.meter_brand.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.serial_number.label_tag }}
                            {{ form.serial_number }}
                            {% if form.serial_number.errors %}
                                <div class="text-danger small mt-1">{{ form.serial_number.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.first_reading.label_tag }}
                            {{ form.first_reading }}
                            {% if form.first_reading.errors %}
                                <div class="text-danger small mt-1">{{ form.first_reading.errors|first }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.registration_date.label_tag }}
                            {{ form.registration_date }}
                            {% if form.registration_date.errors %}
                                <div class="text-danger small mt-1">{{ form.registration_date.errors|first }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check2-circle"></i> Submit
                    </button>
                    <a href="{% url 'consumers:consumer_management' %}" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Same JS for dependent dropdown -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const barangaySelect = document.getElementById('id_barangay');
    const purokSelect = document.getElementById('id_purok');

    barangaySelect.addEventListener('change', function() {
        const barangayId = this.value;

        fetch(`/ajax/load-puroks/?barangay_id=${barangayId}`)
            .then(response => response.json())
            .then(data => {
                purokSelect.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.textContent = 'Select Purok';
                placeholder.value = '';
                purokSelect.appendChild(placeholder);

                data.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    purokSelect.appendChild(option);
                });

                // Keep old value if editing
                if (purokSelect.dataset.selected) {
                    purokSelect.value = purokSelect.dataset.selected;
                }
            });
    });

    // Trigger change once so purok loads when editing
    if (barangaySelect.value) {
        barangaySelect.dispatchEvent(new Event('change'));
    }
});
</script>

{% endblock %}
