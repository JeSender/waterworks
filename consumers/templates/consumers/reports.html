<!-- consumers/templates/consumers/reports.html -->
{% extends "consumers/base.html" %}
{% load humanize %}

{% block title %}System Reports{% endblock %}

{% block extra_css %}
<style>
    /* Screen-only styles */
    .screen-only {
        display: block;
    }

    /* Hide elements on print */
    @media print {
        .no-print, .btn, .form-control, nav, footer, .filter-section, .report-header.screen-only {
            display: none !important;
        }

        /* Full-width report container for print */
        .report-container {
            width: 100% !important;
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Print-friendly table */
        table {
            width: 100% !important;
            font-size: 12px !important;
            border-collapse: collapse !important;
        }
        th, td {
            padding: 8px !important;
            border: 1px solid #000 !important;
        }
        th {
            background-color: #f0f0f0 !important;
            color: #000 !important;
        }

        /* Report header for print */
        .report-header.print {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .report-header.print h1 {
            font-size: 20px !important;
            margin: 0 !important;
        }
        .report-header.print .subtitle {
            font-size: 14px !important;
            color: #333 !important;
        }

        /* Summary cards for print */
        .summary-cards {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 15px !important;
            page-break-inside: avoid;
        }
        .summary-card {
            text-align: center !important;
            border: 1px solid #000 !important;
            padding: 8px !important;
            font-size: 12px !important;
        }

        /* Prevent table splits */
        tbody {
            page-break-inside: avoid;
        }

        /* Ensure the report content is visible */
        body {
            padding: 0 !important;
            margin: 0 !important;
            background: white !important;
        }
    }

    /* Style for the printable report section */
    .printable-report {
        background: white;
        padding: 20px;
        box-shadow: none;
        border: none;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-6">

    <!-- Screen-only header -->
    <div class="report-header screen-only mb-8">
        <h1 class="text-3xl font-bold text-gray-800">üìä System Reports</h1>
        <p class="mt-1 text-sm text-gray-500">Generate operational and financial reports for Balilihan Waterworks.</p>
    </div>

    <!-- Report selection cards (screen only) -->
    <div class="filter-section screen-only mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Revenue Report -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500 mr-2">
                        <path d="M12 2v20"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <h2 class="text-xl font-semibold text-gray-700">Monthly Revenue Report</h2>
                </div>
                <p class="text-sm text-gray-500 mb-4">Track billed amounts, payments, and outstanding balances.</p>
                <form action="{% url 'consumers:reports' %}" method="GET">
                    <input type="hidden" name="report_type" value="revenue">
                    <div class="mb-4">
                        <label for="revenue_month" class="block text-sm font-medium text-gray-600">Select Month & Year</label>
                        <input type="month" id="revenue_month" name="month_year" required
                               value="{{ filters.month_year }}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">
                        üìä Generate Revenue Report
                    </button>
                </form>
            </div>

            <!-- Delinquency Report -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 mr-2">
                        <path d="M12 2v20"/><path d="M12 7h.01"/><path d="M12 12h.01"/><path d="M12 17h.01"/>
                    </svg>
                    <h2 class="text-xl font-semibold text-gray-700">Delinquent Accounts Report</h2>
                </div>
                <p class="text-sm text-gray-500 mb-4">Identify consumers with unpaid/overdue bills.</p>
                <form action="{% url 'consumers:reports' %}" method="GET">
                    <input type="hidden" name="report_type" value="delinquent">
                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">
                        ‚ö†Ô∏è Generate Delinquency Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Report results -->
    {% if report_data %}
    <div class="report-results">
        <!-- Printable report section -->
        <div class="printable-report" id="printable-content">
            <!-- Report header for print -->
            <div class="report-header print">
                <h1>{{ report_title }}</h1>
                <p class="subtitle">Generated on: {{ "now"|date:"F d, Y" }}</p>
            </div>

            <!-- Revenue Report -->
            {% if report_type == 'revenue' %}
            <div class="summary-cards">
                <div class="summary-card">
                    <p>Total Billed</p>
                    <p>‚Ç±{{ report_data.summary.total_billed|intcomma }}</p>
                </div>
                <div class="summary-card">
                    <p>Total Paid</p>
                    <p>‚Ç±{{ report_data.summary.total_paid|intcomma }}</p>
                </div>
                <div class="summary-card">
                    <p>Total Outstanding</p>
                    <p>‚Ç±{{ report_data.summary.total_outstanding|intcomma }}</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Consumer</th>
                        <th>Bill Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in report_data.bills %}
                    <tr>
                        <td>{{ bill.consumer.first_name }} {{ bill.consumer.last_name }}</td>
                        <td>{{ bill.billing_period|date:"F d, Y" }}</td>
                        <td>‚Ç±{{ bill.total_amount|intcomma }}</td>
                        <td>{{ bill.status }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4">No billing data found for the selected period.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Delinquency Report -->
            {% if report_type == 'delinquent' %}
            <table>
                <thead>
                    <tr>
                        <th>Consumer</th>
                        <th>Phone</th>
                        <th>Unpaid Bills</th>
                        <th>Total Due</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in report_data %}
                    <tr>
                        <td>{{ item.consumer.first_name }} {{ item.consumer.last_name }}</td>
                        <td>{{ item.consumer.phone_number|default:"‚Äî" }}</td>
                        <td>{{ item.unpaid_count }}</td>
                        <td>‚Ç±{{ item.total_due|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4">No delinquent accounts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>

        <!-- Print button (screen only) -->
        <div class="no-print mt-6 text-center">
            <button onclick="printReport()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">
                üñ®Ô∏è Print Report
            </button>
        </div>
    </div>
    {% endif %}

</div>

<!-- JavaScript for printing -->
<script>
function printReport() {
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    
    // Write the printable content to the new window
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${document.title}</title>
            <style>
                /* Print styles for the new window */
                body {
                    padding: 20px;
                    margin: 0;
                    font-family: Arial, sans-serif;
                    background: white;
                }
                table {
                    width: 100%;
                    font-size: 12px;
                    border-collapse: collapse;
                }
                th, td {
                    padding: 8px;
                    border: 1px solid #000;
                }
                th {
                    background-color: #f0f0f0;
                    color: #000;
                }
                .report-header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #000;
                    padding-bottom: 10px;
                }
                .report-header h1 {
                    font-size: 20px;
                    margin: 0;
                }
                .report-header .subtitle {
                    font-size: 14px;
                    color: #333;
                }
                .summary-cards {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    page-break-inside: avoid;
                }
                .summary-card {
                    text-align: center;
                    border: 1px solid #000;
                    padding: 8px;
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            ${document.getElementById('printable-content').outerHTML}
        </body>
        </html>
    `);
    
    // Wait for the new window to load, then trigger the print dialog
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}
</script>
{% endblock %}